<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="UTF-8" />
  <link rel="icon" href="/static/images/favicon.ico" />
  <link rel="stylesheet" type="text/css" href="/static/css/login.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Philosopher&display=swap" rel="stylesheet" />

  <title></title>
</head>

<body>
  <!-- Html -->
  <div id="app" class="placeholder">
    <div id="settings" class="settings">
      <div class="top_left_group">
        <div class="user_profile_edit_menu">
          <div>
            <?xml version="1.0" encoding="UTF-8"?><svg width="24px" height="24px" stroke-width="1.5" viewBox="0 0 24 24"
              fill="none" xmlns="http://www.w3.org/2000/svg" color="#000000">
              <path d="M3 5H21" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              </path>
              <path d="M3 12H21" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              </path>
              <path d="M3 19H21" stroke="#000000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              </path>
            </svg>
          </div>
          <div class="user_profile_drop_menu">
            <div class="profile_submenu" data-endpoint="editprofile">
              ${currentLanguage.Edit_Profile}
            </div>
            <div class="profile_submenu" data-endpoint="createchar">
              ${currentLanguage.Create_Character}
            </div>
          </div>
        </div>
        <div class="UI_flex_row">
          <div>
            <svg width="15px" height="15px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
              stroke="">
              <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
              <g id="SVGRepo_iconCarrier">
                <path
                  d="M13.75 2C13.75 1.58579 13.4142 1.25 13 1.25C12.5858 1.25 12.25 1.58579 12.25 2V14.5359C11.4003 13.7384 10.2572 13.25 9 13.25C6.37665 13.25 4.25 15.3766 4.25 18C4.25 20.6234 6.37665 22.75 9 22.75C11.6234 22.75 13.75 20.6234 13.75 18V6.243C14.9875 7.77225 16.8795 8.75 19 8.75C19.4142 8.75 19.75 8.41421 19.75 8C19.75 7.58579 19.4142 7.25 19 7.25C16.1005 7.25 13.75 4.8995 13.75 2Z"
                  fill="#ffffff"></path>
              </g>
            </svg>
          </div>
          <div id="knob"></div>
        </div>
        <div class="UI_flex_row">
          <div>
            <svg width="17px" height="17px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
              stroke="">
              <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
              <g id="SVGRepo_iconCarrier">
                <path
                  d="M15 15.5C14.7164 14.3589 13.481 13.5 12 13.5C10.519 13.5 9.28364 14.3589 9 15.5M12 9.5H12.01M13 9.5C13 10.0523 12.5523 10.5 12 10.5C11.4477 10.5 11 10.0523 11 9.5C11 8.94772 11.4477 8.5 12 8.5C12.5523 8.5 13 8.94772 13 9.5ZM7 21H17C18.1046 21 19 20.1046 19 19V5C19 3.89543 18.1046 3 17 3H7C5.89543 3 5 3.89543 5 5V19C5 20.1046 5.89543 21 7 21Z"
                  stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
              </g>
            </svg>
          </div>
          <div id="live_char_switch"></div>
        </div>
        <div class="UI_flex_row">
          <div id="language_switch"></div>
        </div>
      </div>
      <div id="btn_signup" class="top_buttons" v-text="currentLanguage.Sign_up"></div>
      <div id="btn_login" class="top_buttons" v-text="currentLanguage.Login"></div>
      <div class="user_profile">
        <div class="profile_avatar"></div>
        <div class="username">Username</div>
        <div class="credits">
          ${currentLanguage.Credits}<span>100</span><svg id="btn_logout" width="24px" height="24px" stroke-width="1.5"
            viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#000000">
            <path d="M12 12H19M19 12L16 15M19 12L16 9" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round"></path>
            <path
              d="M19 6V5C19 3.89543 18.1046 3 17 3H7C5.89543 3 5 3.89543 5 5V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V18"
              stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </div>
      </div>
    </div>
    <div class="headline" v-text="currentLanguage.siteName"></div>
    <div id="logindiv">
      <div class="subtitle">
        <span v-text="currentLanguage.Choose_Charactor"></span><span class="chatbtn"
          id="btn_start_chat">${currentLanguage.Start_Chatting}
          <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
            color="#280149" stroke-width="1.5">
            <path id="icon_start_chat" fill-rule="evenodd" clip-rule="evenodd"
              d="M12 1.25C6.06294 1.25 1.25 6.06294 1.25 12C1.25 13.8563 1.72113 15.6046 2.55076 17.1298L1.76267 21.3627C1.71742 21.6058 1.79485 21.8555 1.96967 22.0303C2.14448 22.2051 2.39422 22.2826 2.63727 22.2373L6.87016 21.4493C8.39536 22.2788 10.1437 22.75 12 22.75C17.937 22.75 22.75 17.937 22.75 12C22.75 6.06293 17.937 1.25 12 1.25ZM17 10.75C16.3097 10.75 15.75 11.3097 15.75 12C15.75 12.6903 16.3097 13.25 17 13.25C17.6903 13.25 18.25 12.6903 18.25 12C18.25 11.3097 17.6903 10.75 17 10.75ZM10.75 12C10.75 11.3097 11.3097 10.75 12 10.75C12.6903 10.75 13.25 11.3097 13.25 12C13.25 12.6903 12.6903 13.25 12 13.25C11.3097 13.25 10.75 12.6903 10.75 12ZM7 10.75C6.30961 10.75 5.75 11.3097 5.75 12C5.75 12.6903 6.30961 13.25 7 13.25C7.69039 13.25 8.25 12.6903 8.25 12C8.25 11.3097 7.69039 10.75 7 10.75Z"
              fill="#280149"></path>
          </svg>
        </span>
      </div>
      <div class="rolelist">
        <div class="roleholder" v-for="role in aiRoleList_vue" :key="role.aiRoleId">
          <div class="avatarbk"
            :style="{ backgroundImage: `url('../static/images/avatar/${role.aiRoleId}/none.webp?nocache={{timestamp}}')` }"
            @click="selectRole($event, role)" @mouseover="hoverRole($event)" @mouseleave="hoverRole(null)">
            <div class="info_NSFW" v-if="role.Data.Match_words_cata=='NSFW'">
              <svg width="18px" height="18px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path class="NSFW_icon"
                  d="M4.8 1.40006C4.54174 1.05572 4.09211 0.915267 3.68377 1.05138C3.27543 1.1875 3 1.56963 3 2.00006V10.0001C3 10.5523 3.44772 11.0001 4 11.0001C4.55228 11.0001 5 10.5523 5 10.0001V5.00006L9.2 10.6001C9.45826 10.9444 9.90789 11.0849 10.3162 10.9487C10.7246 10.8126 11 10.4305 11 10.0001V2.00006C11 1.44778 10.5523 1.00006 10 1.00006C9.44772 1.00006 9 1.44778 9 2.00006V7.00006L4.8 1.40006Z" />
                <path class="NSFW_icon"
                  d="M15 1.00006C13.8954 1.00006 13 1.89549 13 3.00006V5.00006C13 6.10463 13.8954 7.00006 15 7.00006H19V9.00006H14C13.4477 9.00006 13 9.44778 13 10.0001C13 10.5523 13.4477 11.0001 14 11.0001H19C20.1046 11.0001 21 10.1046 21 9.00006V7.00006C21 5.89549 20.1046 5.00006 19 5.00006H15V3.00006H20C20.5523 3.00006 21 2.55235 21 2.00006C21 1.44778 20.5523 1.00006 20 1.00006H15Z" />
                <path class="NSFW_icon"
                  d="M3 14.0001C3 13.4478 3.44772 13.0001 4 13.0001H10C10.5523 13.0001 11 13.4478 11 14.0001C11 14.5524 10.5523 15.0001 10 15.0001H5V17.0001H10C10.5523 17.0001 11 17.4478 11 18.0001C11 18.5523 10.5523 19.0001 10 19.0001H5V22.0001C5 22.5523 4.55228 23.0001 4 23.0001C3.44772 23.0001 3 22.5523 3 22.0001V14.0001Z" />
                <path class="NSFW_icon"
                  d="M15 14.0001C15 13.4478 14.5523 13.0001 14 13.0001C13.4477 13.0001 13 13.4478 13 14.0001V22.0001C13 22.4495 13.2999 22.8438 13.7331 22.9638C14.1662 23.0838 14.6262 22.9 14.8575 22.5146L17 18.9437L19.1425 22.5146C19.3738 22.9 19.8338 23.0838 20.2669 22.9638C20.7001 22.8438 21 22.4495 21 22.0001V14.0001C21 13.4478 20.5523 13.0001 20 13.0001C19.4477 13.0001 19 13.4478 19 14.0001V18.3897L17.8575 16.4856C17.6768 16.1844 17.3513 16.0001 17 16.0001C16.6487 16.0001 16.3232 16.1844 16.1425 16.4856L15 18.3897V14.0001Z" />
              </svg>
            </div>
          </div>
          <div class="role_info_bar">
            <div class="ainame_span" v-text="role.Data.ai_name"></div>
            <div class="info_button" @click="showRoleInfo($event,role)">
              <svg width="25px" height="25px" viewBox="0 0 20 20" fill="#ffffff" xmlns="http://www.w3.org/2000/svg">
                <path class="svg_info" ill-rule="evenodd" clip-rule="evenodd"
                  d="M10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18ZM10 8.92857C9.44772 8.92857 9 9.37629 9 9.92857V13.9286C9 14.4809 9.44772 14.9286 10 14.9286C10.5523 14.9286 11 14.4809 11 13.9286V9.92857C11 9.37629 10.5523 8.92857 10 8.92857ZM10 7.5C10.5523 7.5 11 7.05228 11 6.5C11 5.94772 10.5523 5.5 10 5.5C9.44772 5.5 9 5.94772 9 6.5C9 7.05228 9.44772 7.5 10 7.5Z" />
              </svg>
            </div>
          </div>
          <!--<input type="radio" class="roleRadios" id="ainame" name="ai_role_name" value="rolename in list"
            data-uncensored="censoredmarker" data-story_name="storynamemarker" data-intro_text="introtextmarker" />-->
        </div>
      </div>
    </div>
    <div class="Main_footer">Muffin 2024</div>
    <div id="overlay" class="overlay">
      <div id="signup_form">
        <div class="top_bar">
          <label class="title">${currentLanguage.Sign_up}</label>
          <div id="btn_signup_form_close" class="btn_close">
            <svg width="24px" height="24px" viewBox="0 0 24 24" fill="#340768" xmlns="http://www.w3.org/2000/svg"
              color="#340768" stroke-width="1.5">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M3.6 2.25C2.85442 2.25 2.25 2.85441 2.25 3.6V20.4C2.25 21.1456 2.85441 21.75 3.6 21.75H20.4C21.1456 21.75 21.75 21.1456 21.75 20.4V3.6C21.75 2.85442 21.1456 2.25 20.4 2.25H3.6ZM10.409 9.34835C10.1161 9.05546 9.64121 9.05546 9.34831 9.34835C9.05542 9.64124 9.05542 10.1161 9.34831 10.409L10.9393 12L9.34831 13.591C9.05542 13.8839 9.05542 14.3588 9.34831 14.6517C9.64121 14.9445 10.1161 14.9445 10.409 14.6517L12 13.0607L13.591 14.6517C13.8838 14.9445 14.3587 14.9445 14.6516 14.6517C14.9445 14.3588 14.9445 13.8839 14.6516 13.591L13.0606 12L14.6516 10.409C14.9445 10.1161 14.9445 9.64124 14.6516 9.34835C14.3587 9.05546 13.8838 9.05546 13.591 9.34835L12 10.9393L10.409 9.34835Z"
                fill="#340768"></path>
            </svg>
          </div>
        </div>
        <div class="main_body">
          <div class="info_row">
            <div id="sign_profile">
              <div id="sign_author" class="form_hint">
                Authorization feedback
              </div>
              <label for="sign_username">${currentLanguage.Username}<span class="form_hint"></span></label>
              <input name="name" id="sign_username" autocomplete="name" />
              <label for="sign_nickname">${currentLanguage.Nickname}<span class="form_hint"></span></label>
              <input name="nickname" id="sign_nickname" data-optional="true" />
              <label for="sign_email">${currentLanguage.Email}<span class="form_hint"></span></label>
              <input type="email" name="email" id="sign_email" autocomplete="email" />
              <label for="sign_password">${currentLanguage.Password}<svg class="pwd_type" width="14px" height="14px"
                  viewBox="0 0 24 24" stroke-width="1.5" fill="none" xmlns="http://www.w3.org/2000/svg" color="#FFFFFF">
                  <path d="M19.5 16L17.0248 12.6038" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                  <path d="M12 17.5V14" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                  <path d="M4.5 16L6.96895 12.6124" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                  <path d="M3 8C6.6 16 17.4 16 21 8" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg><span class="form_hint"></span></label>
              <input type="password" id="sign_password" name="password" />
              <label for="sign_repassword">${currentLanguage.Retype_Password}<svg class="pwd_type" width="14px"
                  height="14px" viewBox="0 0 24 24" stroke-width="1.5" fill="none" xmlns="http://www.w3.org/2000/svg"
                  color="#FFFFFF">
                  <path d="M19.5 16L17.0248 12.6038" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                  <path d="M12 17.5V14" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                  <path d="M4.5 16L6.96895 12.6124" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                  <path d="M3 8C6.6 16 17.4 16 21 8" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                    stroke-linejoin="round"></path>
                </svg><span class="form_hint"></span></label>
              <input type="password" id="sign_repassword" name="repassword" />
              <div class="gender_bar">
                <label>${currentLanguage.Gender}</label>
                <input type="radio" id="sign_gender_male" name="sign_gender" value="male" checked />
                <label for="sign_gender_male">${currentLanguage.Male}</label>
                <input type="radio" id="sign_gender_female" name="sign_gender" value="female" />
                <label for="sign_gender_female">${currentLanguage.Female}</label>
              </div>
            </div>
            <div id="sign_charlooks">
              <span class="looks_title">${currentLanguage.Portrait_Looks}</span>
              <div class="avatar_preview">${currentLanguage.Preview}</div>
              <button type="button" class="submit_btn" id="btn_avatar_preview_signup">
                ${currentLanguage.Preview_avatar}
              </button>
              <label for="sign_char_race">${currentLanguage.Race}</label>
              <select id="sign_char_race">
                <option value="Asian">Asian</option>
                <option value="European">European</option>
                <option value="American">American</option>
                <option value="Latino">Latino</option>
                <option value="Indian">Indian</option>
              </select>
              <label for="sign_char_age">${currentLanguage.Age}</label>
              <select id="sign_char_age">
                <option value="Young adult">Young adult</option>
                <option value="Middle-aged">Middle-aged</option>
                <option value="Elderly">Elderly</option>
              </select>
              <label for="sign_char_hair_style">${currentLanguage.Hair_Style}</label>
              <select id="sign_char_hair_style">
                <option value="Neat Short hair" selected>
                  Neat Short hair
                </option>
                <option value="Neat Long hair">Neat Long hair</option>
                <option value="Curls Short hair">Curls Short hair</option>
                <option value="Curls Long hair">Curls Long hair</option>
                <option value="Ear-length hair">Ear-length hair</option>
                <option value="Buzz cut">Buzz cut</option>
                <option value="Bald">Bald</option>
              </select>
              <label for="sign_char_hair_color">${currentLanguage.Hair_Color}</label>
              <select id="sign_char_hair_color">
                <option value="Black">Black</option>
                <option value="Blond">Blond</option>
                <option value="Silver">Silver</option>
                <option value="Brown">Brown</option>
                <option value="Red">Red</option>
              </select>
              <label for="sign_char_eye_color">${currentLanguage.Eyes_Color}</label>
              <select id="sign_char_eye_color">
                <option value="Black Eyes">Black</option>
                <option value="Blue Eyes">Blue</option>
                <option value="Green Eyes">Green</option>
                <option value="Brown Eyes">Brown</option>
                <option value="Amber Eyes">Amber</option>
              </select>
              <label for="sign_char_beard">${currentLanguage.Beard_Type}</label>
              <select id="sign_char_beard">
                <option value>None</option>
                <option value="Big beard">Big beard</option>
                <option value="Sideburns">Sideburns</option>
                <option value="Goatee">Goatee</option>
                <option value="Small beard">Small beard</option>
                <option value="wizard beard">wizard beard</option>
              </select>
            </div>
          </div>
          <button type="button" class="submit_btn" id="btn_signup_submit">
            ${currentLanguage.Sign_up}
          </button>
        </div>
      </div>
      <div id="login_form">
        <div class="top_bar">
          <label class="title">${currentLanguage.Login}</label>
          <div id="btn_login_form_close" class="btn_close">
            <svg width="24px" height="24px" viewBox="0 0 24 24" fill="#340768" xmlns="http://www.w3.org/2000/svg"
              color="#340768" stroke-width="1.5">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M3.6 2.25C2.85442 2.25 2.25 2.85441 2.25 3.6V20.4C2.25 21.1456 2.85441 21.75 3.6 21.75H20.4C21.1456 21.75 21.75 21.1456 21.75 20.4V3.6C21.75 2.85442 21.1456 2.25 20.4 2.25H3.6ZM10.409 9.34835C10.1161 9.05546 9.64121 9.05546 9.34831 9.34835C9.05542 9.64124 9.05542 10.1161 9.34831 10.409L10.9393 12L9.34831 13.591C9.05542 13.8839 9.05542 14.3588 9.34831 14.6517C9.64121 14.9445 10.1161 14.9445 10.409 14.6517L12 13.0607L13.591 14.6517C13.8838 14.9445 14.3587 14.9445 14.6516 14.6517C14.9445 14.3588 14.9445 13.8839 14.6516 13.591L13.0606 12L14.6516 10.409C14.9445 10.1161 14.9445 9.64124 14.6516 9.34835C14.3587 9.05546 13.8838 9.05546 13.591 9.34835L12 10.9393L10.409 9.34835Z"
                fill="#340768"></path>
            </svg>
          </div>
        </div>
        <div class="main_body">
          <div id="login_author" class="form_hint">
            Authorization feedback
          </div>
          <label for="login_username">${currentLanguage.Username}<span class="form_hint"></span></label>
          <input name="name" id="login_username" autocomplete="name" />
          <label for="login_password">${currentLanguage.Password}
            <svg class="pwd_type" width="14px" height="14px" viewBox="0 0 24 24" stroke-width="1.5" fill="none"
              xmlns="http://www.w3.org/2000/svg" color="#FFFFFF">
              <path d="M19.5 16L17.0248 12.6038" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round"></path>
              <path d="M12 17.5V14" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              </path>
              <path d="M4.5 16L6.96895 12.6124" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round"></path>
              <path d="M3 8C6.6 16 17.4 16 21 8" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
            <span class="form_hint"></span></label>
          <input type="password" id="login_password" name="password" @keyup.enter="vue_login" />
          <button type="button" class="submit_btn" id="btn_login_submit">
            ${currentLanguage.Login}
          </button>
        </div>
      </div>
      <div id="edit_profile_form">
        <div class="top_bar">
          <label class="title">${currentLanguage.Edit_Profile}</label>
          <div id="btn_profile_form_close" class="btn_close">
            <svg width="24px" height="24px" viewBox="0 0 24 24" fill="#340768" xmlns="http://www.w3.org/2000/svg"
              color="#340768" stroke-width="1.5">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M3.6 2.25C2.85442 2.25 2.25 2.85441 2.25 3.6V20.4C2.25 21.1456 2.85441 21.75 3.6 21.75H20.4C21.1456 21.75 21.75 21.1456 21.75 20.4V3.6C21.75 2.85442 21.1456 2.25 20.4 2.25H3.6ZM10.409 9.34835C10.1161 9.05546 9.64121 9.05546 9.34831 9.34835C9.05542 9.64124 9.05542 10.1161 9.34831 10.409L10.9393 12L9.34831 13.591C9.05542 13.8839 9.05542 14.3588 9.34831 14.6517C9.64121 14.9445 10.1161 14.9445 10.409 14.6517L12 13.0607L13.591 14.6517C13.8838 14.9445 14.3587 14.9445 14.6516 14.6517C14.9445 14.3588 14.9445 13.8839 14.6516 13.591L13.0606 12L14.6516 10.409C14.9445 10.1161 14.9445 9.64124 14.6516 9.34835C14.3587 9.05546 13.8838 9.05546 13.591 9.34835L12 10.9393L10.409 9.34835Z"
                fill="#340768"></path>
            </svg>
          </div>
        </div>
        <div class="main_body">
          <div class="info_row">
            <div id="edit_profile">
              <div id="edit_author" class="form_hint">
                Authorization feedback
              </div>
              <label id="label_edit_username">${currentLanguage.Username}:
                <span style="font-weight: 500; font-size: 1rem">your
                  name</span></label>
              <input type="hidden" name="username" id="edit_username" />
              <label for="edit_nickname">${currentLanguage.Nickname}<span class="form_hint"></span></label>
              <input name="nickname" id="edit_nickname" data-optional="true" />
              <label for="edit_email">${currentLanguage.Email}<span class="form_hint"></span></label>
              <input type="email" name="email" id="edit_email" autocomplete="email" />
              <div class="gender_bar">
                <label>${currentLanguage.Gender}</label>
                <input type="radio" id="edit_gender_male" name="edit_gender" value="male" />
                <label for="edit_gender_male">${currentLanguage.Male}</label>
                <input type="radio" id="edit_gender_female" name="edit_gender" value="female" />
                <label for="edit_gender_female">${currentLanguage.Female}</label>
              </div>
            </div>
            <div id="edit_charlooks">
              <span class="looks_title">${currentLanguage.Portrait_Looks}</span>
              <div class="avatar_preview">${currentLanguage.Preview}</div>
              <button type="button" class="submit_btn" id="btn_avatar_preview_edit">
                ${currentLanguage.Preview_avatar}
              </button>
              <label for="edit_char_race">${currentLanguage.Race}</label>
              <select id="edit_char_race">
                <option value="Asian">Asian</option>
                <option value="European">European</option>
                <option value="American">American</option>
                <option value="Latino">Latino</option>
                <option value="Indian">Indian</option>
              </select>
              <label for="edit_char_age">${currentLanguage.Age}</label>
              <select id="edit_char_age">
                <option value="Young adult">Young adult</option>
                <option value="Middle-aged">Middle-aged</option>
                <option value="Elderly">Elderly</option>
              </select>
              <label for="edit_char_hair_style">${currentLanguage.Hair_Style}</label>
              <select id="edit_char_hair_style">
                <option value="Neat Short hair">Neat Short hair</option>
                <option value="Neat Long hair">Neat Long hair</option>
                <option value="Curls Short hair">Curls Short hair</option>
                <option value="Curls Long hair">Curls Long hair</option>
                <option value="Ear-length hair">Ear-length hair</option>
                <option value="Buzz cut">Buzz cut</option>
                <option value="Bald">Bald</option>
              </select>
              <label for="edit_char_hair_color">${currentLanguage.Hair_Color}</label>
              <select id="edit_char_hair_color">
                <option value="Black">Black</option>
                <option value="Blond">Blond</option>
                <option value="Silver">Silver</option>
                <option value="Brown">Brown</option>
                <option value="Red">Red</option>
              </select>
              <label for="edit_char_eye_color">${currentLanguage.Eyes_Color}</label>
              <select id="edit_char_eye_color">
                <option value="Black Eyes">Black</option>
                <option value="Blue Eyes">Blue</option>
                <option value="Green Eyes">Green</option>
                <option value="Brown Eyes">Brown</option>
                <option value="Amber Eyes">Amber</option>
              </select>
              <label for="edit_char_beard">${currentLanguage.Beard_Type}</label>
              <select id="edit_char_beard">
                <option value>None</option>
                <option value="Big beard">Big beard</option>
                <option value="Sideburns">Sideburns</option>
                <option value="Goatee">Goatee</option>
                <option value="Small beard">Small beard</option>
                <option value="wizard beard">wizard beard</option>
              </select>
            </div>
          </div>
          <button type="button" class="submit_btn" id="btn_edit_submit">
            ${currentLanguage.Submit_New_Profile}
          </button>
        </div>
      </div>
      <div id="create_character_form">
        <div class="top_bar">
          <label class="title">${currentLanguage.Create_Character}</label>
          <div id="btn_character_form_close" class="btn_close">
            <svg width="24px" height="24px" viewBox="0 0 24 24" fill="#340768" xmlns="http://www.w3.org/2000/svg"
              color="#340768" stroke-width="1.5">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M3.6 2.25C2.85442 2.25 2.25 2.85441 2.25 3.6V20.4C2.25 21.1456 2.85441 21.75 3.6 21.75H20.4C21.1456 21.75 21.75 21.1456 21.75 20.4V3.6C21.75 2.85442 21.1456 2.25 20.4 2.25H3.6ZM10.409 9.34835C10.1161 9.05546 9.64121 9.05546 9.34831 9.34835C9.05542 9.64124 9.05542 10.1161 9.34831 10.409L10.9393 12L9.34831 13.591C9.05542 13.8839 9.05542 14.3588 9.34831 14.6517C9.64121 14.9445 10.1161 14.9445 10.409 14.6517L12 13.0607L13.591 14.6517C13.8838 14.9445 14.3587 14.9445 14.6516 14.6517C14.9445 14.3588 14.9445 13.8839 14.6516 13.591L13.0606 12L14.6516 10.409C14.9445 10.1161 14.9445 9.64124 14.6516 9.34835C14.3587 9.05546 13.8838 9.05546 13.591 9.34835L12 10.9393L10.409 9.34835Z"
                fill="#340768"></path>
            </svg>
          </div>
        </div>
        <div class="main_body">
          <div class="info_row">
            <!-- Character Profile HTML -->
            <div id="createchar_profile">
              <div id="createchar_author" class="form_hint">
                Authorization feedback
              </div>
              <label for="char_unique_id">${currentLanguage.Character_unique_id} *<span
                  class="form_hint"></span></label>
              <input name="unique_name" id="char_unique_id" />
              <label for="char_ai_name">${currentLanguage.Character_Name} *<span class="form_hint"></span></label>
              <input name="ai_name" id="char_ai_name" />
              <label for="char_persona">${currentLanguage.Character_persona}<span class="form_hint"></span></label>
              <span class="textarea_hint">write a shot description of the character's persona, then use wizard to
                generate more details</span>
              <textarea name="persona_char_guideline"
                id="char_persona_guideline">a girl from england, outgoing and passionate, her figure is sexy, she works as software developr for Mistral</textarea>
              <span class="textarea_hint">Preview and edit generated persona</span>
              <textarea name="persona_ai"
                id="char_persona"> {% raw %}{{char}}'s persona has not been set {% endraw %}</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_char_persona_wizard">
                Character persona wizard
              </button>
              <label for="char_looks">${currentLanguage.Character_looks}<span class="form_hint"></span></label>
              <span class="textarea_hint">character looks descriptive prompt,
                can use wizard once complete character
                persona, for example:</span>
              <textarea name="looks_ai"
                id="char_looks">a girl, 30yo, (long red hair:1.13), (green eye:1.10), saggy breasts, (slim waist:1.17)</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_char_looks_wizard">
                Character looks wizard
              </button>
              <label for="char_outfit">${currentLanguage.Character_outfit}<span class="form_hint"></span></label>
              <span class="textarea_hint">character outfit json data, can use
                wizard once character persona and looks
                set, do not change the format:</span>
              <textarea name="outfit_ai" id="char_outfit">
{
    "normal": "",
    "underwear": "",
    "bdsm": "",
    "naked": ""
}</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_char_outfit_wizard">
                Character outfit wizard
              </button>
              <label for="user_persona">${currentLanguage.User_persona}<span class="form_hint"></span></label>
              <span class="textarea_hint">write a shot description of the character's persona, then use wizard to
                generate more details</span>
              <textarea name="persona_user_guideline"
                id="user_persona_guideline">a great cooking master, a bit shy but brave, always learning new things</textarea>
              <span class="textarea_hint">Preview and edit generated persona</span>
              <textarea name="persona_user"
                id="user_persona">{% raw %}{{user}}'s persona has not been set {% endraw %}</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_user_persona_wizard">
                User persona wizard
              </button>
              <label for="story_prologue">${currentLanguage.Story_prologue}<span class="form_hint"></span></label>
              <span class="textarea_hint">Plot guideline, to set the concept or type of the plot</span>
              <textarea name="guideline_story"
                id="story_guideline">{% raw %}It's a concise but realistic criminal plot developing between {{char}} and {{user}}, less than 100 words!{% endraw %}</textarea>
              <span class="textarea_hint">Plot context, can use wizard to get best result once character persona and
                user persona are completed</span>
              <textarea name="prologue_story" id="story_prologue">story plot has not been set</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_prologue_wizard">
                Prologue wizard
              </button>
              <label for="story_intro">${currentLanguage.Concise_intro_of_story}<span class="form_hint"></span></label>
              <span class="textarea_hint">guideline for create a concise intro for your story</span>
              <textarea name="guideline_intro_story"
                id="story_intro_guideline">{% raw %}focus on introducing {{char}} and {{user}}, make it more thrill!{% endraw %}</textarea>
              <span class="textarea_hint">Preview and edit generated story concise intro once story prologue are
                completed</span>
              <textarea name="intro_story" id="story_intro">concise intro of story has not been set</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_story_intro_wizard">
                Intro wizard
              </button>
              <label for="story_chapters">${currentLanguage.Story_Chapters}<span class="form_hint"></span></label>
              <span class="textarea_hint">story chapters JSON list, can use
                wizard once story prologue is complete, for
                example:</span>
              <textarea name="chapters_story" id="story_chapters">
[
  {"name":"Chapter 1"},
  {"name":"Chapter 2"},
  {"name":"Chapter 3"}
]</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_chapters_wizard">
                Chapter wizard
              </button>
              <label for="chat_bg">${currentLanguage.Chat_Environment}<span class="form_hint"></span></label>
              <span class="textarea_hint">guide words for chat enivornment, define interior or exterior, elements etc.,
                for example:</span>
              <textarea name="bg_guidewords_ai"
                id="chat_bg_guidewords">focus solely on interior environment elements only, moody lighting description is welcomed, no exterior environment needed</textarea>
              <span class="textarea_hint">Chat Background Enviornment prompt,
                can use wizard once prologue set, for
                example:</span>
              <textarea name="bg_default"
                id="chat_bg">(bustling streets of London), (nighttime ambiance), (street lights illuminating the path)</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_chat_bg_wizard">
                Chat Enviornment wizard
              </button>
              <label for="story_firstwords">${currentLanguage.First_Line_Spokens}<span class="form_hint"></span></label>
              <span class="textarea_hint">The first line spoken by the
                character at the beginning, can use wizard once
                story prologue is complete, for example:</span>
              <textarea name="firstwords_story"
                id="story_firstwords">{% raw %}*I couldn't help but be drawn to the quiet intensity of {{user}}, my eyes locked onto them as we navigated the crowded speakeasy* What brings you here, I wonder?{% endraw %}</textarea>
              <button type="button" class="submit_btn wizard_btn" id="btn_firstwords_wizard">
                First line spokens wizard
              </button>
              <label for="prompt_to_load">${currentLanguage.Prompt_To_Load}</label>
              <select id="prompt_to_load">
                <option value="Alpaca_RP">Alpaca_RP</option>
                <option value="Cohere_RP">Cohere_RP</option>
                <option value="ChatML_RP">ChatML_RP</option>
              </select>
              <label for="ai_speaker_cn">${currentLanguage.AI_Speaker_CN}</label>
              <select id="ai_speaker_cn">
                <option value="zh-cn_qingling">zh-cn_qingling</option>
                <option value="zh-CN-XiaomoNeural">zh-cn_qingling</option>
              </select>
              <label for="ai_speaker_en">${currentLanguage.AI_Speaker_EN}</label>
              <select id="ai_speaker_en">
                <option value="en_female_01">en_female_01</option>
                <option value="en_female_02">en_female_02</option>
                <option value="en_female_03">en_female_03</option>
                <option value="en_female_04">en_female_04</option>
                <option value="en_keanu">en_keanu</option>
                <option value="en_stevejobs">en_stevejobs</option>
              </select>
              <div class="full_bar">
                <label>${currentLanguage.Uncensored_Chat}</label>
                <input type="radio" id="uncensored_yes" name="uncensored_switch" value="yes" checked />
                <label for="uncensored_yes">Yes</label>
                <input type="radio" id="uncensored_no" name="uncensored_switch" value="no" />
                <label for="uncensored_no">No</label>
              </div>
              <div class="full_bar">
                <label>${currentLanguage.NSFW}</label>
                <input type="radio" id="NSFW_yes" name="NSFW_switch" value="NSFW" checked />
                <label for="NSFW_yes">Yes</label>
                <input type="radio" id="NSFW_no" name="NSFW_switch" value="SFW" />
                <label for="NSFW_no">No</label>
              </div>
              <div class="full_bar">
                <label>${currentLanguage.Generate_Dynamic_Picture}</label>
                <input type="radio" id="GDP_yes" name="GDP_switch" value="yes" checked />
                <label for="GDP_yes">Yes</label>
                <input type="radio" id="GDP_no" name="GDP_switch" value="no" />
                <label for="GDP_no">No</label>
              </div>
              <label for="char_avatarprefix">${currentLanguage.Character_Avatar_Prefix}<span
                  class="form_hint"></span></label>
              <span class="textarea_hint">default is fine, don't change the
                emotion template mark, it will be replaced
                by the actual emotion</span>
              <textarea name="avatarprefix_ai"
                id="char_avatarprefix">Perfect face portrait, (close-up:1.12), (&lt;|emotion|&gt; expression)</textarea>
              <label for="completions_data">${currentLanguage.Completions_Parameters}<span
                  class="form_hint"></span></label>
              <span class="textarea_hint">The json parameters used to infer
                the model, Do not change the format:</span>
              <textarea name="data_completions" id="completions_data">
{
  "max_tokens": 160,
  "top_k": 50,
  "top_p": 0.8,
  "min_p": 0.05,
  "tfs": 0.95,
  "frequency_penalty": 0,
  "presence_penalty": 1.15,
  "repetition_penalty": 1.05,
  "mirostat_mode": 0,
  "mirostat_tau": 1.5,
  "mirostat_eta": 0.1,
  "temperature_last": true,
  "smoothing_factor": 0.55
}</textarea>
            </div>
            <div id="createchar_charlooks">
              <span class="looks_title">${currentLanguage.Preview_Character_Looks}</span>
              <span class="textarea_hint">can use to preview character looks
                once character looks fields are
                filled</span>
              <div class="createchar_preview">
                <div class="content">${currentLanguage.Preview}</div>
              </div>
              <div class="full_bar">
                <label for="looking_outfit">Looking</label>
                <select id="looking_outfit" style="width: fit-content;">
                  <option value="normal" selected>normal</option>
                  <option value="underwear">underwear</option>
                  <option value="bdsm">bdsm</option>
                  <option value="naked">naked</option>
                </select>
                <label for="looking_from">from</label>
                <select id="looking_from" style="width: fit-content;">
                  <option value="(looking from front)" selected>front</option>
                  <option value="(Looking from below)">below</option>
                  <option value="(looking from above)">above</option>
                  <option value="(looking from side)">side</option>
                  <option value="(looking from behind)">behind</option>
                </select>
              </div>
              <button type="button" class="submit_btn preview_btn" id="btn_createchar_preview">
                ${currentLanguage.Preview_Character}
              </button>

            </div>
          </div>
          <button type="button" class="submit_btn" id="btn_character_submit">
            ${currentLanguage.Save_Character}
          </button>
        </div>
      </div>
      <div id="role_intro_form">
        <div class="top_bar">
          <div class="role_intro_story_name">StoryName</div>
          <div id="btn_role_intro_form_close" class="btn_close">
            <svg width="24px" height="24px" viewBox="0 0 24 24" fill="#340768" xmlns="http://www.w3.org/2000/svg"
              color="#340768" stroke-width="1.5">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M3.6 2.25C2.85442 2.25 2.25 2.85441 2.25 3.6V20.4C2.25 21.1456 2.85441 21.75 3.6 21.75H20.4C21.1456 21.75 21.75 21.1456 21.75 20.4V3.6C21.75 2.85442 21.1456 2.25 20.4 2.25H3.6ZM10.409 9.34835C10.1161 9.05546 9.64121 9.05546 9.34831 9.34835C9.05542 9.64124 9.05542 10.1161 9.34831 10.409L10.9393 12L9.34831 13.591C9.05542 13.8839 9.05542 14.3588 9.34831 14.6517C9.64121 14.9445 10.1161 14.9445 10.409 14.6517L12 13.0607L13.591 14.6517C13.8838 14.9445 14.3587 14.9445 14.6516 14.6517C14.9445 14.3588 14.9445 13.8839 14.6516 13.591L13.0606 12L14.6516 10.409C14.9445 10.1161 14.9445 9.64124 14.6516 9.34835C14.3587 9.05546 13.8838 9.05546 13.591 9.34835L12 10.9393L10.409 9.34835Z"
                fill="#d0adf8"></path>
            </svg>
          </div>
        </div>
        <div class="main_body">
          <div class="role_intro_content">
            <div class="role_intro_img">
              <div class="info_NSFW">
                <svg width="18px" height="18px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path class="NSFW_icon"
                    d="M4.8 1.40006C4.54174 1.05572 4.09211 0.915267 3.68377 1.05138C3.27543 1.1875 3 1.56963 3 2.00006V10.0001C3 10.5523 3.44772 11.0001 4 11.0001C4.55228 11.0001 5 10.5523 5 10.0001V5.00006L9.2 10.6001C9.45826 10.9444 9.90789 11.0849 10.3162 10.9487C10.7246 10.8126 11 10.4305 11 10.0001V2.00006C11 1.44778 10.5523 1.00006 10 1.00006C9.44772 1.00006 9 1.44778 9 2.00006V7.00006L4.8 1.40006Z" />
                  <path class="NSFW_icon"
                    d="M15 1.00006C13.8954 1.00006 13 1.89549 13 3.00006V5.00006C13 6.10463 13.8954 7.00006 15 7.00006H19V9.00006H14C13.4477 9.00006 13 9.44778 13 10.0001C13 10.5523 13.4477 11.0001 14 11.0001H19C20.1046 11.0001 21 10.1046 21 9.00006V7.00006C21 5.89549 20.1046 5.00006 19 5.00006H15V3.00006H20C20.5523 3.00006 21 2.55235 21 2.00006C21 1.44778 20.5523 1.00006 20 1.00006H15Z" />
                  <path class="NSFW_icon"
                    d="M3 14.0001C3 13.4478 3.44772 13.0001 4 13.0001H10C10.5523 13.0001 11 13.4478 11 14.0001C11 14.5524 10.5523 15.0001 10 15.0001H5V17.0001H10C10.5523 17.0001 11 17.4478 11 18.0001C11 18.5523 10.5523 19.0001 10 19.0001H5V22.0001C5 22.5523 4.55228 23.0001 4 23.0001C3.44772 23.0001 3 22.5523 3 22.0001V14.0001Z" />
                  <path class="NSFW_icon"
                    d="M15 14.0001C15 13.4478 14.5523 13.0001 14 13.0001C13.4477 13.0001 13 13.4478 13 14.0001V22.0001C13 22.4495 13.2999 22.8438 13.7331 22.9638C14.1662 23.0838 14.6262 22.9 14.8575 22.5146L17 18.9437L19.1425 22.5146C19.3738 22.9 19.8338 23.0838 20.2669 22.9638C20.7001 22.8438 21 22.4495 21 22.0001V14.0001C21 13.4478 20.5523 13.0001 20 13.0001C19.4477 13.0001 19 13.4478 19 14.0001V18.3897L17.8575 16.4856C17.6768 16.1844 17.3513 16.0001 17 16.0001C16.6487 16.0001 16.3232 16.1844 16.1425 16.4856L15 18.3897V14.0001Z" />
                </svg>
              </div>
            </div>
            <div class="role_intro_textwrapper">
              <div class="role_intro_intro_text">StoryIntro</div>
              <div class="role_intro_button" v-text="currentLanguage.Start_Your_Journey" @click="startChating"></div>
            </div>

          </div>
        </div>
      </div>
    </div>
    <div id="roleholder_template" style="display: none"><!--
      <div class="roleholder">
        <div class="avatarbk">
          <div class="info_NSFW">
            <svg width="18px" height="18px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path class="NSFW_icon"
                d="M4.8 1.40006C4.54174 1.05572 4.09211 0.915267 3.68377 1.05138C3.27543 1.1875 3 1.56963 3 2.00006V10.0001C3 10.5523 3.44772 11.0001 4 11.0001C4.55228 11.0001 5 10.5523 5 10.0001V5.00006L9.2 10.6001C9.45826 10.9444 9.90789 11.0849 10.3162 10.9487C10.7246 10.8126 11 10.4305 11 10.0001V2.00006C11 1.44778 10.5523 1.00006 10 1.00006C9.44772 1.00006 9 1.44778 9 2.00006V7.00006L4.8 1.40006Z" />
              <path class="NSFW_icon"
                d="M15 1.00006C13.8954 1.00006 13 1.89549 13 3.00006V5.00006C13 6.10463 13.8954 7.00006 15 7.00006H19V9.00006H14C13.4477 9.00006 13 9.44778 13 10.0001C13 10.5523 13.4477 11.0001 14 11.0001H19C20.1046 11.0001 21 10.1046 21 9.00006V7.00006C21 5.89549 20.1046 5.00006 19 5.00006H15V3.00006H20C20.5523 3.00006 21 2.55235 21 2.00006C21 1.44778 20.5523 1.00006 20 1.00006H15Z" />
              <path class="NSFW_icon"
                d="M3 14.0001C3 13.4478 3.44772 13.0001 4 13.0001H10C10.5523 13.0001 11 13.4478 11 14.0001C11 14.5524 10.5523 15.0001 10 15.0001H5V17.0001H10C10.5523 17.0001 11 17.4478 11 18.0001C11 18.5523 10.5523 19.0001 10 19.0001H5V22.0001C5 22.5523 4.55228 23.0001 4 23.0001C3.44772 23.0001 3 22.5523 3 22.0001V14.0001Z" />
              <path class="NSFW_icon"
                d="M15 14.0001C15 13.4478 14.5523 13.0001 14 13.0001C13.4477 13.0001 13 13.4478 13 14.0001V22.0001C13 22.4495 13.2999 22.8438 13.7331 22.9638C14.1662 23.0838 14.6262 22.9 14.8575 22.5146L17 18.9437L19.1425 22.5146C19.3738 22.9 19.8338 23.0838 20.2669 22.9638C20.7001 22.8438 21 22.4495 21 22.0001V14.0001C21 13.4478 20.5523 13.0001 20 13.0001C19.4477 13.0001 19 13.4478 19 14.0001V18.3897L17.8575 16.4856C17.6768 16.1844 17.3513 16.0001 17 16.0001C16.6487 16.0001 16.3232 16.1844 16.1425 16.4856L15 18.3897V14.0001Z" />
            </svg>
          </div>
        </div>
        <div class="role_info_bar">
          <div class="ainame_span">ainame</div>
          <div class="info_button"><svg width="25px" height="25px" viewBox="0 0 20 20" fill="#ffffff"
              xmlns="http://www.w3.org/2000/svg">
              <path class="svg_info" ill-rule="evenodd" clip-rule="evenodd"
                d="M10 18C5.58172 18 2 14.4183 2 10C2 5.58172 5.58172 2 10 2C14.4183 2 18 5.58172 18 10C18 14.4183 14.4183 18 10 18ZM10 8.92857C9.44772 8.92857 9 9.37629 9 9.92857V13.9286C9 14.4809 9.44772 14.9286 10 14.9286C10.5523 14.9286 11 14.4809 11 13.9286V9.92857C11 9.37629 10.5523 8.92857 10 8.92857ZM10 7.5C10.5523 7.5 11 7.05228 11 6.5C11 5.94772 10.5523 5.5 10 5.5C9.44772 5.5 9 5.94772 9 6.5C9 7.05228 9.44772 7.5 10 7.5Z" />
            </svg>
          </div>
        </div>
        <input type="radio" class="roleRadios" id="ainame" name="ai_role_name" value="rolename in list"
          data-uncensored="censoredmarker" data-story_name="storynamemarker" data-intro_text="introtextmarker" />
      </div>-->
    </div>
    <div id="bg_music_player" style="display: none;">
      <audio id="bg_music" src="/play_music/Relaxing_Moment" loop></audio>
    </div>
  </div>


  <!-- Script Block -->
  <script src="/static/js/gsap.min.js"></script>
  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <!-- Vue -->
  <script src="/static/js/vue.global.js"></script>
  <script>
    const { ref, computed, nextTick, watch, onMounted } = Vue
    const app = Vue.createApp({
      delimiters: ['${', '}'],
      setup() {
        const aiRoleList_vue = ref(JSON.parse('{{ ai_role_list | tojson | safe }}'))
        console.log(aiRoleList_vue.value)
        const languageData = ref(JSON.parse('{{ language_Data | tojson | safe }}'))
        console.log(languageData.value)
        const currentLanguage = computed(() => {
          return languageData.value.IndexPage
        })
        watch(currentLanguage, (newVal, oldVal) => {
          document.title = newVal.siteName
        }, { immediate: true })
        const vue_login = () => {
          login()
        }
        const hoverRole = (event) => {
          if (event) {
            const hoveredElement = event.target;
            hoveredElement.style.backgroundSize = '140%';
          } else {
            const roleElements = document.querySelectorAll('.avatarbk');
            roleElements.forEach(el => {
              el.style.backgroundSize = '100%';
            });
          }
        }
        const setWindowVars = (role) => {
          window.ai_role_name = role.aiRoleId;
          window.ainame = role.Data.ai_name;
          window.is_uncensored = role.Data.if_uncensored;
          window.story_name = role.Data.json_Story_intro.story_name;
          window.intro_text = role.Data.json_Story_intro.intro_text;
        }
        const selectRole = (event, role) => {
          let select_el;
          if (event) {
            select_el = event.target
          } else if (event == null) {
            const default_role = document.querySelector('.roleholder:first-child')
            select_el = default_role.querySelector('.avatarbk')
          }
          const roleElements = document.querySelectorAll('.avatarbk');
          roleElements.forEach(el => {
            el.style.boxShadow = '2px 2px 10px 5px rgba(0, 0, 0, 0.7)'
          });
          select_el.style.boxShadow = '0px 0px 25px 5px rgba(127, 3, 155, 0.7)'
          setWindowVars(role)
        }
        const updateStoryIntro = (translated_story_intro_data, aiRoleId) => {
          // find the aiRoleId in the aiRoleList_vue
          const role = aiRoleList_vue.value.find(role => role.aiRoleId === aiRoleId)
          role.Data.json_Story_intro.story_name = translated_story_intro_data.story_name
          role.Data.json_Story_intro.intro_text = translated_story_intro_data.intro_text
          role.if_story_intro_translated = true
          console.log(role)
          update_story_intro_translated(role)
        }
        const showRoleInfo = (event, role) => {
          const infoButton = event.target
          const currentLanguage = document.getElementById('language_switch').getAttribute('data-value');
          const avatarbkNode = infoButton.closest('.roleholder').querySelector('.avatarbk')
          const roleElements = document.querySelectorAll('.avatarbk');
          roleElements.forEach(el => {
            el.style.boxShadow = '2px 2px 10px 5px rgba(0, 0, 0, 0.7)'
          });
          avatarbkNode.style.boxShadow = '0px 0px 25px 5px rgba(127, 3, 155, 0.7)'
          const roleInfoForm = document.getElementById('role_intro_form')
          if (currentLanguage != 'English' && role.if_story_intro_translated == null) {
            let querydata = {
              'story_name': role.Data.json_Story_intro.story_name,
              'intro_text': role.Data.json_Story_intro.intro_text,
              'language': currentLanguage,
              'aiRoleId': role.aiRoleId
            }
            ws.send(wsData('translate_story_intro', querydata))
            roleInfoForm.querySelector('.role_intro_story_name').innerHTML = `<span class="storyname_in_introblock">${role.Data.json_Story_intro.story_name}(translating...)</span>`
            roleInfoForm.querySelector('.role_intro_intro_text').innerHTML = role.Data.json_Story_intro.intro_text.replaceAll('{% raw %}{{char}}{% endraw %}', `<span class="ainame_in_introtext">${role.Data.ai_name}</span>`) + "(translating...)"

          } else {
            roleInfoForm.querySelector('.role_intro_story_name').innerHTML = `<span class="storyname_in_introblock">${role.Data.json_Story_intro.story_name}</span>`
            roleInfoForm.querySelector('.role_intro_intro_text').innerHTML = role.Data.json_Story_intro.intro_text.replaceAll('{% raw %}{{char}}{% endraw %}', `<span class="ainame_in_introtext">${role.Data.ai_name}</span>`)

          }

          roleInfoForm.querySelector('.role_intro_img').style.backgroundImage = avatarbkNode.style.backgroundImage
          if(role.Data.Match_words_cata !== "NSFW"){
            roleInfoForm.querySelector('.info_NSFW').style.display = 'none'
          }else{
            roleInfoForm.querySelector('.info_NSFW').style.display = 'flex'
          }
          window.toggle_forms('role_intro_form')
          setWindowVars(role)

        }
        const update_story_intro_translated = (role) => {
          const roleInfoForm_updated = document.getElementById('role_intro_form')
          roleInfoForm_updated.querySelector('.role_intro_story_name').innerHTML = `<span class="storyname_in_introblock">${role.Data.json_Story_intro.story_name}</span>`
          roleInfoForm_updated.querySelector('.role_intro_intro_text').innerHTML = role.Data.json_Story_intro.intro_text.replaceAll('{% raw %}{{char}}{% endraw %}', `<span class="ainame_in_introtext">${role.Data.ai_name}</span>`)
        }
        const startChating = () => {
          window.start_chat()
        }
        onMounted(() => {
          Vue.nextTick(() => {
            gsap.from(".roleholder", {
              duration: 0.2,
              opacity: 0,
              scale: 0.6,
              ease: "back",
              stagger: 0.1,
            });
            selectRole(null, aiRoleList_vue.value[0])
          });
        });
        return {
          currentLanguage,
          languageData,
          aiRoleList_vue,
          vue_login,
          hoverRole,
          selectRole,
          showRoleInfo,
          startChating,
          updateStoryIntro,
          update_story_intro_translated
        }
      }
    })
    const vm = app.mount('#app')
  </script>
  <script type="text/javascript" charset="utf-8">
    //load roles
    var aiRoleList = JSON.parse('{{ ai_role_list | tojson | safe }}');
    // console.log(aiRoleList);
    var ainame;
    var ai_role_name;
    var is_uncensored;
    var story_name;
    var intro_text;
    var conid;
    var userdata;
    var login_status = false;
    var ws = Object;
    const clientID = "{{ cookid_server }}";
    const timestamp = "{{ timestamp }}";
    console.log("Client ID: " + clientID);

    function wsData(wsevent, querydata) {
      let messagebody = {
        wsevent_client: wsevent,
        data: querydata
      }
      return JSON.stringify(messagebody)
    }

    function setCookie(name, value, days) {
      var expires = "";
      if (days) {
        var date = new Date();
        date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
        expires = "; expires=" + date.toUTCString();
      }
      document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }
    function getCookie(name) {
      var nameEQ = name + "=";
      var ca = document.cookie.split(";");
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == " ") c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0)
          return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
    function deleteCookie(name) {
      document.cookie =
        name + "=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;";
    }
    function isValidJSONObject(str) {
      try {
        const jsonObj = JSON.parse(str);
        // 检查解析后的结果是否是非空对象或非空数组
        if (
          (typeof jsonObj === 'object' && jsonObj !== null) &&
          (Object.keys(jsonObj).length > 0 || Array.isArray(jsonObj)) &&
          (!Array.isArray(jsonObj) || jsonObj.length > 0)
        ) {
          return true;
        }
        return false;
      } catch (e) {
        return false;
      }
    }

    function form_validation(form_id) {
      let inputs = $("#" + form_id).find("input");
      let allinputFilled = true;
      inputs.each(function () {
        if ($(this).val() == "" && !$(this).data("optional")) {
          let name = $(this).attr("name");
          let inputID = $(this).attr("id");
          let corrlabel = $("label[for='" + inputID + "']").find("span");
          corrlabel.html(name + " can not be empty");
          allinputFilled = false;
          return false;
        } else {
          let inputID = $(this).attr("id");
          let corrlabel = $("label[for='" + inputID + "']").find("span");
          corrlabel.html("");
        }
      });
      return allinputFilled;
    }

    function toggleInputs(input_switcher) {
      let all_inputs = $("input, button, select, option, textarea");
      all_inputs.each(function () {
        if (input_switcher) {
          $(this).removeAttr("disabled");
          $(this).css({ opacity: 1 });
        } else {
          $(this).attr("disabled", true);
          $(this).css({ opacity: 0.5 });
        }
      });
    }

    function toggle_forms(form_id) {
      let overlay = $("#overlay");
      let display_stat = overlay.css("display");
      if (display_stat == "none") {
        overlay.css({ display: "flex" });
        if (form_id == "signup") {
          $("#signup_form").css({ display: "flex" });
          gsap.from("#signup_form", {
            duration: 1,
            opacity: 0,
            scale: 0.5,
            ease: "elastic",
          });
        } else if (form_id == "login") {
          $("#login_form").css({ display: "flex" });
          gsap.from("#login_form", {
            duration: 1,
            opacity: 0,
            scale: 0.5,
            ease: "elastic",
          });
        } else if (form_id == "editprofile") {
          $("#edit_profile_form").css("display", "flex");
          gsap.from("#edit_profile_form", {
            duration: 1,
            opacity: 0,
            scale: 0.5,
            ease: "elastic",
          });
        } else if (form_id == "createchar") {
          $("#create_character_form").css("display", "flex");
          gsap.from("#create_character_form", {
            duration: 1,
            opacity: 0,
            scale: 0.5,
            ease: "elastic",
          });
          let textareas = $("#create_character_form").find("textarea");
          textareas.each(function () {
            autoExpand(this);
          });
        } else if (form_id == "role_intro_form") {
          $("#role_intro_form").css("display", "flex");
          gsap.from("#role_intro_form", {
            duration: 1,
            opacity: 0,
            scale: 0.5,
            ease: "elastic",
          });
        }
      } else {
        let all_hints = $(".form_hint");
        all_hints.each(function () {
          $(this).html("");
        });
        $("#signup_form").hide();
        $("#login_form").hide();
        $("#edit_profile_form").hide();
        $("#create_character_form").hide();
        $("#role_intro_form").hide();
        $("#sign_author").hide().html("");
        $("#login_author").hide().html("");
        $("#createchar_author").hide().html("");
        let signup_inputs = $("#signup_form").find("input");
        let login_inputs = $("#login_form").find("input");
        let editprofile_inputs = $("#edit_profile_form").find("input");
        let createchar_inputs = $("#create_character_form").find("input");
        signup_inputs.each(function () {
          if ($(this).attr("type") != "radio") {
            $(this).val("");
          }
        });

        createchar_inputs.each(function () {
          if ($(this).attr("type") != "radio") {
            $(this).val("");
          }
        });
        login_inputs.each(function () {
          $(this).val("");
        });
        overlay.hide();
      }
    }

    function login() {
      if (form_validation("login_form")) {
        toggleInputs(false);
        let querydata = {
          username: $("#login_username").val(),
          password: $("#login_password").val(),
        };
        ws.send(wsData("client_login", querydata));
      }
    }
    function sign_up() {
      let space = $("#sign_char_hair_color").val() != "" ? " " : "";
      let ends = $("#sign_char_beard").val() != "" ? ", " : "";
      let user_looks = {
        gender: $("input[name='sign_gender']:checked").val(),
        race: $("#sign_char_race").val(),
        age: $("#sign_char_age").val(),
        hair_color: $("#sign_char_hair_color").val(),
        hair_style: $("#sign_char_hair_style").val(),
        eye_color: $("#sign_char_eye_color").val(),
        beard: $("#sign_char_beard").val(),
      };
      console.log(user_looks);
      if (form_validation("signup_form")) {
        if ($("#sign_password").val() == $("#sign_repassword").val()) {
          toggleInputs(false);
          let querydata = {
            username: $("#sign_username").val(),
            nickname: $("#sign_nickname").val(),
            email: $("#sign_email").val(),
            password: $("#sign_password").val(),
            gender: $("input[name='sign_gender']:checked").val(),
            facelooks: user_looks,
          };
          ws.send(wsData("client_signup", querydata));
        } else {
          $("label[for='sign_repassword']")
            .find("span")
            .html("Password input not matched");
        }
      }
    }

    function profile_submit() {
      if (form_validation("edit_profile_form")) {

        let user_looks = {
          gender: $("input[name='edit_gender']:checked").val(),
          race: $("#edit_char_race").val(),
          age: $("#edit_char_age").val(),
          hair_color: $("#edit_char_hair_color").val(),
          hair_style: $("#edit_char_hair_style").val(),
          eye_color: $("#edit_char_eye_color").val(),
          beard: $("#edit_char_beard").val(),
        };

        let querydata = {
          username: $("#edit_username").val(),
          nickname: $("#edit_nickname").val(),
          email: $("#edit_email").val(),
          gender: $("input[name='edit_gender']:checked").val(),
          facelooks: user_looks,
        };
        console.log(querydata);
        ws.send(wsData("client_edit_profile", querydata));
        toggleInputs(false);
      }
    }
    function character_submit() {
      if (form_validation("create_character_form")) {
        let textareas = $("#create_character_form textarea");
        textareas.each(function () {
          if ($(this).val() == "") {
            alert("Please fill all the fields");
            return false;
          }
        });
        if (!isValidJSONObject($("#char_outfit").val()) || !isValidJSONObject($("#story_chapters").val()) || !isValidJSONObject($("#completions_data").val()) || isValidJSONObject($("#Story_intro"))) {
          alert("check JSON format!");
          return false;
        }
        //start to gather the data of character
        let decision = confirm("Save character now?");
        if (decision) {
          console.log("User clicked OK.");
        } else {
          console.log("User clicked Cancel.");
          return false;
        }
        let createchar_data = {
          "Name": $("#char_unique_id").val(),
          "Ai_name": $("#char_ai_name").val(),
          "Ai_speaker": $("#ai_speaker_cn").val(),
          "Ai_speaker_en": $("#ai_speaker_en").val(),
          "is_Uncensored": ($("input[name='uncensored_switch']:checked").val() == "yes"),
          "Prologue": $("#story_prologue").val(),
          "Char_Persona": $("#char_persona").val(),
          "User_Persona": $("#user_persona").val(),
          "json_Chapters": JSON.parse($("#story_chapters").val()),
          "Char_looks": $("#char_looks").val(),
          "json_Char_outfit": JSON.parse($("#char_outfit").val()),
          "Char_avatar": `${$("#char_avatarprefix").val()}, ${$("#char_looks").val()}`,
          "Default_bg": $("#chat_bg").val(),
          "Firstwords": $("#story_firstwords").val(),
          "is_Gen_DynaPic": ($("input[name='GDP_switch']:checked").val() == "yes"),
          "Prompt_to_load": $("#prompt_to_load").val(),
          "Match_words_cata": $("input[name='NSFW_switch']:checked").val(),
          "json_Completions_data": JSON.parse($("#completions_data").val()),
          "Creator_ID": userdata["unique_id"],
          "json_Story_intro": JSON.parse($("#story_intro").val()),
        }
        console.log(createchar_data);
        let querydata = {
          "createchar_data": createchar_data
        }
        ws.send(wsData("client_save_character", querydata));
        toggleInputs(false);
      } else {
        alert("Please fill the fields marked with '*'");
        return false;
      }
    }

    function ProcessServerStatus(msgData) {
      let msg = msgData.data["message"];
      console.log(msg);
      if (msg["name"] == "signup_validation") {
        toggleInputs(true);
        let error_fields = msg["msg"]["data"];
        error_fields.forEach(function (field) {
          let field_name = field["field"];
          let error_msg = field["error"];
          $("label[for='sign_" + field_name + "']")
            .find("span")
            .html(error_msg);
        });
      }

      if (msg["name"] == "login_validation") {
        toggleInputs(true);
        let error_fields = msg["msg"]["data"];
        error_fields.forEach(function (field) {
          let field_name = field["field"];
          let error_msg = field["error"];
          $("label[for='login_" + field_name + "']")
            .find("span")
            .html(error_msg);
        });
      }

      if (msg["name"] == "edit_validation") {
        toggleInputs(true);
        let error_fields = msg["msg"]["data"];
        error_fields.forEach(function (field) {
          let field_name = field["field"];
          let error_msg = field["error"];
          $("label[for='edit_" + field_name + "']")
            .find("span")
            .html(error_msg);
        });
      }

      if (msg["name"] == "signup_authorization") {
        if (msg["msg"]["status"] == "Fail") {
          toggleInputs(true);
          let error_msg = msg["msg"]["data"];
          $("#sign_author").css("display", "flex");
          $("#sign_author").html(error_msg);
        } else {
          //proccess to save user info
          userdata = msg["msg"]["data"];
          console.log(userdata);
          save_user_profile(userdata);
        }
      }

      if (msg["name"] == "login_authorization") {
        if (msg["msg"]["status"] == "Fail") {
          toggleInputs(true);
          let error_msg = msg["msg"]["data"];
          $("#login_author").css("display", "flex");
          $("#login_author").html(error_msg);
        } else {
          //proccess to save user info
          userdata = msg["msg"]["data"];
          console.log(userdata);
          save_user_profile(userdata);
        }
      }

      if (msg["name"] == "edit_authorization") {
        if (msg["msg"]["status"] == "Fail") {
          toggleInputs(true);
          let error_msg = msg["msg"]["data"];
          $("#edit_author").css("display", "flex");
          $("#edit_author").html(error_msg);
        } else {
          //proccess to save user info
          userdata = msg["msg"]["data"];
          console.log(userdata);
          save_user_profile(userdata);
        }
      }

    }
    function save_user_profile(userdata) {
      update_profile_bar(userdata);
      update_edit_form(userdata);
      $(".top_buttons").hide();
      toggle_forms("close");
      toggleInputs(true);
      $(".user_profile").css("display", "flex");
      $(".user_profile_edit_menu").css("display", "flex");
      gsap.from($(".user_profile"), { duration: 3, opacity: 0 });
      login_status = true;
      setCookie("userData", JSON.stringify(userdata), 1);
    }

    function update_profile_bar(userdata) {
      $(".user_profile")
        .find(".profile_avatar")
        .css({ "background-image": "url(" + userdata["avatar"] + ")" });
      $(".user_profile").find(".username").html(userdata["nickname"]);
      $(".user_profile")
        .find(".credits")
        .find("span")
        .html(userdata["credits"]);
    }
    function update_edit_form(userdata) {
      $("#edit_profile_form")
        .find("#label_edit_username")
        .find("span")
        .html(userdata["username"]);
      $("#edit_profile_form")
        .find("#edit_username")
        .val(userdata["username"]);
      $("#edit_profile_form")
        .find("#edit_nickname")
        .val(userdata["nickname"]);
      $("#edit_profile_form").find("#edit_email").val(userdata["email"]);
      $("#edit_profile_form")
        .find("#edit_gender_" + userdata["gender"])
        .prop("checked", true)
        .trigger("change");
      $("#edit_profile_form")
        .find("#edit_char_race")
        .val(userdata["facelooks"]["race"]);
      $("#edit_profile_form")
        .find("#edit_char_age")
        .val(userdata["facelooks"]["age"]);
      $("#edit_profile_form")
        .find("#edit_char_hair_style")
        .val(userdata["facelooks"]["hair_style"])
        .trigger("change");
      $("#edit_profile_form")
        .find("#edit_char_hair_color")
        .val(userdata["facelooks"]["hair_color"]);
      $("#edit_profile_form")
        .find("#edit_char_eye_color")
        .val(userdata["facelooks"]["eye_color"]);
      $("#edit_profile_form")
        .find("#edit_char_beard")
        .val(userdata["facelooks"]["beard"]);
    }
    function logout() {
      deleteCookie("userData");
      $(".user_profile").hide();
      $(".user_profile_edit_menu").hide();
      $(".user_profile_drop_menu").hide();
      $(".top_buttons").css("display", "flex");
      gsap.from($(".top_buttons"), { duration: 3, opacity: 0 });
      login_status = false;
    }

    function preview_avatar(looks) {
      let user_looks;
      let avatar_for;
      switch (looks) {
        case "signup":
          avatar_for = "signup";
          user_looks = {
            gender: $("input[name='sign_gender']:checked").val(),
            race: $("#sign_char_race").val(),
            age: $("#sign_char_age").val(),
            hair_color: $("#sign_char_hair_color").val(),
            hair_style: $("#sign_char_hair_style").val(),
            eye_color: $("#sign_char_eye_color").val(),
            beard: $("#sign_char_beard").val(),
          };
          $("#sign_charlooks").find(".avatar_preview").html("Generating...");
          break;
        case "edit":
          avatar_for = "edit";
          user_looks = {
            gender: $("input[name='edit_gender']:checked").val(),
            race: $("#edit_char_race").val(),
            age: $("#edit_char_age").val(),
            hair_color: $("#edit_char_hair_color").val(),
            hair_style: $("#edit_char_hair_style").val(),
            eye_color: $("#edit_char_eye_color").val(),
            beard: $("#edit_char_beard").val(),
          };
          $("#edit_charlooks").find(".avatar_preview").html("Generating...");
          break;
      }

      console.log(user_looks);
      let querydata = {
        facelooks: user_looks,
        avatar_for: avatar_for,
      };
      ws.send(wsData("preview_avatar", querydata));
      toggleInputs(false);

    }
    //createchar preview function
    function preview_createchar() {
      let char_looks = $("#char_looks").val();
      let char_outfit = $("#char_outfit").val();
      let chat_bg = $("#chat_bg").val();
      // let selectedoutfit = $('input[name="outfit_preview"]:checked').val();
      let selectedoutfit = $('#looking_outfit').val();
      let looking_from = $("#looking_from").val();
      if (char_looks == "" || char_outfit == "" || chat_bg == "") {
        alert("Please fill all the fields [char_looks,char_outfit,char_bg]");
        return;
      } else {
        let preview_prompt = `${char_looks}, ${JSON.parse(char_outfit)[selectedoutfit]}, ${looking_from}, ${chat_bg}`;
        console.log(preview_prompt);
        let querydata = {
          prompt: preview_prompt,
          task: "preview_createchar",
        };
        ws.send(wsData("preview_createchar", querydata));
        $("#createchar_charlooks").find(".createchar_preview .content").html("Generating...");
        toggleInputs(false);
      }
    }
    //wizard function
    function user_looks_prompt(userlooks) {
      let user_looks_str = `One ${userlooks["gender"]},  ${userlooks["race"]}, ${userlooks["age"]}, ${userlooks["hair_color"]} ${userlooks["hair_style"]}, ${userlooks["eye_color"]} eyes.`;
      if (userlooks["beard"] != "") {
        user_looks_str += ` ${userlooks["beard"]} beard.`;
      }
      return user_looks_str;
    }
    function createchar_wizard(task) {
      let wizardstr;
      let speaking_tone = 'normal';
      let user_looks = {
        gender: $("input[name='edit_gender']:checked").val(),
        race: $("#edit_char_race").val(),
        age: $("#edit_char_age").val(),
        hair_color: $("#edit_char_hair_color").val(),
        hair_style: $("#edit_char_hair_style").val(),
        eye_color: $("#edit_char_eye_color").val(),
        beard: $("#edit_char_beard").val(),
      };
      let user_appearance = user_looks_prompt(user_looks);
      console.log(user_appearance);
      let match_speaking_tone = $("#char_persona").val().match(/Speaking Tone:\s*([^\n]*)/);
      if (match_speaking_tone) {
        speaking_tone = match_speaking_tone[1].trim();
        console.log(speaking_tone);
      } else {
        speaking_tone = "normal";
        console.log("No speaking tone found.");
      }

      switch (task) {
        case "char_persona":
          wizardstr = $("#char_persona_guideline").val();
          break;
        case "char_looks":
          wizardstr = $("#char_persona").val();
          break;
        case "char_outfit":
          wizardstr = "{% raw %}{{char}}'s persona:\n{% endraw %}" + $("#char_persona").val(); +"\n\n{% raw %}{{char}}'s looks:\n{% endraw %}" + $("#char_looks").val();
          break;
        case "user_persona":
          wizardstr = "basic infomation of {% raw %}{{user}}'s persona:{% endraw %}\n" + $("#user_persona_guideline").val();
          break;
        case "prologue":
          wizardstr = "{% raw %}{{char}}'s persona:\n{% endraw %}" + $("#char_persona").val() + "{% raw %}\n\n{{user}}'s persona:\n{% endraw %}" + $("#user_persona").val() + "\n" + $("#story_guideline").val();
          break;
        case "story_intro":
          wizardstr = $("#story_prologue").val() + "\n the guideline for generating story intro: " + $("#story_intro_guideline").val();
          break;
        case "chapters":
          wizardstr = $("#story_prologue").val();
          break;
        case "chat_bg":
          wizardstr = $("#story_prologue").val() + "\n the guide for generating prompt: " + $("#chat_bg_guidewords").val();
          break;
        case "firstwords":
          wizardstr = $("#story_prologue").val() + "\n{% raw %}{{char}}'s speaking tone:\n{% endraw %}" + speaking_tone;
          break;
      }
      if (wizardstr.length > 0) {
        // console.log(wizardstr);
        let querydata = {
          wizardstr: wizardstr,
          task: task,
        };
        ws.send(wsData("createchar_wizard", querydata));
        toggleInputs(false);
      } else {
        alert("Please enter a valid input");
        return;
      }

    }

    function changePreviewAvatar(serverData) {
      let bkImg = serverData.data["avatar_img"];
      let avatar_for = serverData.data["avatar_for"];
      toggleInputs(true);
      switch (avatar_for) {
        case "signup":
          $("#sign_charlooks").find(".avatar_preview").html("");
          $("#sign_charlooks").find(".avatar_preview").css({ "background-image": "url(" + bkImg + ")" });
          gsap.from($("#sign_charlooks").find(".avatar_preview"), { duration: 0.3, backgroundSize: "140%", });
          break;
        case "edit":
          $("#edit_charlooks").find(".avatar_preview").html("");
          $("#edit_charlooks").find(".avatar_preview").css({ "background-image": "url(" + bkImg + ")" });
          gsap.from($("#edit_charlooks").find(".avatar_preview"), { duration: 0.3, backgroundSize: "140%", });
          break;
      }
    }
    //wizard update function
    // - process llm output text, format it well
    function process_wizard_result(text) {
      var lines = text.split('\n');
      var processedLines = lines.map(function (line) {
        return $.trim(line);
      }).filter(function (line) {
        return line.length > 0;
      }).filter(function (line) {
        return !line.startsWith('```');
      });

      var processedText = processedLines.join('\n');

      if (processedText.startsWith('{') && processedText.endsWith('}')) {
        var jsonLines = processedText.split('\n');
        var formattedJsonLines = jsonLines.map(function (line, index) {
          if (index !== 0 && index !== jsonLines.length - 1) {
            return '          ' + line;
          }
          return line;
        });

        processedText = formattedJsonLines.join('\n');
      }

      return processedText;
    }
    // - fill the procesed text to the textarea
    function createcharWizardUpdate(serverData) {
      let wizardstr_rawdata = serverData.data["result"];
      let wizardstr = process_wizard_result(wizardstr_rawdata);
      let task = serverData.data["task"];
      toggleInputs(true);
      switch (task) {
        case "char_persona":
          $("#char_persona").val(wizardstr).trigger('input');
          break;
        case "char_looks":
          $("#char_looks").val(wizardstr).trigger('input');
          break;
        case "prologue":
          $("#story_prologue").val(wizardstr).trigger('input');
          break;
        case "chapters":
          $("#story_chapters").val(wizardstr).trigger('input');
          break;
        case "firstwords":
          $("#story_firstwords").val(wizardstr).trigger('input');
          break;
        case "char_outfit":
          $("#char_outfit").val(wizardstr).trigger('input');
          break;
        case "user_persona":
          $("#user_persona").val(wizardstr).trigger('input');
          break;
        case "chat_bg":
          $("#chat_bg").val(wizardstr).trigger('input');
          break;
        case "story_intro":
          $("#story_intro").val(wizardstr).trigger('input');
          break;
        case "preview_createchar":
          //update char preview image
          $("#createchar_charlooks").find(".createchar_preview .content").html("");
          $("#createchar_charlooks").find(".createchar_preview").css({ "background-image": "url(" + wizardstr_rawdata + ")" });
          gsap.from($("#createchar_charlooks").find(".createchar_preview"), { duration: 0.3, backgroundSize: "140%", });
          break;
        case "after_char_saved":
          //update char preview image and refresh page
          if (wizardstr_rawdata == "success") {
            alert("Character saved successfully");
            toggleInputs(true);
            location.reload();
          } else {
            alert(`Operation failed, feedback:\n${wizardstr_rawdata}`);
            toggleInputs(true);
          }
          break;
      }

    }
    function languageSwitchUpdate(serverData) {
      let translated_language_data = serverData.data["translated_language_data"];
      console.log(translated_language_data);
      // Parse the translated language data
      let parsedData = JSON.parse(translated_language_data);

      // Update the languageData ref in Vue
      vm.languageData = parsedData;

      // Force Vue to re-render
      vm.$forceUpdate();

      // Update the language switch UI
      // $('#language_switch').attr('data-value', parsedData.language);

      console.log("Language data updated successfully");
    }
    function storyIntroUpdate(serverData) {
      let translated_story_intro_data = serverData.data["translated_story_intro_data"];
      let aiRoleId = serverData.data["aiRoleId"];
      console.log(translated_story_intro_data);
      // Parse the translated story intro data
      let parsedData = JSON.parse(translated_story_intro_data);
      vm.updateStoryIntro(parsedData, aiRoleId);

    }
    function start_chat() {
      console.log($('#language_switch').attr('data-value'));
      if (login_status) {
        var form = $("<form></form>");
        form.attr("method", "post");
        form.attr("action", "/enter_room");
        let is_live_char = $('#live_char_switch').attr('data-value');
        if (!is_live_char) {
          is_live_char = false;
        }
        var fields = {
          username: userdata["username"],
          nickname: userdata["nickname"],
          gender: userdata["gender"],
          avatar: userdata["avatar"],
          facelooks: JSON.stringify(userdata["facelooks"]),
          credits: userdata["credits"],
          ai_role_name: ai_role_name,
          ainame: ainame,
          story_name: story_name,
          intro_text: intro_text,
          is_uncensored: is_uncensored,
          is_live_char: is_live_char,
          language: $('#language_switch').attr('data-value'),
          clientID: clientID,
        };

        $.each(fields, function (key, value) {
          var input = $('<input type="hidden" />');
          input.attr("name", key);
          input.val(value);
          form.append(input);
        });

        $(document.body).append(form);

        form.submit();
      } else {
        toggle_forms("login");
      }
    }
    //Textarea auto height functions
    function autoExpand(textarea) {
      textarea.style.height = 'auto'; // Reset the height
      textarea.style.height = textarea.scrollHeight + 'px'; // Set the height to the scroll height
    }
    //DOM loaded

    /** Event binding Section **/
    $("textarea").each(function () {
      $(this).on('input', function () {
        autoExpand(this); // Adjust height on input
      });
    });
    //Textarea auto indent functions
    $('textarea').on('keydown', function (event) {
      if (event.key === 'Enter') {
        const textarea = this;
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const value = textarea.value;

        const currentLine = value.substring(0, start).split('\n').pop();
        const indent = currentLine.match(/^\s*/)[0];

        const newValue = value.substring(0, start) + '\n' + indent + value.substring(end);
        textarea.value = newValue;

        textarea.selectionStart = textarea.selectionEnd = start + 1 + indent.length;
        autoExpand(textarea);
        event.preventDefault();
      }
    });

    //edit menu
    $(".profile_submenu").on("click", (e) => {
      let target = $(e.target).data("endpoint");
      if (target == "editprofile") {
        toggle_forms("editprofile");
      }
      if (target == "createchar") {
        toggle_forms("createchar");
      }
    });
    $(".user_profile_edit_menu")
      .find("svg")
      .on("click", () => {
        $(".user_profile_drop_menu").toggle();
        event.stopPropagation();
      });

    $(document).on("click", (e) => {
      let et = $(e.target);
      if (
        !et.closest(".user_profile_drop_menu").length &&
        $(".user_profile_drop_menu").is(":visible")
      ) {
        $(".user_profile_drop_menu").hide();
      }
    });

    //role list constructor


    //button event functions

    let btn_logout = $("#btn_logout");
    let btn_signup = $("#btn_signup");
    let btn_login = $("#btn_login");
    btn_signup.on("click", function () {
      toggle_forms("signup");
    });
    btn_login.on("click", function () {
      toggle_forms("login");
    });
    btn_logout.click(logout);

    let btn_signup_form_close = $("#btn_signup_form_close");
    let btn_login_form_close = $("#btn_login_form_close");
    let btn_edit_form_close = $("#btn_profile_form_close");
    let btn_character_form_close = $("#btn_character_form_close");
    let btn_role_intro_form_close = $("#btn_role_intro_form_close");
    btn_signup_form_close.on("click", function () {
      toggle_forms("close");
    });
    btn_login_form_close.on("click", function () {
      toggle_forms("close");
    });
    btn_edit_form_close.on("click", function () {
      toggle_forms("close");
    });
    btn_character_form_close.on("click", function () {
      toggle_forms("close");
    });
    btn_role_intro_form_close.on("click", function () {
      toggle_forms("close");
    });

    let btn_signup_submit = $("#btn_signup_submit");
    let btn_login_submit = $("#btn_login_submit");
    let btn_start_chat = $("#btn_start_chat");
    let btn_edit_profile_submit = $("#btn_edit_submit");
    let btn_avatar_preview_signup = $("#btn_avatar_preview_signup");
    let btn_avatar_preview_edit = $("#btn_avatar_preview_edit");
    let btn_char_persona_wizard = $("#btn_char_persona_wizard");
    let btn_char_looks_wizard = $("#btn_char_looks_wizard");
    let btn_char_outfit_wizard = $("#btn_char_outfit_wizard");
    let btn_user_persona_wizard = $("#btn_user_persona_wizard");
    let btn_prologue_wizard = $("#btn_prologue_wizard");
    let btn_story_intro_wizard = $("#btn_story_intro_wizard");
    let btn_chapters_wizard = $("#btn_chapters_wizard");
    let btn_chat_bg_wizard = $("#btn_chat_bg_wizard");
    let btn_firstwords_wizard = $("#btn_firstwords_wizard");
    let btn_createchar_preview = $("#btn_createchar_preview");
    let btn_character_submit = $("#btn_character_submit");
    btn_signup_submit.on("click", sign_up);
    btn_login_submit.on("click", login);
    btn_start_chat.on("click", start_chat);
    btn_start_chat.hover(function () {
      $(this).find("#icon_start_chat").attr('fill', '#ffffff');
    }, function () {
      $(this).find("#icon_start_chat").attr('fill', '#280149');
    });
    btn_edit_profile_submit.on('click', profile_submit);
    btn_character_submit.on('click', character_submit);
    btn_avatar_preview_signup.on('click', function () {
      preview_avatar("signup");
    });
    btn_avatar_preview_edit.on('click', function () {
      preview_avatar("edit");
    });
    btn_createchar_preview.on('click', function () {
      preview_createchar();
    });
    //wizard buttons
    btn_char_persona_wizard.on('click', function () {
      createchar_wizard("char_persona");
    });
    btn_char_looks_wizard.on('click', function () {
      createchar_wizard("char_looks");
    });
    btn_char_outfit_wizard.on('click', function () {
      createchar_wizard("char_outfit");
    });
    btn_user_persona_wizard.on('click', function () {
      createchar_wizard("user_persona");
    });
    btn_chat_bg_wizard.on('click', function () {
      createchar_wizard("chat_bg");
    });
    btn_prologue_wizard.on('click', function () {
      createchar_wizard("prologue");
    });
    btn_story_intro_wizard.on('click', function () {
      createchar_wizard("story_intro");
    });
    btn_chapters_wizard.on('click', function () {
      createchar_wizard("chapters");
    });
    btn_firstwords_wizard.on('click', function () {
      createchar_wizard("firstwords");
    });
    //background music on
    // let playAttempt = setInterval(() => {
    //   $("#bg_music")[0]
    //     .play()
    //     .then(() => {
    //       clearInterval(playAttempt);
    //     })
    //     .catch((error) => {
    //       console.log("Unable to play the music, User has not interacted yet.");
    //     });
    // }, 2000);

    //password view switcher
    let icon_pwd_types = $(".pwd_type");
    icon_pwd_types.each(function () {
      $(this).click(function () {
        let labelFor = $(this).closest("label").attr("for");
        if ($("#" + labelFor).attr("type") == "password") {
          $("#" + labelFor).attr("type", "text");
          $(this).html(
            "<path d='M3 13C6.6 5 17.4 5 21 13' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17C10.3431 17 9 15.6569 9 14C9 12.3431 10.3431 11 12 11C13.6569 11 15 12.3431 15 14C15 15.6569 13.6569 17 12 17Z' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path>"
          );
        } else {
          $("#" + labelFor).attr("type", "password");
          $(this).html(
            "<path d='M19.5 16L17.0248 12.6038' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17.5V14' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M4.5 16L6.96895 12.6124' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M3 8C6.6 16 17.4 16 21 8' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path>"
          );
        }
      });
    });

    //char hair style
    function changeHairStyle(e, targetSelector) {
      let hairStyle = $(e.target);
      let selectedHairStyle = hairStyle.val();
      let hairColorSelect = $(targetSelector);
      if (selectedHairStyle == "Bald") {
        hairColorSelect.html('<option value="">None</option>');
      } else {
        hairColorSelect.empty();
        let $options = $(
          "<option value='Black'>Black</option>" +
          "<option value='Blond'>Blond</option>" +
          "<option value='Silver'>Silver</option>" +
          "<option value='Brown'>Brown</option>" +
          "<option value='Red'>Red</option>"
        );
        hairColorSelect.append($options);
      }
    }
    //change beard
    function changeBeard(e, targetSelector) {
      let gender = $(e.target);
      let selectedGender = gender.val();
      let beardSelect = $(targetSelector);
      if (selectedGender == "female") {
        beardSelect.html('<option value="">None</option>');
      } else {
        beardSelect.empty();
        let $options = $(
          "<option value='' >None</option>" +
          "<option value='Big beard' >Big beard</option>" +
          "<option value='Sideburns'>Sideburns</option>" +
          "<option value='Goatee'>Goatee</option>" +
          "<option value='Small beard'>Small beard</option>" +
          "<option value='wizard beard'>wizard beard</option>"
        );
        beardSelect.append($options);
      }
    }

    $("#sign_char_hair_style").on("change", (e) =>
      changeHairStyle(e, $("#sign_char_hair_color"))
    );
    $("#edit_char_hair_style").on("change", (e) =>
      changeHairStyle(e, $("#edit_char_hair_color"))
    );
    $("input[name='sign_gender']").on("change", (e) =>
      changeBeard(e, $("#sign_char_beard"))
    );
    $("input[name='edit_gender']").on("change", (e) =>
      changeBeard(e, $("#edit_char_beard"))
    );

    /** Cookies and Sockets**/
    //Setting and Process Cookies
    var userDataField = getCookie("userData");
    if (userDataField) {
      $(".top_buttons").hide();
      userdata = JSON.parse(userDataField);
      console.log(userdata);
      update_profile_bar(userdata);
      update_edit_form(userdata);
      $(".user_profile").css("display", "flex");
      $(".user_profile_edit_menu").css("display", "flex");
      gsap.from($(".user_profile"), { duration: 3, opacity: 0 });
      login_status = true;
    } else {
      console.log("User not login");
    }

    //WebSocket Process
    let websocket;
    let retryCount = 0;
    const maxRetryLimit = 10;
    let retryDelay = 1000;
    const maxRetryDelay = 60000;

    function connectWebSocket() {
      const wsUrl = `//${window.location.host}/ws/${clientID}`
      ws = new WebSocket(wsUrl.replace(/^\/\//, window.location.protocol === 'https:' ? 'wss://' : 'ws://'));
      ws.onopen = (e) => {
        retryCount = 0;
        retryDelay = 1000;
        console.log("Connected to Websocket...");
        let querydata = {
          from: clientID,
          msg: {
            message: "CyberChat Index Page Connected",
            status: 200
          }
        }
        ws.send(wsData('connect to server', querydata))
      }
      //process server feedback
      ws.onmessage = (e) => {
        let serverData = JSON.parse(e.data);
        console.log(serverData.wsevent_server);
        switch (serverData.wsevent_server) {
          case "after_connect":
            console.log(serverData.data.message.msg.data);
            break;
          case "status_from_server":
            ProcessServerStatus(serverData);
            break;
          case "preview_avatar_result":
            changePreviewAvatar(serverData);
            break;
          case "createchar_wizard_result":
            createcharWizardUpdate(serverData);
            break;
          case "preview_char_result":
            createcharWizardUpdate(serverData);
            break;
          case "save_character_result":
            createcharWizardUpdate(serverData);
            break;
          case "language_switch_result":
            languageSwitchUpdate(serverData);
            break;
          case "translate_story_intro_result":
            storyIntroUpdate(serverData);
            break;
        }

      }
      ws.onerror = (e) => {
        console.log("Websocket error observed: " + e)
      }
      ws.onclose = (e) => {
        console.log("Connect closed");
        let closeReason = e.code === 1006 ? ", Server Shutdown ?" : ", Reason: " + e.reason
        console.log("Code: " + e.code + closeReason);
        if (retryCount < maxRetryLimit) {
          setTimeout(reconnect, retryDelay);
          retryDelay = Math.min(maxRetryDelay, retryDelay * 2); // 延迟翻倍，但不超过最大延迟
        }

      }

    }
    function reconnect() {
      retryCount++;
      console.log(`Attempting to reconnect... (Attempt: ${retryCount})`);
      connectWebSocket();
    }
    $(document).ready(function () {
      connectWebSocket();
    });

  </script>
  <!-- create UI-->
  <script type="module">
    import { VolumeKnob, SwitchUI, SelectorUI } from '/static/js/ui.js';
    const knobElement = document.getElementById('knob');
    const audioElement = document.getElementById('bg_music');
    const liveCharSwitch = document.getElementById('live_char_switch');
    const languageSwitch = document.getElementById('language_switch');
    const liveCharSwitchUI = new SwitchUI({
      element: liveCharSwitch,
      onColor: '#462256',
      offColor: '#3d3d3d',
      width: 40,
      height: 20,
      value: false
    });
    const volumeKnob = new VolumeKnob({
      element: knobElement,
      minValue: 0,
      maxValue: 1,
      stepValue: 0.01,
      width: 20,
      height: 20,
      backgroundImage: '', // 或者使用 base64 URI
      backgroundColor: '#462256',
      knobHandlerColor: '#ffffff',
      audioElement: audioElement,
      initialVolume: 0.5,
      initialMuted: true
    });

    // 监听值变化
    $(knobElement).on('change', (event, value) => {
      console.log('Current volume:', value);
    });
    const languageSwitchUI = new SelectorUI({
      element: languageSwitch,
      width: 100,
      height: 24,
    });
    languageSwitchUI.setItem(JSON.parse('{{ localeLanguage | tojson | safe }}'))
    $(languageSwitch).on('change', (event, value) => {
      // console.log('Current language:', value);
      // let querydata = {
      //   language: value,
      //   task: "language_switch",
      // };
      // ws.send(wsData("language_switch", querydata));
      window.location.href = '/' + value;
    });
  </script>
  <!-- End of Script Block -->
</body>

</html>