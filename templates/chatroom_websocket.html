<!doctype html>
<html>

<head>
  <link rel="manifest" href="/static/manifest/manifest.json" />
  <link rel="icon" href="/static/images/icon.png" />
  <link rel="stylesheet" type="text/css" href="/static/css/style.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/chat.css" />
  <link rel="stylesheet" type="text/css" href="/static/css/jquery-ui.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=Philosopher&display=swap" rel="stylesheet" />
  <title>{{ainame}}</title>
</head>
<!--HTML BODY CODE-->

<body>
  <div class="flexPage" id="chatroom">
    <div class="comic-area">
      <div id="char-wrapper" class="border-wrapper wrapper-char-fullscreen">
        <div id="char-bgpic" class="char_bg_fullscreen"></div>
      </div>
      <div id="user-wrapper" class="border-wrapper wrapper-user-fullscreen">
        <div id="user-bgpic" class="user_bg"></div>
      </div>
      <div id="char-dynpic-wrapper" class="border-wrapper wrapper-char-dynpic-fullscreen">
        <div id="char-dynpic" class="char_dynmicpic_bg"></div>
      </div>
      <div class="comic_msg_holder_char" id="comic-msg-holder-char">
        <div class="comic_msgbox_arrow_char"></div>
        <div id="msg_box_comic_char" class="comic_msgbox"></div>
        <div id="voiceController_comic" class="voiceController">
          Play Voice
        </div>
        <div class="msg-drag-handle">
          <svg width="18px" height="18px" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none"
            stroke="#ffffff" stroke-width="3.5">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
              <line x1="32" y1="8" x2="32" y2="56"></line>
              <line x1="56" y1="32" x2="8" y2="32"></line>
              <polyline points="40 16 32 8 24 16"></polyline>
              <polyline points="24 48 32 56 40 48"></polyline>
              <polyline points="48 40 56 32 48 24"></polyline>
              <polyline points="16 24 8 32 16 40"></polyline>
            </g>
          </svg>
        </div>
      </div>
      <div class="comic_msg_holder_user" id="comic-msg-holder-user">
        <div class="comic_msgbox_arrow_user"></div>
        <div id="msg_box_comic_user" class="comic_msgbox"></div>
        <div class="msg-drag-handle">
          <svg width="18px" height="18px" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none"
            stroke="#ffffff" stroke-width="3.5">
            <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
            <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
            <g id="SVGRepo_iconCarrier">
              <line x1="32" y1="8" x2="32" y2="56"></line>
              <line x1="56" y1="32" x2="8" y2="32"></line>
              <polyline points="40 16 32 8 24 16"></polyline>
              <polyline points="24 48 32 56 40 48"></polyline>
              <polyline points="48 40 56 32 48 24"></polyline>
              <polyline points="16 24 8 32 16 40"></polyline>
            </g>
          </svg>
        </div>
      </div>
    </div>
    <div id="setTings" class="chatSetting">
      <div class="chatSetUpBtn">
        <svg width="24px" height="24px" stroke-width="1.5" viewBox="0 0 24 24" fill="none"
          xmlns="http://www.w3.org/2000/svg" color="#ffffff">
          <path
            d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
            stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
          <path
            d="M19.6224 10.3954L18.5247 7.7448L20 6L18 4L16.2647 5.48295L13.5578 4.36974L12.9353 2H10.981L10.3491 4.40113L7.70441 5.51596L6 4L4 6L5.45337 7.78885L4.3725 10.4463L2 11V13L4.40111 13.6555L5.51575 16.2997L4 18L6 20L7.79116 18.5403L10.397 19.6123L11 22H13L13.6045 19.6132L16.2551 18.5155C16.6969 18.8313 18 20 18 20L20 18L18.5159 16.2494L19.6139 13.598L21.9999 12.9772L22 11L19.6224 10.3954Z"
            stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </div>
      <div id="settingOption" class="settingOpt">
        <div class="switchUI_holder">
          <input type="checkbox" id="comicMode" style="display: none;" />
          <div id="comicMode_switch"></div>
          <span class="smallFonts" v-text="currentLanguage.Comic_Mode"></span>
        </div>
        <div class="UI_flex_row">
          <div id="language_switch"></div>
        </div>
        <div class="UI_flex_row">
          <div id="model_switch"></div>
        </div>
        <div class="UI_flex_row">
          <div id="instr_switch"></div>
        </div>
        <div class="UI_flex_row">
          <div id="sd_switch"></div>
        </div>
        <div class="UI_flex_row">
          <div>
            <svg width="15px" height="15px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
              stroke="">
              <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
              <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
              <g id="SVGRepo_iconCarrier">
                <path
                  d="M13.75 2C13.75 1.58579 13.4142 1.25 13 1.25C12.5858 1.25 12.25 1.58579 12.25 2V14.5359C11.4003 13.7384 10.2572 13.25 9 13.25C6.37665 13.25 4.25 15.3766 4.25 18C4.25 20.6234 6.37665 22.75 9 22.75C11.6234 22.75 13.75 20.6234 13.75 18V6.243C14.9875 7.77225 16.8795 8.75 19 8.75C19.4142 8.75 19.75 8.41421 19.75 8C19.75 7.58579 19.4142 7.25 19 7.25C16.1005 7.25 13.75 4.8995 13.75 2Z"
                  fill="#ffffff"></path>
              </g>
            </svg>
          </div>
          <div id="knob" class="knob"></div>
        </div>
      </div>

    </div>
    <div id="ai_intro">
      <div class="ai_name">{{ainame}}</div>
      <div class="prologue_button">
        <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M4 19V6.2C4 5.0799 4 4.51984 4.21799 4.09202C4.40973 3.71569 4.71569 3.40973 5.09202 3.21799C5.51984 3 6.0799 3 7.2 3H16.8C17.9201 3 18.4802 3 18.908 3.21799C19.2843 3.40973 19.5903 3.71569 19.782 4.09202C20 4.51984 20 5.0799 20 6.2V17H6C4.89543 17 4 17.8954 4 19ZM4 19C4 20.1046 4.89543 21 6 21H20M9 7H15M9 11H15M19 17V21"
            stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </div>
    </div>
    <div id="intro_prologue_area">
      <div class="intro_prologue">Prologue Texts</div>
    </div>
    <div class="free-space"></div>
    <div id="holder_box">
      <div id="drag-handle"></div>
      <div id="message_box"></div>
      <div id="inputArea">
        <div class="messageInputBox">
          <div class="input_area">
            <div class="ai_icon"></div>
            <textarea type="text" id="messageToSend" rows="1"></textarea>
            <ul id="cmd_dropdownMenu"></ul>
          </div>
          <div id="submit" class="msgInput">
            <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
              color="#a25aff" stroke-width="1.5">
              <g clip-path="url(#clip0_4086_8473)">
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M1.84647 7.15123C1.54566 7.21608 1.31498 7.45811 1.26464 7.7617C1.2143 8.06528 1.35452 8.36881 1.6183 8.52729L8.13474 12.4421L14.3544 8.08705C14.6938 7.84947 15.1614 7.93193 15.399 8.27123C15.6366 8.61054 15.5541 9.0782 15.2148 9.31578L8.99537 13.6707L10.4455 21.1339C10.5042 21.436 10.7415 21.6715 11.044 21.7281C11.3465 21.7846 11.6528 21.6506 11.8166 21.3901L22.7919 3.93893C22.9526 3.68349 22.9445 3.35665 22.7714 3.10947C22.5983 2.86228 22.294 2.7429 21.999 2.80649L1.84647 7.15123Z"
                  fill="#a25aff"></path>
              </g>
              <defs>
                <clipPath id="clip0_4086_8473">
                  <rect width="24" height="24"></rect>
                </clipPath>
              </defs>
            </svg>
          </div>
          <div id="recordTimer" class="recordTimer">
            <svg width="34" height="34">
              <circle class="progress-ring__circle-progress" stroke="#611997" stroke-width="2" fill="transparent" r="16"
                cx="17" cy="17" />
            </svg>
            <div id="recordButton" class="recordButton">
              <svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                color="#ffffff" stroke-width="1.5">
                <rect x="9" y="2" width="6" height="12" rx="3" fill="#ffffff" stroke="#ffffff" stroke-width="1.5"
                  stroke-width="1.5"></rect>
                <path d="M5 10V11C5 14.866 8.13401 18 12 18V18V18C15.866 18 19 14.866 19 11V10" stroke="#ffffff"
                  stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 18V22M12 22H9M12 22H15" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
            </div>
          </div>
        </div>
        <div class="messageOptions">
          <div class="ButtonsGroup">
            <button id="regenerate" v-text="currentLanguage.Regenerate" class="ButtonUI"></button>
            <button id="restart" v-text="currentLanguage.Restart" class="ButtonUI"></button>
            <button id="exitchat" v-text="currentLanguage.Exit" class="ButtonUI"></button>
            <div id="chat-history-buttons" class="ButtonsGroup">
              <button id="load-chat-history" v-text="currentLanguage.Load_Chat_History"
                class="ButtonUI smallFonts"></button>
              <button id="save-chat-history" v-text="currentLanguage.Save_Chat_History"
                class="ButtonUI smallFonts"></button>
            </div>
          </div>
          <div class="sub_options">
            <div class="switchUI_holder">
              <div id="messageBox_switch"></div>
              <span class="smallFonts" v-text="currentLanguage.Message_Box"></span>
            </div>
            <div class="switchUI_holder">
              <div id="voice_switch"></div>
              <span class="smallFonts" v-text="currentLanguage.Voice_Output"></span>
            </div>
            <div class="switchUI_holder">
              <div id="dynimage_switch"></div>
              <span class="smallFonts" v-text="currentLanguage.Dynamic_Image"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="templates_box" style="display: none">
      <div id="msg_container">
        <div class="avatar"></div>
        <div class="message"></div>
      </div>
    </div>
    <div id="bg_music_player" style="display: none;">
      <audio id="bg_music" loop></audio>
    </div>
    <div class="overlay" id="overLayer">
      <div class="overlay-content">
        <div class="loadingSvg">
          <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="#FFFFFF">
            <path
              d="M10.14,1.16a11,11,0,0,0-9,8.92A1.59,1.59,0,0,0,2.46,12,1.52,1.52,0,0,0,4.11,10.7a8,8,0,0,1,6.66-6.61A1.42,1.42,0,0,0,12,2.69h0A1.57,1.57,0,0,0,10.14,1.16Z">
              <animateTransform attributeName="transform" type="rotate" dur="0.75s" values="0 12 12;360 12 12"
                repeatCount="indefinite" />
            </path>
          </svg>
        </div>
        <div class="loadingText"></div>
        <div class="loadingText_Percentage"></div>
      </div>
      <div class="overlay-dynpic">
        <div id="closePreview">Close Preview</div>
      </div>
    </div>
  </div>

  <!-- Script Block -->
  <script src="/static/js/gsap.min.js"></script>
  <script src="/static/js/marked.js"></script>
  <script src="/static/js/jquery-3.6.0.min.js"></script>
  <script src="/static/js/jquery-ui.js"></script>
  <script src="/static/js/vue.global.js"></script>

  <!--Core functions-->
  <script type="module" charset="utf-8">
    //Vue block
    let commandInputHandler
    const { ref, computed, nextTick, watch, onMounted } = Vue
    const app = Vue.createApp({
      delimiters: ['${', '}'],
      setup() {
        const languageData = ref(JSON.parse('{{ language_Data | tojson | safe }}'))
        console.log('languageData:', languageData.value)
        const currentLanguage = computed(() => {
          return languageData.value.ChatRoomPage
        })
        watch(currentLanguage, (newVal, oldVal) => {
          console.log('Current language:', newVal)
        }, { immediate: true })

        const language_switch_result = (serverData) => {
          const translated_language_data = JSON.parse(serverData.data.translated_language_data);
          languageData.value = translated_language_data
          console.log('translated_language_data:', translated_language_data)
          console.log('languageData.value:', languageData.value)
          console.log('languageData.value.ChatRoomPage.Input_Hint:', languageData.value.ChatRoomPage.Input_Hint)
          commandInputHandler.setDefaultText(languageData.value.ChatRoomPage.Input_Hint)
          document.getElementById('messageToSend').blur();
        }
        onMounted(() => {

        })
        return {
          currentLanguage,
          language_switch_result
        }
      }
    })
    const vm = app.mount('#chatroom')

//set up UI components
    import { msTTS } from '/static/js/tts.js';
    const msttser = new msTTS();
    import { CommandInputHandler } from '/static/js/input_control.js';
    import { AudioRecorder } from '/static/js/AudioRecorder.js';
    import { VolumeKnob, SwitchUI, SelectorUI } from '/static/js/ui.js';
    const knobElement = document.getElementById('knob');
    const audioElement = document.getElementById('bg_music');
    const comicMode_switch = document.getElementById('comicMode_switch');
    const messageBox_switch = document.getElementById('messageBox_switch');
    const voiceswitcher = document.getElementById('voice_switch');
    const dynimageSwitcher = document.getElementById('dynimage_switch');
    const languageSwitch = document.getElementById('language_switch');
    const modelSwitch = document.getElementById('model_switch');
    const instrSwitch = document.getElementById('instr_switch');
    const sdSwitch = document.getElementById('sd_switch');
    const switchUI_onColor = 'linear-gradient(45deg, rgba(52, 7, 104, 0.8), rgba(106, 36, 117, 0.8))';
    const switchUI_offColor = '#3d3d3d';
    const comicMode_switchUI = new SwitchUI({
      element: comicMode_switch,
      onColor: switchUI_onColor,
      offColor: switchUI_offColor,
      width: 40,
      height: 20,
      value: false
    });
    const messageBox_switchUI = new SwitchUI({
      element: messageBox_switch,
      onColor: switchUI_onColor,
      offColor: switchUI_offColor,
      width: 40,
      height: 20,
      value: true
    });
    const voiceswitcherUI = new SwitchUI({
      element: voiceswitcher,
      onColor: switchUI_onColor,
      offColor: switchUI_offColor,
      width: 40,
      height: 20,
      value: false
    });
    const dynimageSwitcherUI = new SwitchUI({
      element: dynimageSwitcher,
      onColor: switchUI_onColor,
      offColor: switchUI_offColor,
      width: 40,
      height: 20,
      value: false
    });


    const languageSwitchUI = new SelectorUI({
      element: languageSwitch,
      width: 100,
      height: 24,
    });
    const modelSwitchUI = new SelectorUI({
      element: modelSwitch,
      width: 100,
      height: 24,
      titleAlign: 'flex-start',
      itemAlign: 'flex-start',
      itemList: [
        {
          name: 'Model',
          value: null,
        }
      ]
    });
    const instrSwitchUI = new SelectorUI({
      element: instrSwitch,
      width: 100,
      height: 24,
      titleAlign: 'flex-start',
      itemAlign: 'flex-start',
      itemList: [
        {
          name: 'instruction',
          value: null
        }
      ]
    });
    const sdSwitchUI = new SelectorUI({
      element: sdSwitch,
      width: 100,
      height: 24,
      titleAlign: 'flex-start',
      itemAlign: 'flex-start',
      itemList: [
        {
          name: 'SD model',
          value: null
        }
      ]
    });
    $(modelSwitch).on('change', (event, value) => {
      console.log('Current model:', value);
      var querydata = {
        model: value,
        conid: conid,
      };
      ws.send(wsData('change_model', querydata));
      toggleInputs(false);
    });
    $(sdSwitch).on('change', (event, value) => {
      console.log('Current SD Model:', value);
      var querydata = {
        SD_Model: value,
        conid: conid,
      };
      ws.send(wsData('change_SD_Model', querydata));
      toggleInputs(false);
    });
    $(instrSwitch).on('change', (event, value) => {
      console.log('Current Instruction:', value);
      var querydata = {
        instruction: value,
        conid: conid,
      };
      ws.send(wsData('change_instruction', querydata));
      toggleInputs(false);
    });

    languageSwitchUI.setItem('{{language}}');
    console.log('Current language:', $(languageSwitch).attr('data-value'));

    $(languageSwitch).on('change', (event, value) => {
      console.log('Current language:', $(languageSwitch).attr('data-value'));
      let querydata = {
        language: value,
      };
      ws.send(wsData('language_switch', querydata));
    });

    $(messageBox_switch).on('change', (event, value) => {
      if (value && !comicMode_switchUI.getValue()) {
        $('#message_box').css('display', 'flex');
        $('#holder_box').css('height', '70vh');
        $('#holder_box').css('justify-content', 'space-between');
        updateScroll();
      } else {
        let message_box_height = $('#message_box').height();
        //the height of the holder_box is it's original height minus the height of the message_box
        $('#holder_box').css('height', $('#holder_box').height() - message_box_height + 'px');
        $('#holder_box').css('justify-content', 'flex-end');
        $('#message_box').css('display', 'none');
        updateScroll();
      }
      console.log('Current messageBox_switch:', value);
    });

    $(comicMode_switch).on('change', (event, value) => {
      console.log('Current comicMode_switch:', value);
      if (!value) {
        $(messageBox_switch).css('pointer-events', 'auto');
        $(messageBox_switch).css('opacity', '1');
        $(messageBox_switch).next('span').css('opacity', '1');
        messageBox_switchUI.setValue(true);
      } else if (value) {
        $(messageBox_switch).css('pointer-events', 'none');
        $(messageBox_switch).css('opacity', '0.2');
        $(messageBox_switch).next('span').css('opacity', '0.2');
        if (messageBox_switchUI.getValue()) {
          messageBox_switchUI.setValue(false);
        }
      }
      dispModeSwitch();
    });

    $(voiceswitcher).on('change', (event, value) => {
      console.log('Current voice_switch:', value);
      switchVoiceController();
    });
    $(dynimageSwitcher).on('change', (event, value) => {
      console.log('Current dynimage_switch:', value);
      const all_dynamicPicBox = document.querySelectorAll('.dynamicPicBox');
      if (all_dynamicPicBox.length === 0) {
        return;
      } else {
        if (value) {
          all_dynamicPicBox.forEach(dynamicPicBox_element => {
            dynamicPicBox_element.style.display = 'block';
          });
        } else {
          all_dynamicPicBox.forEach(dynamicPicBox_element => {
            dynamicPicBox_element.style.display = 'none';
          });
        }
      }
    });
    const volumeKnob = new VolumeKnob({
      element: knobElement,
      minValue: 0,
      maxValue: 1,
      stepValue: 0.01,
      width: 20,
      height: 20,
      backgroundImage: '', // 或者使用 base64 URI
      backgroundColor: '#462256',
      knobHandlerColor: '#ffffff',
      audioElement: audioElement,
      initialVolume: 0.5,
      initialMuted: true
    });

    $(knobElement).on('change', (event, value) => {
      console.log('Current volume:', value);
    });
    marked.use({
      mangle: false,
      headerIds: false,
    });
//set up global variables
    var ws = Object;
    const clientID = '{{clientID}}';
    const timestamp = '{{ timestamp }}';
    console.log('Client ID: ' + clientID);
    var username = '{{nickname}}';
    var user_sys_name = '{{username}}';
    var user_avatar = '{{avatar}}';
    var user_facelooks = JSON.parse('{{ facelooks | safe }}');
    var usergender = '{{gender}}';
    var credits = '{{credits}}';
    var ai_role_name = '{{ai_role_name}}';
    var ainame = '{{ainame}}';
    var Prologue = ''; 
    var ai_is_uncensored = '{{is_uncensored}}';
    var ai_is_live_char = JSON.parse('{{ is_live_char | tojson }}');
    var conid = '{{clientID}}';
    var bkimg_path =
      '/static/images/avatar/' +
      ai_role_name +
      '/background.webp?nocache=' +
      timestamp;
    var ai_avatar_path =
      '/static/images/avatar/' +
      ai_role_name +
      '/none.webp?nocache=' +
      timestamp;
    var currentIndex = 0;
    var userLastMsg = '';
    var ai_avatar = '';
    var user_looks = '';
    var initialstate = true;
    var holdbox_origin_height;
    var streamingBuffer = [];
    var prompt_variable_str;
    var micstate = true;

    var suggestions = JSON.parse('{{ suggestions | tojson | safe }}');
    for (var key in suggestions) {
      if (suggestions[key].hasOwnProperty('svg')) {
        var svg_data = suggestions[key].svg;
        var decoded_svg = atob(svg_data);
        suggestions[key].svg = decoded_svg;
      }
    }

    function wsData(wsevent, querydata) {
      let messagebody = {
        wsevent_client: wsevent,
        data: querydata,
      };
      return JSON.stringify(messagebody);
    }

    function Module_timer() {
      var timer;
      function SORTimer(selector, fadeouttimes, keeptimes) {
        if (timer) {
          clearTimeout(timer);
        }
        timer = setTimeout(function () {
          $(selector).fadeOut(fadeouttimes);
        }, keeptimes);
      }
      return {
        TimerTrigger: SORTimer,
      };
    }
    var divTimer = Module_timer();

    function toggleInputs(input_switcher) {
      if (input_switcher == true) {
        $('button, input, select, textarea').each(function () {
          $(this).prop('disabled', false).css('opacity', 1);
          if ($(this).is('button')) {
            $(this).css('pointer-events', 'auto');
          }
        });
        $('#messageToSend').focus();
      } else {
        $('button, input, select, textarea').each(function () {
          $(this).prop('disabled', true).css('opacity', 0.5);
          if ($(this).is('button')) {
            $(this).css('pointer-events', 'none');
          }
        });
      }
    }


    function getWindowSize() {
      var width =
        window.innerWidth ||
        document.documentElement.clientWidth ||
        document.body.clientWidth;
      var height =
        window.innerHeight ||
        document.documentElement.clientHeight ||
        document.body.clientHeight;
      var ratio = width / height;
      console.log(
        'width: ' + width + ' height: ' + height + ' ratio: ' + ratio,
      );
      return { width: width, height: height, ratio: ratio };
    }

    function exitChat() {
      let querydata = {
        conid: conid,
      };
      ws.send(wsData('exit_room', querydata));
    }

    function exitRoomSuccess(msg) {
      if (window.confirm(msg.data['message'])) {
        let localeLanguage = languageSwitchUI.getValue();
        window.location.href = '/' + localeLanguage;
      } else {
      }
    }

    /* Display Mode Switcher Functions */
    function resizeComicLayout() {
      let windowSize = getWindowSize();
      let ratio = windowSize.ratio;
      if (ratio < 1) {
        $('#char-wrapper')
          .removeClass('wrapper-char-fullscreen')
          .addClass('wrapper-char');
        $('#char-bgpic')
          .removeClass('char_bg_fullscreen')
          .addClass('char_bg');
        $('#user-wrapper')
          .removeClass('wrapper-user-fullscreen')
          .addClass('wrapper-user');
        $('#user-bgpic').removeClass('user_bg_horizon').addClass('user_bg');
        $('#char-dynpic-wrapper')
          .removeClass('wrapper-char-dynpic-fullscreen')
          .addClass('wrapper-char-dynpic');
        $('#char-dynpic')
          .removeClass('char_dynmicpic_bg_horizon')
          .addClass('char_dynmicpic_bg');
        $('#comic-msg-holder-char')
          .removeClass('comic_msg_holder_char_horizon')
          .addClass('comic_msg_holder_char');
        $('#comic-msg-holder-user')
          .removeClass('comic_msg_holder_user_horizon')
          .addClass('comic_msg_holder_user');
      } else if (ratio > 1) {
        $('#char-wrapper')
          .removeClass('wrapper-char-fullscreen')
          .addClass('wrapper-char-horizon');
        $('#char-bgpic')
          .removeClass('char_bg_fullscreen')
          .addClass('char_bg_horizon');
        $('#user-wrapper')
          .removeClass('wrapper-user-fullscreen')
          .addClass('wrapper-user-horizon');
        $('#user-bgpic').removeClass('user_bg').addClass('user_bg_horizon');
        $('#char-dynpic-wrapper')
          .removeClass('wrapper-char-dynpic-fullscreen')
          .addClass('wrapper-char-dynpic-horizon');
        $('#char-dynpic')
          .removeClass('char_dynmicpic_bg')
          .addClass('char_dynmicpic_bg_horizon');
        $('#comic-msg-holder-char')
          .addClass('comic_msg_holder_char_horizon')
          .css({
            top: '50%',
            left: '80px',
          });
        $('#comic-msg-holder-user')
          .addClass('comic_msg_holder_user_horizon')
          .css({
            top: '50%',
            left: 'calc(40% + 140px)',
          });
      }
    }

    function dispModeSwitch() {
      if (comicMode_switchUI.getValue()) {
        $('#messageBox_switch_holder').css('display', 'none');
        $('#holder_box').css('--z-index', -1);
        resizeComicLayout();
        gsap.from($('#char-wrapper'), {
          duration: 0.5,
          opacity: 0,
        });
        $('.comic_msg_holder_char').css('display', 'flex');
        if ($('#msg_box_comic_user').html() != '') {
          $('.comic_msg_holder_user').css('display', 'flex');
        }
      } else {
        $('#messageBox_switch_holder').css('display', 'flex');
        $('#char-dynpic-wrapper')
          .removeClass('wrapper-char-dynpic')
          .removeClass('wrapper-char-dynpic-horizon')
          .addClass('wrapper-char-dynpic-fullscreen');
        $('#char-bgpic')
          .removeClass('char_bg')
          .removeClass('char_bg_horizon')
          .addClass('char_bg_fullscreen');
        $('#char-wrapper')
          .removeClass('wrapper-char')
          .removeClass('wrapper-char-horizon')
          .addClass('wrapper-char-fullscreen');
        gsap.from($('#char-wrapper'), {
          duration: 0.5,
          opacity: 0,
        });
        $('#user-wrapper')
          .removeClass('wrapper-user')
          .removeClass('wrapper-user-horizon')
          .addClass('wrapper-user-fullscreen');
        $('.comic_msg_holder_char').fadeOut(200);
        $('.comic_msg_holder_user').fadeOut(200);
        $('#holder_box').css('--z-index', 1);
      }
    }

    /*Audio process assisant functions*/
    function extractLanguageCode(inputString) {
      const parts = inputString.split('_');
      if (parts.length > 1) {
        return parts[0];
      } else {
        return false;
      }
    }

    function base64ToArrayBuffer(base64) {
      const binaryString = atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }

    function base64ToBlob(base64, mimeType) {
      const byteCharacters = atob(base64);
      const byteNumbers = new Array(byteCharacters.length);
      for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
      }
      const byteArray = new Uint8Array(byteNumbers);
      return new Blob([byteArray], { type: mimeType });
    }


    let mediaSourceList = {};
    let sourceBufferList = {};
    let isBuffering = false;
    let audio_buffer = [];
    let isLastChunkReceived = {};

    function addAudioEndedListener(voicePlayerid) {
      const audio = $('#' + voicePlayerid)[0];
      audio.addEventListener('ended', () => {
        console.log('Audio playback ended for', voicePlayerid);
        checkStreamEnd(voicePlayerid);
      });
    }

    function checkStreamEnd(voicePlayerid) {
      if (isLastChunkReceived[voicePlayerid] && audio_buffer.length === 0 && !sourceBufferList[voicePlayerid].updating && mediaSourceList[voicePlayerid].readyState === 'open') {
        mediaSourceList[voicePlayerid].endOfStream();
        console.log('Stream ended for', voicePlayerid);
      }
    }

    function sourceOpen(voicePlayerid) {
      if (!sourceBufferList[voicePlayerid]) {
        sourceBufferList[voicePlayerid] = mediaSourceList[voicePlayerid].addSourceBuffer('audio/mpeg');
        sourceBufferList[voicePlayerid].addEventListener('updateend', () => {
          appendNextBuffer(voicePlayerid);
        });
      }
    }

    function appendNextBuffer(voicePlayerid) {
      if (audio_buffer.length > 0 && !sourceBufferList[voicePlayerid].updating && mediaSourceList[voicePlayerid].readyState === 'open') {
        isBuffering = true;
        console.log('Appending data to SourceBuffer');
        try {
          let audioDataArray = new Uint8Array(base64ToArrayBuffer(audio_buffer.shift()));
          sourceBufferList[voicePlayerid].appendBuffer(audioDataArray);
          let audio = $('#' + voicePlayerid)[0];
          audio.play();

        } catch (e) {
          console.log(e);
          isBuffering = false;
        }

      } else {
        isBuffering = false;
        checkStreamEnd(voicePlayerid);
      }

    }

    function xtts_audio_data(msg) {
      const audioData = msg.data['audio_data'];
      let voicePlayerid = msg.data['voice_uid'];
      let audiomode = msg.data['mode'];
      let audiostatus = msg.data['status'];
      if (audiomode == 'normal') {
        if (audioData) {
          const audioBlob = base64ToBlob(audioData, 'audio/wav');
          const audioUrl = URL.createObjectURL(audioBlob);
          $('#' + voicePlayerid).attr('src', audioUrl);
          $('#' + voicePlayerid).attr('preload', 'auto');
          $('#controller' + voicePlayerid).fadeIn(200);
          $('#controller' + voicePlayerid).css('display', 'flex');
          $('#controller' + voicePlayerid).trigger('click');
          $('#voiceController_comic').css('display', 'flex');
          updateScroll();
        } else {
          console.error('Audio data is not available.');
        }

      } else if (audiomode == 'stream') {
        if (!mediaSourceList[voicePlayerid]) {
          mediaSourceList[voicePlayerid] = new MediaSource();
          mediaSourceList[voicePlayerid].addEventListener('sourceopen', () => {
            sourceOpen(voicePlayerid);
          });

          $('#controller' + voicePlayerid).fadeIn(200);
          $('#controller' + voicePlayerid).css('display', 'flex');
          $('#voiceController_comic').css('display', 'flex');
          $('#' + voicePlayerid).attr('src', URL.createObjectURL(mediaSourceList[voicePlayerid]));
          updateScroll();
          isLastChunkReceived[voicePlayerid] = false;
          addAudioEndedListener(voicePlayerid);
        }


        if (audioData) {
          audio_buffer.push(audioData);
          if (sourceBufferList[voicePlayerid] && !isBuffering) {
            appendNextBuffer(voicePlayerid);
          } else {
            console.log('skipping append');
          }
        } else {
          console.log('Last audio chunk received');
          isLastChunkReceived[voicePlayerid] = true;
          checkStreamEnd(voicePlayerid);
        }
      }
    }


    function transcript_audio_result(msg) {
      console.log(msg);
      toggleInputs(true);
      const transcripted_text = msg.data['transcripted_text'];
      console.log(transcripted_text);
      $("#messageToSend").focus().val(transcripted_text);
      $("#submit").trigger("click");
      let svgicon_normal = `<svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#ffffff" stroke-width="1.5"><rect x="9" y="2" width="6" height="12" rx="3" fill="#ffffff" stroke="#ffffff" stroke-width="1.5" stroke-width="1.5"></rect><path d="M5 10V11C5 14.866 8.13401 18 12 18V18V18C15.866 18 19 14.866 19 11V10" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 18V22M12 22H9M12 22H15" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;
      $("#recordButton").html(svgicon_normal);


    }
    function sentence_completion_result(msg) {
      const sentence_completion_text = msg.data['sentence'];
      console.log(sentence_completion_text);
      toggleInputs(true);
      const textBeforeCursor = $("#messageToSend").val().substring(0, $("#messageToSend").prop("selectionStart"));
      const textAfterCursor = $("#messageToSend").val().substring($("#messageToSend").prop("selectionEnd"));
      const cursorStart = textBeforeCursor.length;
      const cursorEnd = textBeforeCursor.length + sentence_completion_text.length;
      $("#messageToSend").val(textBeforeCursor + sentence_completion_text + textAfterCursor).focus();
      setTimeout(() => {
        $("#messageToSend")[0].setSelectionRange(cursorStart, cursorEnd);
      }, 0);
      autoExpand($('#messageToSend')[0]);
      // $("#submit").trigger("click");
    }

    function genUID(prefix) {
      let uniqueId =
        prefix +
        '-' +
        Date.now() +
        '-' +
        Math.random().toString(36).substr(2, 9);
      return uniqueId;
    }

    function updateScroll() {
      let newScrollHeight = $('#message_box').prop('scrollHeight');
      let newScrollHeightComic = $('#msg_box_comic_char').prop(
        'scrollHeight',
      );
      $('#message_box').scrollTop(newScrollHeight);
      $('#msg_box_comic_char').scrollTop(newScrollHeightComic);
    }

    //code block copy function
    function copyCode(clickedDiv) {
      let $clickdiv = $(clickedDiv);
      let tempHtml = $clickdiv.parent().next().get(0);
      console.log(tempHtml.textContent);
      navigator.clipboard
        .writeText(tempHtml.textContent)
        .then(() => {
          console.log('Text copied to clipboard');
          alert("Code copied to clipboard!");
        })
        .catch((err) => {
          console.error('Could not copy text: ', err);
        });
    }

    //show off dynamic picture
    function hideDynaPic(dynapicDiv) {
      let $dynapicDiv = $(dynapicDiv);
      let $dypic = $dynapicDiv.parent().find('.dynamicPic');
      if ($dypic.is(':visible')) {
        $dypic.toggle('blind');
        let svg =
          "<svg width='24px' height='24px' viewBox='0 0 24 24' stroke-width='1.5' fill='none' xmlns='http://www.w3.org/2000/svg' color='#FFFFFF' ><path d='M19.5 16L17.0248 12.6038' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17.5V14' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M4.5 16L6.96895 12.6124' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M3 8C6.6 16 17.4 16 21 8' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path></svg>";
        $dynapicDiv.find('svg').replaceWith(svg);
      } else {
        $dypic.toggle('blind');
        let svg =
          "<svg width='24px' height='24px' viewBox='0 0 24 24' stroke-width='1.5' fill='none' xmlns='http://www.w3.org/2000/svg' color='#FFFFFF'><path d='M3 13C6.6 5 17.4 5 21 13' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17C10.3431 17 9 15.6569 9 14C9 12.3431 10.3431 11 12 11C13.6569 11 15 12.3431 15 14C15 15.6569 13.6569 17 12 17Z' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path></svg>";
        $dynapicDiv.find('svg').replaceWith(svg);
      }
    }

    //preview dynamic picture
    function previewPic(backgroundImg) {
      $('#overLayer').css('display', 'flex');
      let backdynpic = backgroundImg;
      $('#overLayer')
        .find('.overlay-dynpic')
        .css('display', 'flex')
        .css('background-image', backdynpic);
      $('#overLayer')
        .find('#closePreview')
        .off('click')
        .on('click', function () {
          $('#overLayer').css('display', 'none');
          $('#overLayer').find('.overlay-dynpic').css('display', 'none');
          $(this).off('click');
        });
    }

    function preDynaPic(DynaDiv) {
      let $dynaDiv = $(DynaDiv);
      let $dynaPic = $dynaDiv.find('img');
      let picSrc = $dynaPic.attr('src');
      let backdynpic = "url('" + picSrc + "')";
      previewPic(backdynpic);
    }


    /*Major add message processer*/
    function add_msg({
      message_input = '',
      avatar_url = '',
      voice_text = '',
      speaker = '',
      speak_tone = '',
      ttskey = '',
      dynamic_picture = false,
      server_reply_done = false,
      from = '',
    } = {}) {
      // public msg processing
      let $message = $(message_input);
      //code block finder
      let $preElement = $message.find('pre');
      if ($preElement.length === 0) {
        console.log('No code found');
      } else {
        console.log('find' + $preElement.length + ' code items');
        $preElement.each(function () {
          let $div = $(
            "<div class='codePre'><div class='codePreDiv'><svg xmlns='http://www.w3.org/2000/svg' height='14px' viewBox='0 0 24 24' width='14px' fill='#FFFFFF'><path d='M0 0h24v24H0z' fill='none'/><path d='M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z'/></svg></div></div>",
          );
          $(this).before($div);
        });
      }
      //dynamic picture handler
      let dynamic_pictures = dynamic_picture;
      let avatar_url_new = avatar_url;
      let $image_str = null;
      if (dynamic_pictures != false) {
        console.log('Find Dynamic pictures');
        let image_str =
          "<div class='dynamicPicBox'><div class='dynaPicControl'><svg width='24px' height='24px' viewBox='0 0 24 24' stroke-width='1.5' fill='none' xmlns='http://www.w3.org/2000/svg' color='#FFFFFF'><path d='M3 13C6.6 5 17.4 5 21 13' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17C10.3431 17 9 15.6569 9 14C9 12.3431 10.3431 11 12 11C13.6569 11 15 12.3431 15 14C15 15.6569 13.6569 17 12 17Z' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path></svg></div><div class='dynamicPic'><img src='" +
          dynamic_pictures +
          "'></div></div>";
        $image_str = $(image_str);
      }

      //prepare the complete message both for normal and comic mode
      let $combine = $('<div></div>');
      let $combine_comic = $combine.clone();
      $combine.append($message);
      let $synmsg = $message.clone(true);
      $combine_comic.append($synmsg);
      if ($image_str !== null) {
        $combine.append($image_str);
      }
      let combinedMessage = $combine.html();
      let combinedMessage_comic = $combine_comic.html(); //all message get ready for append to

      if (!server_reply_done || initialstate) { // for the message from user input or initial state character words and the SVG animated message that indicate the a.i is generating response.
        // normal mode message box handler
        let $msgNormal = $('#msg_container').clone();
        $msgNormal.removeAttr('id');
        $msgNormal.addClass('msg-container-clone');
        if (from == 'client') {
          $msgNormal.addClass('userMsg');
        }
        $msgNormal.find('.message').html(combinedMessage);
        $msgNormal
          .find('.avatar')
          .css('background-image', "url('" + avatar_url_new + "')");
        $('#message_box').append($msgNormal);
        updateScroll();
        gsap.from($msgNormal.find('.message'), {
          duration: 0.3,
          scale: 0.9,
          opacity: 0.5,
          ease: 'back.out(4)',
        });
        //comic mode message box handler
        if (from == 'server') {
          $('#msg_box_comic_char').empty();
          if ($('#voiceController_comic').length > 0) {
            $('#voiceController_comic').css('display', 'none');
          }
          let $msgDivServer = $('#msg_container').clone();
          $msgDivServer.removeAttr('id');
          $msgDivServer.addClass('msg-container-clone');
          $msgDivServer.find('.message').html(combinedMessage_comic);
          $msgDivServer
            .find('.message')
            .removeClass('message')
            .addClass('message-comic');
          $msgDivServer
            .find('.avatar')
            .css('background-image', "url('" + avatar_url_new + "')");
          $('#msg_box_comic_char').append($msgDivServer);
        }
        if (from == 'client') {
          if (comicMode_switchUI.getValue()) {
            $('.comic_msg_holder_user').css('display', 'flex');
          }
          $('#msg_box_comic_user').empty();
          let $msgDivClient = $('#msg_container').clone();
          $msgDivClient.removeAttr('id');
          $msgDivClient.addClass('msg-container-clone');
          $msgDivClient.find('.message').html(combinedMessage_comic);
          $msgDivClient
            .find('.message')
            .removeClass('message')
            .addClass('message-comic');
          $msgDivClient
            .find('.avatar')
            .css('background-image', "url('" + avatar_url_new + "')");
          $('#msg_box_comic_user').append($msgDivClient);
          gsap.from($('.comic_msg_holder_user'), {
            duration: 0.3,
            scale: 0.9,
            opacity: 0.5,
            ease: 'elastic.out(1.2,0.3)',
          });
        }
        initialstate = false;
      } else {
        // for the message from server that has been generated. recevied update the latest message in the normal mode and comic mode.
        //update normal mode contents
        let $lastMsg = $('#message_box').find('.msg-container-clone').last();
        $lastMsg
          .find('.avatar')
          .css('backgroundImage', "url('" + avatar_url_new + "')");
        $lastMsg.find('.message').html(combinedMessage);

        //find code block
        $lastMsg.on("click", ".codePreDiv", function () {
          copyCode(this);

        });

        //find dynamic pic handlers
        $lastMsg.on("click", ".dynaPicControl", function () {
          hideDynaPic(this);
        });
        $lastMsg.on("click", ".dynamicPic", function () {
          preDynaPic(this);
        });

        gsap.from($lastMsg.find('.message'), {
          duration: 0.3,
          scale: 0.9,
          opacity: 0.5,
          ease: 'back.out(4)',
        });
        // updateScroll();


        //update comic mode contents
        let $lastMsgComicChar = $('#msg_box_comic_char')
          .find('.msg-container-clone')
          .last();
        $lastMsgComicChar.find('.message-comic').html(combinedMessage_comic);
        $lastMsgComicChar
          .find('.avatar')
          .css('backgroundImage', "url('" + avatar_url_new + "')");
        gsap.from($('.comic_msg_holder_char'), {
          duration: 0.7,
          scale: 0.9,
          opacity: 0.5,
          ease: 'elastic.out(1.2,0.3)',
        });
        if (dynamic_pictures) {
          //update comic char background
          let charDynamicBgImgURL = "url('" + dynamic_pictures + "')";
          $('#char-dynpic').css('background-image', charDynamicBgImgURL);
          $('#char-dynpic-wrapper').css('display', 'flex');
          if (comicMode_switchUI.getValue()) {
            gsap.from($('#char-dynpic-wrapper'), {
              duration: 0.5,
              scale: 0.4,
              opacity: 0.5,
              ease: 'elastic.out(1.3,0.3)',
            });
          }
          divTimer.TimerTrigger('#char-dynpic-wrapper', 200, 30000);
        }

        //Update voice data for both normal mode and comic mode
        let voiceChecked = voiceswitcherUI.getValue();
        if (voiceChecked && voice_text != '') {
          let langcode = extractLanguageCode(speaker);
          let playText = 'Play Voice';
          let pauseText = 'Pause Voice';
          if (langcode) {
            let uid = genUID('voicePlayer');
            let voicePlayer = new Audio();
            voicePlayer.id = uid;
            voicePlayer.controls = true;
            voicePlayer.className = 'voicePlayer';
            let $controls = $('<div></div>');
            $controls.attr('id', 'controller' + uid);
            $controls.addClass('voiceController').text(playText);
            $controls.on('click', function () {
              let $closestMsgContainer = $(this).closest(
                '.msg-container-clone',
              );
              let isLastMsg = $closestMsgContainer.is(
                '#message_box > .msg-container-clone:last-child',
              );
              let audioElement = $('#' + uid)[0];
              if (audioElement.paused) {
                audioElement.play();
                $(this).text(pauseText);
                if ($('#voiceController_comic').length > 0 && isLastMsg) {
                  $('#voiceController_comic').text(pauseText);
                }
                $('#' + uid).off('ended');
                $('#' + uid).on('ended', function () {
                  $('#controller' + uid).text(playText);
                  if (isLastMsg) {
                    $('#voiceController_comic').text(playText);
                  }
                });
              } else {
                audioElement.pause();
                $(this).text(playText);
                if ($('#voiceController_comic').length > 0 && isLastMsg) {
                  $('#voiceController_comic').text(playText);
                }
              }
            });
            if ($('#voiceController_comic').length == 0) {
              let $controls_comic = $('<div></div>');
              $controls_comic.attr('id', 'voiceController_comic');
              $controls_comic.addClass('voiceController').text(playText);
              $controls_comic.on('click', function () {
                let audioElement = $('#' + uid)[0];
                if (audioElement.paused) {
                  audioElement.play();
                  $(this).text(pauseText);
                  $('#controller' + uid).text(pauseText);
                  $('#' + uid).off('ended');
                  $('#' + uid).on('ended', function () {
                    $('#voiceController_comic').text(playText);
                    $('#controller' + uid).text(playText);
                  });
                } else {
                  audioElement.pause();
                  $(this).text(playText);
                  $('#controller' + uid).text(playText);
                }
              });
              $('#comic-msg-holder-char').append($controls_comic);
            } else {
              $('#voiceController_comic').off('click');
              $('#voiceController_comic').on('click', function () {
                let audioElement = $('#' + uid)[0];
                if (audioElement.paused) {
                  audioElement.play();
                  $(this).text(pauseText);
                  $('#controller' + uid).text(pauseText);
                  $('#' + uid).off('ended');
                  $('#' + uid).on('ended', function () {
                    $('#voiceController_comic').text(playText);
                    $('#controller' + uid).text(playText);
                  });
                } else {
                  audioElement.pause();
                  $(this).text(playText);
                  $('#controller' + uid).text(playText);
                }
              });
            }
            voicePlayer.preload = 'metadata';
            $lastMsg.find('.message').append(voicePlayer).append($controls);
            let querydata = {
              text: voice_text,
              speaker_wav: speaker,
              language: langcode,
              voice_uid: uid,
            };
            ws.send(wsData('xtts_audio_gen', querydata));
          } else {
            msttser.tts(voice_text, speaker, speak_tone, ttskey);
          }
        } else {
          if ($('#voiceController_comic').length > 0) {
            $('#voiceController_comic').remove();
          }
        }
      }
    }

    /* Chatting functions */

    function resetChat() {
      toggleInputs(false);
      var windowSize = getWindowSize();
      userLastMsg = '';
      ai_avatar = '';
      $('#holder_box').fadeOut(200);
      $('#message_box').html('');
      $('#msg_box_comic_char').html('');
      $('#msg_box_comic_user').html('');
      $('.comic_msg_holder_char').fadeOut(90);
      $('.comic_msg_holder_user').fadeOut(100);
      $('#char-dynpic-wrapper').css('display', 'none');
      $('#char-dynpic').css('background-image', '');
      initialstate = true;
      let querydata = {
        username: username,
        usergender: usergender,
        ai_role_name: ai_role_name,
        conid: conid,
        windowRatio: windowSize.ratio,
        language: languageSwitchUI.getValue(),
      };
      ws.send(wsData('restart', querydata));
    }

    function regenReply() {
      if (userLastMsg != '') {
        toggleInputs(false);
        console.log(userLastMsg);
        let windowSize = getWindowSize();
        $('#message_box').find('.msg-container-clone').last().remove();
        var querydata = {
          message: userLastMsg,
          conid: conid,
          windowRatio: windowSize.ratio,
          iscreatedynimage: dynimageSwitcherUI.getValue(),
          language: languageSwitchUI.getValue(),
        };
        ws.send(wsData('regen_msg', querydata));
      }
    }

    function loadChatHistory() {
      var querydata = {
        conid: conid,
      };
      ws.send(wsData('load_chat_history', querydata));
      toggleInputs(false);
    }

    function saveChatHistory() {
      var querydata = {
        conid: conid,
      };
      ws.send(wsData('save_chat_history', querydata));
      toggleInputs(false);
    }

    function sentenceCompletion() {
      let textBeforeCursor = $('#messageToSend').val().substring(
        0,
        $('#messageToSend')[0].selectionStart,
      );
      let textAfterCursor = $('#messageToSend').val().substring(
        $('#messageToSend')[0].selectionEnd,
      );
      var querydata = {
        conid: conid,
        message: { "prefix": textBeforeCursor, "suffix": textAfterCursor },
      };
      ws.send(wsData('sentence_completion', querydata));
      toggleInputs(false);
    }

    function changeModel(model_list, model) {
      if (model_list.length > 0) {
        // console.log(model_list);
        const modelSwitchItemList = [];
        $.each(model_list, function (index, value) {
          //if value includes"/", get the text after "/"
          let name = 'None'
          if (value.includes('/')) {
            name = value.split('/')[1];
          } else {
            name = value;
          }
          // console.log(`name: ${name}, value: ${value}`);
          modelSwitchItemList.push({
            name: name,
            value: value,
          });
        });
        modelSwitchUI.updateListItems(modelSwitchItemList);
        modelSwitchUI.setItem(model);
      }
    }

    function changeInstr(instruct_list) {
      if (instruct_list !== undefined) {
        if (instruct_list.length > 0) {
          console.log(instruct_list);
          const instructSwitchItemList = [];
          $.each(instruct_list, function (index, value) {
            instructSwitchItemList.push({
              name: value,
              value: value,
            });
          });
          instrSwitchUI.updateListItems(instructSwitchItemList);
          // instrSwitchUI.setItem(instrSelected);
        }
      }
    }

    function changeSDModel(SD_model_list, SD_model) {
      if (SD_model_list !== undefined) {
        if (SD_model_list.length > 0) {
          console.log(SD_model_list);
          const sdSwitchItemList = [];
          $.each(SD_model_list, function (index, value) {
            sdSwitchItemList.push({
              name: value,
              value: value,
            });
          });
          sdSwitchUI.updateListItems(sdSwitchItemList);
          sdSwitchUI.setItem(SD_model);
        }
      }
    }

    function model_loaded(msg) {
      var msg = msg.data['message'];
      if (msg == 'Success') {
        toggleInputs(true);
      } else {
        alert('Model Load Failed');
      }
    }

    function instruct_changed(msg) {
      var msg = msg.data['message'];
      if (msg == 'Success') {
        toggleInputs(true);
      } else {
        alert('instruct change Failed');
      }
    }

    function SD_model_changed(msg) {
      var msg = msg.data['message'];
      if (msg == 'Success') {
        toggleInputs(true);
      } else {
        alert('SD Model change Failed');
      }
    }

    function delay(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function processLoadedHistory(loaded_history) {
      for (let msgitem of loaded_history) {
        if (msgitem.role == 'user') {
          var user_inputmsg = marked.parse(msgitem.msg);
          add_msg({
            message_input: user_inputmsg,
            avatar_url: user_looks,
            from: 'client',
          });
        } else if (msgitem.role == 'char') {
          var char_inputmsg = marked.parse(msgitem.msg);
          add_msg({
            message_input: char_inputmsg,
            avatar_url: ai_avatar,
            from: 'server',
          });
        }
        await delay(350);
      }
    }


    /* Server status process handler */
    function ProcessServerStatus(msgData) {
      let msg = msgData.data['message'];
      if (msg['name'] == 'initialization') {
        if (msg['msg'] !== 'DONE') {
          $('#overLayer').fadeIn(300);
          $('#overLayer').css('display', 'flex');
          $('#overLayer').find('.overlay-content').css('display', 'flex');
          $('#overLayer')
            .find('.overlay-content')
            .find('.loadingText')
            .html(msg['msg']);
          // $('.loadingText_Percentage').html(' : 0%')
          $('.loadingText_Percentage').html('')
          gsap.from($('#overLayer').find('.overlay-content'), {
            duration: 1,
            scale: 0.7,
            opacity: 0.3,
            ease: 'elastic.out(1.3,0.4)',
          });
        } else {
          $('#overLayer').fadeOut(300);
          $('#overLayer').find('.overlay-content').css('display', 'none');
          $('#overLayer')
            .find('.overlay-content')
            .find('.loadingText')
            .html('');
          // $('.loadingText_Percentage').html(' : 0%')
          $('.loadingText_Percentage').html('')
          $('#holder_box').fadeIn(500);
          $('#holder_box').css('display', 'flex');
          if (comicMode_switchUI.getValue()) {
            $('.comic_msg_holder_char').css('display', 'flex');
          }
        }
      }
      if (msg['name'] == 'SD_generation') {
        if (msg.msg.event == 'SD_Process_status') {
          if (msg.msg.task_flag.startsWith('generate_background') || msg.msg.task_flag.startsWith('generate_avatar')) {
            $('.loadingText_Percentage').html(": " + String(msg.msg.percentage) + "%")
          } else if (msg.msg.task_flag.startsWith('generate_live')) {
            if (msg.msg.task_flag == 'generate_live-DynamicPicture') {
              let percentage_str = String(msg.msg.percentage) + '%'
              let $lastmsg = $('#message_box')
                .find('.msg-container-clone')
                .last()
                .find('.message');
              $lastmsg.find('.genImgDiv_title').html('Progress:')
              $lastmsg.find('.genImgDiv_progress').html(percentage_str)
              let $lastmsg_comic = $('#msg_box_comic_char')
                .find('.msg-container-clone')
                .last()
                .find('.message-comic');
              $lastmsg_comic.find('.genImgDiv_title').html('Progress:')
              $lastmsg_comic.find('.genImgDiv_progress').html(percentage_str)
            }
          }
        }
      }
      if (msg['name'] == 'chatreply') {
        let Svg =
          "<svg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' fill='#FFFFFF'><circle cx='4' cy='12' r='3'><animate id='spinner_qFRN' begin='0;spinner_OcgL.end+0.25s' attributeName='cy' calcMode='spline' dur='0.6s' values='12;6;12' keySplines='.33,.66,.66,1;.33,0,.66,.33'/></circle><circle cx='12' cy='12' r='3'><animate begin='spinner_qFRN.begin+0.1s' attributeName='cy' calcMode='spline' dur='0.6s' values='12;6;12' keySplines='.33,.66,.66,1;.33,0,.66,.33'/></circle><circle cx='20' cy='12' r='3'><animate id='spinner_OcgL' begin='spinner_qFRN.begin+0.2s' attributeName='cy' calcMode='spline' dur='0.6s' values='12;6;12' keySplines='.33,.66,.66,1;.33,0,.66,.33'/></circle></svg>";
        let imgSvg =
          "<svg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' fill='#FFFFFF'><rect x='1' y='1' width='7.33' height='7.33'><animate id='spinner_oJFS' begin='0;spinner_5T1J.end+0.2s' attributeName='x' dur='0.6s' values='1;4;1'/><animate begin='0;spinner_5T1J.end+0.2s' attributeName='y' dur='0.6s' values='1;4;1'/><animate begin='0;spinner_5T1J.end+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='0;spinner_5T1J.end+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='8.33' y='1' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.1s' attributeName='x' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='y' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='1' y='8.33' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.1s' attributeName='x' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='y' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='15.66' y='1' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.2s' attributeName='x' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='y' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='8.33' y='8.33' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.2s' attributeName='x' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='y' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='1' y='15.66' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.2s' attributeName='x' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='y' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='15.66' y='8.33' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.3s' attributeName='x' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='y' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='8.33' y='15.66' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.3s' attributeName='x' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='y' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='15.66' y='15.66' width='7.33' height='7.33'><animate id='spinner_5T1J' begin='spinner_oJFS.begin+0.4s' attributeName='x' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.4s' attributeName='y' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.4s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.4s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect></svg>";
        if (msg['msg'] == 'Generate Response') {
          /* Generate response status : msg from 'server' */
          add_msg({
            message_input: Svg,
            avatar_url: ai_avatar,
            from: 'server',
          });
        }
        if (msg['msg'] == 'Generating Scene Image') {
          let $lastmsg = $('#message_box')
            .find('.msg-container-clone')
            .last()
            .find('.message');
          $lastmsg.append(
            "<div class='genImgDiv'>" +
            imgSvg +
            '<span class="genImgDiv_title">' +
            msg['msg'] +
            '</span><span class="genImgDiv_progress"></span></div>',
          );
          let $lastmsg_comic = $('#msg_box_comic_char')
            .find('.msg-container-clone')
            .last()
            .find('.message-comic');
          $lastmsg_comic.append(
            "<div class='genImgDiv'>" +
            imgSvg +
            '<span class="genImgDiv_title">' +
            msg['msg'] +
            '</span><span class="genImgDiv_progress"></span></div>',
          );
          updateScroll();
        }
        if (msg['msg']['event'] == 'streaming') {
          let msgText = msg['msg']['text'];
          let $lastmsg = $('#message_box')
            .find('.msg-container-clone')
            .last()
            .find('.message');
          let $lastmsg_comic = $('#msg_box_comic_char')
            .find('.msg-container-clone')
            .last()
            .find('.message-comic');
          if (msgText != '[DONE]') {
            let streamText = streamingBuffer.join('');
            $lastmsg.html("<p class='stream_text'>" + streamText + '</p>');
            $lastmsg.find('p').append("<span class='stream_text_char'>" + msgText + "</span>");
            $lastmsg.find(".stream_text_char").css({
              "opacity": "1"
            });
            $lastmsg.find('p').append("<span class='stream_hint'></span>");
            $lastmsg_comic.html(
              "<p class='stream_text'>" + streamText + '</p>',
            );
            $lastmsg_comic.find('p').append("<span class='stream_text_char'>" + msgText + "</span>");
            $lastmsg_comic.find(".stream_text_char").css({
              "opacity": "1"
            });
            $lastmsg_comic.find('p').append("<span class='stream_hint'></span>");
            streamingBuffer.push(msgText);
          } else {
            $lastmsg.find(".stream_text_char").addClass("stream_text").removeClass("stream_text_char");
            $lastmsg.find('p').find('.stream_hint').fadeOut(1500);
            $lastmsg_comic.find(".stream_text_char").addClass("stream_text").removeClass("stream_text_char");
            $lastmsg_comic.find('p').find('.stream_hint').fadeOut(1500);
            streamingBuffer = [];
          }
          updateScroll();
        }
      }

      if (msg['name'] == 'chat_history_op') {
        if (msg['msg']['operation'] == 'save') {
          if (msg['msg']['result'] == 'Success') {
            toggleInputs(true);
            alert('Saved history successfully');
          } else {
            toggleInputs(true);
            alert('Saving history failed, have you start chat?');
          }
        }
        if (msg['msg']['operation'] == 'load') {
          if (msg['msg']['result'] == 'Fail') {
            toggleInputs(true);
            alert('loading history failed, Empty?');
          } else {
            $('#message_box')
              .find('.msg-container-clone:not(:first)')
              .remove();
            let loaded_history = msg['msg']['result'];
            processLoadedHistory(loaded_history).then(() => {
              toggleInputs(true);
            });
          }
        }
      }
      if (msg['name'] == 'live-ChatBackgroud') {
        let imgBase64URI = msg['imgBase64URI'];
        let char_bg_holder = $("#char-bgpic");
        gsap.to(char_bg_holder, {
          duration: 0.3,
          opacity: 0,
          onComplete: function () {
            char_bg_holder.css("background-image", "url('" + imgBase64URI + "')");
            gsap.to(char_bg_holder, {
              duration: 0.5,
              opacity: 1,
            });
          },
        });

      }
    }

    /* Message proccesing for server-end : server_reply_done: true, msg from: 'server'*/
    function msg_proc(msg) {
      let message = msg.data['message'];
      if (msg.data['avatar'] != undefined) {
        ai_avatar = msg.data['avatar'];
      } else {
        ai_avatar = ai_avatar_path;
      }
      if (msg.data['user_looks'] != undefined) {
        user_looks = msg.data['user_looks'];
      }
      if (msg.data['bgImg'] != undefined) {
        let bgImg = msg.data['bgImg'];
        let charBgImgURL = "url('" + bgImg + "')";
        $('#char-bgpic').css('background-image', charBgImgURL);
      }
      if (msg.data['user_bkImg'] != undefined) {
        let user_bkImg = msg.data['user_bkImg'];
        let userBgImgURL = "url('" + user_bkImg + "')";
        $('#user-bgpic').css('background-image', userBgImgURL);
      }
      if (msg.data['iscreatedynimage'] != undefined) {
        if (msg.data['iscreatedynimage'] == true) {
          dynimageSwitcherUI.setValue(true);
        } else {
          dynimageSwitcherUI.setValue(false);
          $(dynimageSwitcher).css('pointer-events', 'none');
          $(dynimageSwitcher).css('opacity', '0.2');
          $(dynimageSwitcher).next('span').css('opacity', '0.2');
        }
      }
      if (msg.data['bg_music'] != undefined) {
        let moment = msg.data['bg_music'];
        if (moment != '') {
          if ($('#bg_music')[0].src != `/play_music/${moment}`) {
            $('#bg_music')[0].src = `/play_music/${moment}`;
            if (volumeKnob.initialMuted == false) {
              $('#bg_music')[0].play();
            }
          }
        } else {
          $('#bg_music')[0].pause();
        }
      }
      if (msg.data['prologue'] != undefined) {
        Prologue = msg.data['prologue'];
        console.log(Prologue);
        Prologue = Prologue.replaceAll("*", "");
        Prologue = Prologue.replaceAll("{% raw %}{{char}}{% endraw %}", "<em>" + ainame + "</em>");
        Prologue = Prologue.replaceAll("{% raw %}{{user}}{% endraw %}", "<em>" + username + "</em>");
        Prologue = Prologue.replaceAll(ainame, "<em>" + ainame + "</em>");
        Prologue = Prologue.replaceAll(username, "<em>" + username + "</em>");
      }
      let voice_text = msg.data['voice_text'];
      let speaker = msg.data['speaker'];
      let speak_tone = msg.data['speak_tone'];
      let ttskey = msg.data['ttskey'];
      let dynamic_picture = msg.data['dynamic_picture'];
      let model_list = msg.data['model_list'];
      let model = msg.data['model'];
      if (model_list != undefined) {
        changeModel(model_list, model);
      }
      let SD_model_list = msg.data['SD_model_list'];
      let SD_model = msg.data['SD_model'];
      if (SD_model_list != undefined) {
        changeSDModel(SD_model_list, SD_model);
      }
      let using_remoteapi = msg.data["using_remoteapi"];
      if (using_remoteapi != true) {
        let instruct_list = msg.data['instruct_list'];
        changeInstr(instruct_list);
        $(instrSwitch).parent().show();
      } else {
        $(instrSwitch).parent().hide();
      }

      toggleInputs(true);

      add_msg({
        message_input: message,
        avatar_url: ai_avatar,
        voice_text: voice_text,
        speaker: speaker,
        speak_tone: speak_tone,
        ttskey: ttskey,
        dynamic_picture: dynamic_picture,
        server_reply_done: true,
        from: 'server',
      });
      micstate = true;
    }

    /* Send msg to server : msg from 'client' */
    function sendmsgtoserver(msg_to_send, command_flag, prompt_flag) {
      toggleInputs(false);
      let windowSize = getWindowSize();
      let usermsg;
      let user_appearMsg;
      if (command_flag !== 'cmd_normal') {
        usermsg = prompt_flag.replace(prompt_variable_str, msg_to_send);
        user_appearMsg = `<div class="icon_with_msg"><div class="icon_svg">${suggestions[command_flag].svg}</div><div class="word_p">${marked.parse(msg_to_send)}</div></div>`;
      } else {
        usermsg = msg_to_send;
        user_appearMsg = marked.parse(msg_to_send)
      }
      userLastMsg = usermsg;
      add_msg({
        message_input: user_appearMsg,
        avatar_url: user_looks,
        from: 'client',
      });
      let querydata = {
        message: usermsg,
        command_flag: command_flag,
        conid: conid,
        windowRatio: windowSize.ratio,
        iscreatedynimage: dynimageSwitcherUI.getValue(),
        language: languageSwitchUI.getValue(),
      };
      ws.send(wsData('send_user_msg', querydata));
    }

    function autoExpand(textarea) {
      setTimeout(function () {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
      }, 0);
    }
    //Server Connected
    function Server_Connected() {
      if (initialstate) {
        comicMode_switchUI.setValue(false);
        $('#message_box').empty();
        $('.comic_msgbox').empty();
        $('#comicMode').prop('checked', false).trigger('change');
        $('#holder_box').css('display', 'none');
        let windowSize = getWindowSize();
        let querydata = {
          username: username,
          user_sys_name: user_sys_name,
          usergender: usergender,
          user_facelooks: user_facelooks,
          ai_role_name: ai_role_name,
          conid: clientID,
          ai_is_uncensored: ai_is_uncensored,
          ai_is_live_char: ai_is_live_char,
          language: languageSwitchUI.getValue(),
          windowRatio: windowSize.ratio,
        };
        ws.send(wsData('initialize_room', querydata));
      } else {
        /* reconnect to server */
        let querydata = {
          conid: clientID,
        };
        ws.send(wsData('reconnect_room', querydata));
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction() {
        const context = this;
        const args = arguments;
        const later = function () {
          timeout = null;
          func.apply(context, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    function switchVoiceController() {
      let vs_check = voiceswitcherUI.getValue();
      if (vs_check && $('.voicePlayer').length > 0) {
        $('.voiceController').css('display', 'flex');
      } else {
        $('.voiceController').css('display', 'none');
      }
    }

    /*Document Ready Actions*/
    $(document).ready(function () {
      const defaultText = vm.currentLanguage.Input_Hint;
      const $msg_inputer = $('#messageToSend');
      const $cmd_dropdownMenu = $('#cmd_dropdownMenu');
      const $ai_icon = $('.ai_icon');
      prompt_variable_str = '[contents]';
      const cssClasses = {
        cmdItems: 'cmd_items',
        inputText: 'input_text',
        highlight: 'highlight',
        itemName: 'item_name',
        sugDesc: 'sug_desc',
        highlight_svg: 'highlight_svg'
      };

      commandInputHandler = new CommandInputHandler(
        suggestions,
        defaultText,
        $msg_inputer,
        $cmd_dropdownMenu,
        $ai_icon,
        prompt_variable_str,
        cssClasses,
        sentenceCompletion
      );

      // svg timer progress bar
      let circle = document.querySelector('.progress-ring__circle-progress');
      let $bar = $('.progress-ring__circle-progress');
      $bar.hide();
      const radius = circle.r.baseVal.value;
      const circumference = radius * 2 * Math.PI;
      circle.style.strokeDasharray = `${circumference} ${circumference}`;
      circle.style.strokeDashoffset = circumference;
      let interval = null;
      let total_steps = 0;
      function setProgress(percent) {
        const offset = circumference - percent / total_steps * circumference;
        circle.style.strokeDashoffset = offset;
      }

      function stop_progress_bar() {
        clearInterval(interval);
        interval = null
        $bar.fadeOut(500, () => {
          circle.style.strokeDashoffset = circumference;
        });
      }

      function updateProgressBar(duration) {
        total_steps = duration / 10
        $bar.show();
        let progress = 0;
        interval = setInterval(() => {
          progress += 1;
          setProgress(progress);
          if (progress >= total_steps) {
            stop_progress_bar();
          }
        }, 10);
      }


      // audio recorder
      const audioRecorder = new AudioRecorder();
      let svgicon_normal = `<svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#ffffff" stroke-width="1.5"><rect x="9" y="2" width="6" height="12" rx="3" fill="#ffffff" stroke="#ffffff" stroke-width="1.5" stroke-width="1.5"></rect><path d="M5 10V11C5 14.866 8.13401 18 12 18V18V18C15.866 18 19 14.866 19 11V10" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 18V22M12 22H9M12 22H15" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;
      let svgicon_activate = `<svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#ffffff" stroke-width="1.5"><rect x="9" y="2" width="6" height="12" rx="3" fill="#ffffff" stroke="#ffffff" stroke-width="1.5" stroke-width="1.5"></rect><path d="M5 3V5M1 2V6M19 3V5M23 2V6" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M5 10V11C5 14.866 8.13401 18 12 18V18V18C15.866 18 19 14.866 19 11V10" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 18V22M12 22H9M12 22H15" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;
      let svgicon_completed = `<svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#ffffff" stroke-width="1.5"><path d="M15.5 20.5L17.5 22.5L22.5 17.5" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><rect x="5" y="2" width="6" height="12" rx="3" fill="#ffffff" stroke="#ffffff" stroke-width="1.5" stroke-width="1.5"></rect><path d="M1 10V11C1 14.866 4.13401 18 8 18V18V18C11.866 18 15 14.866 15 11V10" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M8 18V22M8 22H5M8 22H11" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;

      let timer;
      async function recordhandler() {
        toggleInputs(false);
        if (audioRecorder.isRecording) {
          clearTimeout(timer);
          stop_progress_bar();
          await sendAudioData();
        } else {
          $("#recordButton").html(svgicon_activate);
          updateProgressBar(10000);
          await audioRecorder.startRecording();
          timer = setTimeout(async () => {
            console.log('Recording stopped after 10 seconds');
            await sendAudioData();
          }, 10000);

        }

      }

      async function sendAudioData() {
        micstate = false;
        let data = await audioRecorder.stopRecording();
        let reader = new FileReader();
        reader.readAsDataURL(data);
        reader.onloadend = function () {
          let base64data = reader.result;
          let querydata = {
            conid: clientID,
            audio_data: base64data,
          };
          ws.send(wsData('transcribe_audio', querydata));
          $("#recordButton").html(svgicon_completed);

        }
      }

      $('#recordButton').on('click', function (e) {
        if (micstate) {
          recordhandler();
        } else {
          e.preventDefault();
          return false;
        }
      });



      $msg_inputer.on('SendMsg', function (event) {
        console.log(
          `command type:${event.command_flag}\nthe message is:${event.msg}\nthe prompt is:${event.prompt_flag}`,
        );
        sendmsgtoserver(event.msg, event.command_flag, event.prompt_flag);
      });
      //
      $('#submit').on('click', function () {
        commandInputHandler.triggerEnterEvent();
      });
      $('#load-chat-history').click(loadChatHistory);
      $('#save-chat-history').click(saveChatHistory);
      $('#restart').click(resetChat);
      $('#regenerate').click(regenReply);
      $('#exitchat').click(exitChat);
      $('#ai_intro .prologue_button').on('click', function () {
        $('#intro_prologue_area .intro_prologue').fadeToggle(500).html(Prologue);
      });
      $('#intro_prologue_area .intro_prologue').on('click', function () {
        $(this).fadeOut(100);
      });
      toggleInputs(false);
      // Auto resize comic layout
      $('.comic_msg_holder_char').draggable({
        handle: '.msg-drag-handle',
      });
      $('.comic_msg_holder_user').draggable({
        handle: '.msg-drag-handle',
      });
      var handleResize = debounce(function () {
        if (comicMode_switchUI.getValue()) {
          var width = $(window).width();
          var height = $(window).height();
          if (width > height) {
            $('#char-wrapper')
              .removeClass('wrapper-char')
              .addClass('wrapper-char-horizon');
            $('#char-bgpic')
              .removeClass('char_bg')
              .addClass('char_bg_horizon');
            $('#user-wrapper')
              .removeClass('wrapper-user')
              .addClass('wrapper-user-horizon');
            $('#user-bgpic')
              .removeClass('user_bg')
              .addClass('user_bg_horizon');
            $('#char-dynpic-wrapper')
              .removeClass('wrapper-char-dynpic')
              .addClass('wrapper-char-dynpic-horizon');
            $('#char-dynpic')
              .removeClass('char_dynmicpic_bg')
              .addClass('char_dynmicpic_bg_horizon');
            $('#comic-msg-holder-char')
              .addClass('comic_msg_holder_char_horizon')
              .css({
                top: '50%',
                left: '80px',
              });
            $('#comic-msg-holder-user')
              .addClass('comic_msg_holder_user_horizon')
              .css({
                top: '50%',
                left: 'calc(40% + 140px)',
              });
          } else {
            $('#char-wrapper')
              .removeClass('wrapper-char-horizon')
              .addClass('wrapper-char');
            $('#char-bgpic')
              .removeClass('char_bg_horizon')
              .addClass('char_bg');
            $('#user-wrapper')
              .removeClass('wrapper-user-horizon')
              .addClass('wrapper-user');
            $('#user-bgpic')
              .removeClass('user_bg_horizon')
              .addClass('user_bg');
            $('#char-dynpic-wrapper')
              .removeClass('wrapper-char-dynpic-horizon')
              .addClass('wrapper-char-dynpic');
            $('#char-dynpic')
              .removeClass('char_dynmicpic_bg_horizon')
              .addClass('char_dynmicpic_bg');
            $('#comic-msg-holder-char')
              .removeClass('comic_msg_holder_char_horizon')
              .css({
                top: '40%',
                left: '80px',
              });
            $('#comic-msg-holder-user')
              .removeClass('comic_msg_holder_user_horizon')
              .css({
                top: 'calc(40% + 300px)',
                left: '30%',
              });
          }
        }
      }, 250);
      $(window).on('resize', handleResize);
      //
      $('#char-dynpic-wrapper')
        .css('cursor', 'pointer')
        .on('click', function () {
          $(this).fadeOut(200);
          let backdynpic = $(this)
            .find('#char-dynpic')
            .css('background-image');
          previewPic(backdynpic);
        });
      $('.chatSetUpBtn').on('click', function () {
        if ($('.settingOpt').css('display') == 'none') {
          $('#overLayer').css('display', 'flex');
          $('#setTings').css('z-index', 1000);
          $('.settingOpt').css('opacity', 0).css('display', 'flex');
          gsap.to($('.settingOpt'), {
            duration: 0.4,
            opacity: 1,
            onComplete: function () {
              $('#overLayer').on('click', function () {
                $('.settingOpt').css('display', 'none');
                $(this).css('display', 'none');
                $(this).off('click');
                $('#setTings').css('z-index', 15);
              });
            },
          });
        } else {
          gsap.to($('.settingOpt'), {
            duration: 0.2,
            opacity: 0,
            onComplete: function () {
              $('.settingOpt').css('display', 'none');
              $('#overLayer').css('display', 'none');
              $('#overLayer').off('click');
              $('#setTings').css('z-index', 15);
            },
          });
        }
      });
      //Resize holder_box function
      var startY, startHeight, containerHeight;
      $('#drag-handle').on('mousedown', function (e) {
        startY = e.pageY;
        startHeight = $('#holder_box').height();
        containerHeight = $('.flexPage').height(); // 获取容器的高度
        $(document).on('mousemove', mouseMove).on('mouseup', mouseUp);
        e.preventDefault();
      });

      function mouseMove(e) {
        var newHeight = startHeight + (startY - e.pageY);
        var minHeight = containerHeight * 0.3;
        var maxHeight = containerHeight * 0.9;
        newHeight = Math.max(newHeight, minHeight);
        newHeight = Math.min(newHeight, maxHeight);
        $('#holder_box').css('height', newHeight + 'px');
      }

      function mouseUp() {
        $(document).off('mousemove', mouseMove).off('mouseup', mouseUp);
      }
      let backgroundImage = "url('" + bkimg_path + "')";
      $('#char-bgpic').css('background-image', backgroundImage);


      /*WebSocket Process*/
      let websocket;
      let retryCount = 0;
      const maxRetryLimit = 10;
      let retryDelay = 1000;
      const maxRetryDelay = 60000;

      function connectWebSocket() {
        const wsUrl = `//${window.location.host}/ws/${clientID}`
        ws = new WebSocket(wsUrl.replace(/^\/\//, window.location.protocol === 'https:' ? 'wss://' : 'ws://'));
        ws.onopen = (e) => {
          retryCount = 0;
          retryDelay = 1000;
          console.log('Connected to Websocket...');
          let querydata = {
            from: clientID,
            msg: {
              message: 'CyberChat Index Page Connected',
              status: 200,
            },
          };
          ws.send(wsData('connect to server', querydata));
        };
        //process server feedback
        ws.onmessage = (e) => {
          let serverData = JSON.parse(e.data);
          if (serverData.wsevent_server == 'after_connect') {
            console.log('after_connect');
            Server_Connected();
          }
          if (serverData.wsevent_server == 'status_from_server') {
            console.log(serverData.data.message);
            ProcessServerStatus(serverData);
          }
          if (serverData.wsevent_server == 'Message_data_from_server') {
            msg_proc(serverData);
          }
          if (serverData.wsevent_server == 'exit_room_success') {
            exitRoomSuccess(serverData);
          }
          if (serverData.wsevent_server == 'model_change_result') {
            model_loaded(serverData);
          }
          if (serverData.wsevent_server == 'instruction_change_result') {
            instruct_changed(serverData);
          }
          if (serverData.wsevent_server == 'SD_Model_change_result') {
            SD_model_changed(serverData);
          }
          if (serverData.wsevent_server == 'xtts_result') {
            xtts_audio_data(serverData);
          }
          if (serverData.wsevent_server == 'transcript_audio_result') {
            transcript_audio_result(serverData);
          }
          if (serverData.wsevent_server == 'sentence_completion_result') {
            sentence_completion_result(serverData);
          }
          if (serverData.wsevent_server == 'language_switch_result') {
            vm.language_switch_result(serverData);
          }
        };
        ws.onerror = (e) => {
          console.log('Websocket error observed: ' + e);
        };
        ws.onclose = (e) => {
          console.log('Connect closed');
          let closeReason =
            e.code === 1006 ? ', Server Shutdown ?' : ', Reason: ' + e.reason;
          console.log('Code: ' + e.code + closeReason);
          if (retryCount < maxRetryLimit) {
            setTimeout(reconnect, retryDelay);
            retryDelay = Math.min(maxRetryDelay, retryDelay * 2); // 延迟翻倍，但不超过最大延迟
          }
        };
      }

      function reconnect() {
        retryCount++;
        console.log(`Attempting to reconnect... (Attempt: ${retryCount})`);
        connectWebSocket();
      }
      connectWebSocket();
    });

  </script>
</body>

</html>