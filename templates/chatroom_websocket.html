<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/static/images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="/static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/static/css/chat.css" />
    <link rel="stylesheet" type="text/css" href="/static/css/jquery-ui.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Philosopher&display=swap"
      rel="stylesheet"
    />
    <title>{{ainame}}</title>
    <script src="/static/js/gsap.min.js"></script>
    <script src="/static/js/marked.js"></script>
    <script src="/static/js/jquery-3.6.0.min.js"></script>
    <script src="/static/js/jquery-ui.js"></script>
    <script type="text/javascript">
      function copyCode(clickedDiv) {
        let $clickdiv = $(clickedDiv);
        let tempHtml = $clickdiv.parent().next().get(0);
        console.log(tempHtml.textContent);
        navigator.clipboard
          .writeText(tempHtml.textContent)
          .then(() => {
            console.log('Text copied to clipboard');
          })
          .catch((err) => {
            // This can happen if the user denies clipboard permissions:
            console.error('Could not copy text: ', err);
          });
      }
      function hideDynaPic(dynapicDiv) {
        let $dynapicDiv = $(dynapicDiv);
        let $dypic = $dynapicDiv.parent().find('.dynamicPic');
        if ($dypic.is(':visible')) {
          $dypic.toggle('blind');
          let svg =
            "<svg width='24px' height='24px' viewBox='0 0 24 24' stroke-width='1.5' fill='none' xmlns='http://www.w3.org/2000/svg' color='#FFFFFF' ><path d='M19.5 16L17.0248 12.6038' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17.5V14' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M4.5 16L6.96895 12.6124' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M3 8C6.6 16 17.4 16 21 8' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path></svg>";
          $dynapicDiv.find('svg').replaceWith(svg);
        } else {
          $dypic.toggle('blind');
          let svg =
            "<svg width='24px' height='24px' viewBox='0 0 24 24' stroke-width='1.5' fill='none' xmlns='http://www.w3.org/2000/svg' color='#FFFFFF'><path d='M3 13C6.6 5 17.4 5 21 13' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17C10.3431 17 9 15.6569 9 14C9 12.3431 10.3431 11 12 11C13.6569 11 15 12.3431 15 14C15 15.6569 13.6569 17 12 17Z' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path></svg>";
          $dynapicDiv.find('svg').replaceWith(svg);
        }
      }

      function previewPic(backgroundImg) {
        $('#overLayer').css('display', 'flex');
        let backdynpic = backgroundImg;
        $('#overLayer')
          .find('.overlay-dynpic')
          .css('display', 'flex')
          .css('background-image', backdynpic);
        $('#overLayer')
          .find('#closePreview')
          .off('click')
          .on('click', function () {
            $('#overLayer').css('display', 'none');
            $('#overLayer').find('.overlay-dynpic').css('display', 'none');
            $(this).off('click');
          });
      }
      function preDynaPic(DynaDiv) {
        let $dynaDiv = $(DynaDiv);
        let $dynaPic = $dynaDiv.find('img');
        let picSrc = $dynaPic.attr('src');
        let backdynpic = "url('" + picSrc + "')";
        previewPic(backdynpic);
      }
    </script>
    <script type="module" charset="utf-8">
      import { msTTS } from '/static/js/tts.js';
      const msttser = new msTTS();
      import CommandInputHandler from '/static/js/input_control.js';
      marked.use({
        mangle: false,
        headerIds: false,
      });
      var ws = Object;
      var socket = Object;
      const clientID = '{{clientID}}';
      const timestamp = '{{ timestamp }}';
      console.log('Client ID: ' + clientID);
      var username = '{{nickname}}';
      var user_sys_name = '{{username}}';
      var user_avatar = '{{avatar}}';
      var user_facelooks = JSON.parse('{{ facelooks | safe }}');
      var usergender = '{{gender}}';
      var credits = '{{credits}}';
      var ai_role_name = '{{ai_role_name}}';
      var ainame = '{{ainame}}';
      var Prologue = `{{Prologue | safe}}`;
      var ai_is_uncensored = '{{is_uncensored}}';
      var conid = '{{clientID}}';
      var bkimg_path =
        '/static/images/avatar/' +
        ai_role_name +
        '/background.png?nocache=' +
        timestamp;
      var currentIndex = 0;
      var userLastMsg = '';
      var ai_avatar = '';
      var user_looks = '';
      var initialstate = true;
      var holdbox_origin_height;
      var streamingBuffer = [];
      var prompt_variable_str;
      var icons;
      // var command_flag = "cmd_normal";
      // var prompt_flag = null;
      // var msg_to_send = "";
      function wsData(wsevent, querydata) {
        let messagebody = {
          wsevent_client: wsevent,
          data: querydata,
        };
        return JSON.stringify(messagebody);
      }

      function Module_timer() {
        var timer;
        function SORTimer(selector, fadeouttimes, keeptimes) {
          if (timer) {
            clearTimeout(timer);
          }
          timer = setTimeout(function () {
            $(selector).fadeOut(fadeouttimes);
          }, keeptimes);
        }
        return {
          TimerTrigger: SORTimer,
        };
      }
      var divTimer = Module_timer();

      function toggleInputs(input_switcher) {
        if (input_switcher == true) {
          $('button, input, select, textarea').each(function () {
            $(this).prop('disabled', false).css('opacity', 1);
            if ($(this).is('button')) {
              $(this).css('pointer-events', 'auto');
            }
          });
          $('#messageToSend').focus();
          // $("#submit").on("click", sendmsgtoserver);
        } else {
          // $("#submit").off("click", sendmsgtoserver);
          $('button, input, select, textarea').each(function () {
            $(this).prop('disabled', true).css('opacity', 0.5);
            if ($(this).is('button')) {
              $(this).css('pointer-events', 'none');
            }
          });
        }
      }
      function getWindowSize() {
        var width =
          window.innerWidth ||
          document.documentElement.clientWidth ||
          document.body.clientWidth;
        var height =
          window.innerHeight ||
          document.documentElement.clientHeight ||
          document.body.clientHeight;
        var ratio = width / height;
        console.log(
          'width: ' + width + ' height: ' + height + ' ratio: ' + ratio,
        );
        return { width: width, height: height, ratio: ratio };
      }
      function resizeComicLayout() {
        let windowSize = getWindowSize();
        let ratio = windowSize.ratio;
        if (ratio < 1) {
          $('#char-wrapper')
            .removeClass('wrapper-char-fullscreen')
            .addClass('wrapper-char');
          $('#char-bgpic')
            .removeClass('char_bg_fullscreen')
            .addClass('char_bg');
          $('#user-wrapper')
            .removeClass('wrapper-user-fullscreen')
            .addClass('wrapper-user');
          $('#user-bgpic').removeClass('user_bg_horizon').addClass('user_bg');
          $('#char-dynpic-wrapper')
            .removeClass('wrapper-char-dynpic-fullscreen')
            .addClass('wrapper-char-dynpic');
          $('#char-dynpic')
            .removeClass('char_dynmicpic_bg_horizon')
            .addClass('char_dynmicpic_bg');
          $('#comic-msg-holder-char')
            .removeClass('comic_msg_holder_char_horizon')
            .addClass('comic_msg_holder_char');
          $('#comic-msg-holder-user')
            .removeClass('comic_msg_holder_user_horizon')
            .addClass('comic_msg_holder_user');
        } else if (ratio > 1) {
          $('#char-wrapper')
            .removeClass('wrapper-char-fullscreen')
            .addClass('wrapper-char-horizon');
          $('#char-bgpic')
            .removeClass('char_bg_fullscreen')
            .addClass('char_bg_horizon');
          $('#user-wrapper')
            .removeClass('wrapper-user-fullscreen')
            .addClass('wrapper-user-horizon');
          $('#user-bgpic').removeClass('user_bg').addClass('user_bg_horizon');
          $('#char-dynpic-wrapper')
            .removeClass('wrapper-char-dynpic-fullscreen')
            .addClass('wrapper-char-dynpic-horizon');
          $('#char-dynpic')
            .removeClass('char_dynmicpic_bg')
            .addClass('char_dynmicpic_bg_horizon');
          $('#comic-msg-holder-char')
            .addClass('comic_msg_holder_char_horizon')
            .css({
              top: '50%',
              left: '80px',
            });
          $('#comic-msg-holder-user')
            .addClass('comic_msg_holder_user_horizon')
            .css({
              top: '50%',
              left: 'calc(40% + 140px)',
            });
        }
      }

      function dispModeSwitch() {
        if ($('#comicMode').is(':checked')) {
          holdbox_origin_height = $('#holder_box').height();
          $('#message_box').css('display', 'none');
          $('#holder_box').css('height', 'auto');
          $('#holder_box').css('--z-index', -1);
          resizeComicLayout();
          gsap.from($('#char-wrapper'), {
            duration: 0.5,
            opacity: 0,
          });
          $('.comic_msg_holder_char').css('display', 'flex');
          if ($('#msg_box_comic_user').html() != '') {
            $('.comic_msg_holder_user').css('display', 'flex');
          }
        } else {
          $('#char-dynpic-wrapper')
            .removeClass('wrapper-char-dynpic')
            .removeClass('wrapper-char-dynpic-horizon')
            .addClass('wrapper-char-dynpic-fullscreen');
          $('#char-bgpic')
            .removeClass('char_bg')
            .removeClass('char_bg_horizon')
            .addClass('char_bg_fullscreen');
          $('#char-wrapper')
            .removeClass('wrapper-char')
            .removeClass('wrapper-char-horizon')
            .addClass('wrapper-char-fullscreen');
          gsap.from($('#char-wrapper'), {
            duration: 0.5,
            opacity: 0,
          });
          $('#user-wrapper')
            .removeClass('wrapper-user')
            .removeClass('wrapper-user-horizon')
            .addClass('wrapper-user-fullscreen');
          $('.comic_msg_holder_char').fadeOut(200);
          $('.comic_msg_holder_user').fadeOut(200);
          $('#holder_box').height(holdbox_origin_height);
          $('#holder_box').css('--z-index', 1);
          $('#message_box').css('display', 'flex');
          let msgNormalScrollHeight = $('#message_box').prop('scrollHeight');
          $('#message_box').scrollTop(msgNormalScrollHeight);
        }
      }

      function exitChat() {
        let querydata = {
          conid: conid,
        };
        ws.send(wsData('exit_room', querydata));
      }

      function exitRoomSuccess(msg) {
        // alert(msg.data["message"]);
        if (window.confirm(msg.data['message'])) {
          window.location.href = '/';
        } else {
        }
      }

      function extractLanguageCode(inputString) {
        const parts = inputString.split('_');
        if (parts.length > 1) {
          return parts[0];
        } else {
          return false;
        }
      }

      function base64ToBlob(base64, mimeType) {
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
          byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: mimeType });
      }

      function xtts_audio_data(msg) {
        const audioData = msg.data['audio_data'];
        let voicePlayerid = msg.data['voice_uid'];
        if (audioData) {
          const audioBlob = base64ToBlob(audioData, 'audio/wav');
          const audioUrl = URL.createObjectURL(audioBlob);
          $('#' + voicePlayerid).attr('src', audioUrl);
          $('#controller' + voicePlayerid).fadeIn(200);
          $('#controller' + voicePlayerid).css('display', 'flex');
          $('#controller' + voicePlayerid).trigger('click');
          $('#voiceController_comic').css('display', 'flex');
          updateScroll();
        } else {
          console.error('Audio data is not available.');
        }
      }

      function genUID(prefix) {
        let uniqueId =
          prefix +
          '-' +
          Date.now() +
          '-' +
          Math.random().toString(36).substr(2, 9);
        return uniqueId;
      }
      function updateScroll() {
        let newScrollHeight = $('#message_box').prop('scrollHeight');
        let newScrollHeightComic = $('#msg_box_comic_char').prop(
          'scrollHeight',
        );
        // let newScrollMsgComic = $(".message-comic").prop("scrollHeight");
        $('#message_box').scrollTop(newScrollHeight);
        $('#msg_box_comic_char').scrollTop(newScrollHeightComic);
        // $(".message-comic").scrollTop(newScrollMsgComic);
      }

      function add_msg({
        message_input = '',
        avatar_url = '',
        voice_text = '',
        speaker = '',
        speak_tone = '',
        ttskey = '',
        dynamic_picture = false,
        server_reply_done = false,
        from = '',
      } = {}) {
        let $message = $(message_input);
        let $preElement = $message.find('pre');
        if ($preElement.length === 0) {
          console.log('No code found');
        } else {
          console.log('find' + $preElement.length + ' code items');
          $preElement.each(function () {
            let $div = $(
              "<div class='codePre'><div class='codePreDiv' onclick='copyCode(this)'><svg xmlns='http://www.w3.org/2000/svg' height='14px' viewBox='0 0 24 24' width='14px' fill='#FFFFFF'><path d='M0 0h24v24H0z' fill='none'/><path d='M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z'/></svg></div></div>",
            );
            $(this).before($div);
          });
        }
        let dynamic_pictures = dynamic_picture;
        let avatar_url_new = avatar_url;
        let $image_str = null;
        if (dynamic_pictures != false) {
          console.log('Find Dynamic pictures');
          let image_str =
            "<div class='dynamicPicBox'><div class='dynaPicControl' onclick='hideDynaPic(this)'><svg width='24px' height='24px' viewBox='0 0 24 24' stroke-width='1.5' fill='none' xmlns='http://www.w3.org/2000/svg' color='#FFFFFF'><path d='M3 13C6.6 5 17.4 5 21 13' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path><path d='M12 17C10.3431 17 9 15.6569 9 14C9 12.3431 10.3431 11 12 11C13.6569 11 15 12.3431 15 14C15 15.6569 13.6569 17 12 17Z' stroke='#FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'></path></svg></div><div class='dynamicPic' onclick='preDynaPic(this)'><img src='" +
            dynamic_pictures +
            "'></div></div>";
          $image_str = $(image_str);
        }
        let $combine = $('<div></div>');
        let $combine_comic = $combine.clone();
        $combine.append($message);
        let $synmsg = $message.clone(true);
        $combine_comic.append($synmsg);
        if ($image_str !== null) {
          $combine.append($image_str);
        }
        let combinedMessage = $combine.html();
        let combinedMessage_comic = $combine_comic.html();
        if (!server_reply_done || initialstate) {
          let $msgNormal = $('#msg_container').clone();
          $msgNormal.removeAttr('id');
          $msgNormal.addClass('msg-container-clone');
          $msgNormal.find('.message').html(combinedMessage);
          $msgNormal
            .find('.avatar')
            .css('background-image', "url('" + avatar_url_new + "')");
          $('#message_box').append($msgNormal);
          updateScroll();
          gsap.from($msgNormal.find('.message'), {
            duration: 0.3,
            scale: 0.9,
            opacity: 0.5,
            ease: 'back.out(4)',
          });
          //comic process
          if (from == 'server') {
            $('#msg_box_comic_char').empty();
            if ($('#voiceController_comic').length > 0) {
              $('#voiceController_comic').css('display', 'none');
            }
            let $msgDivServer = $('#msg_container').clone();
            $msgDivServer.removeAttr('id');
            $msgDivServer.addClass('msg-container-clone');
            $msgDivServer.find('.message').html(combinedMessage_comic);
            $msgDivServer
              .find('.message')
              .removeClass('message')
              .addClass('message-comic');
            $msgDivServer
              .find('.avatar')
              .css('background-image', "url('" + avatar_url_new + "')");
            $('#msg_box_comic_char').append($msgDivServer);
          }
          if (from == 'client') {
            if ($('#comicMode').is(':checked')) {
              $('.comic_msg_holder_user').css('display', 'flex');
            }
            $('#msg_box_comic_user').empty();
            let $msgDivClient = $('#msg_container').clone();
            $msgDivClient.removeAttr('id');
            $msgDivClient.addClass('msg-container-clone');
            $msgDivClient.find('.message').html(combinedMessage_comic);
            $msgDivClient
              .find('.message')
              .removeClass('message')
              .addClass('message-comic');
            $msgDivClient
              .find('.avatar')
              .css('background-image', "url('" + avatar_url_new + "')");
            $('#msg_box_comic_user').append($msgDivClient);
            gsap.from($('.comic_msg_holder_user'), {
              duration: 0.3,
              scale: 0.9,
              opacity: 0.5,
              ease: 'elastic.out(1.2,0.3)',
            });
          }
          initialstate = false;
        } else {
          //update normal mode contents
          let $lastMsg = $('#message_box').find('.msg-container-clone').last();
          $lastMsg
            .find('.avatar')
            .css('backgroundImage', "url('" + avatar_url_new + "')");
          $lastMsg.find('.message').html(combinedMessage);
          gsap.from($lastMsg.find('.message'), {
            duration: 0.3,
            scale: 0.9,
            opacity: 0.5,
            ease: 'back.out(4)',
            // onComplete:updateScroll
          });
          // updateScroll();
          //update comic mode contents
          let $lastMsgComicChar = $('#msg_box_comic_char')
            .find('.msg-container-clone')
            .last();
          $lastMsgComicChar.find('.message-comic').html(combinedMessage_comic);
          $lastMsgComicChar
            .find('.avatar')
            .css('backgroundImage', "url('" + avatar_url_new + "')");
          gsap.from($('.comic_msg_holder_char'), {
            duration: 0.7,
            scale: 0.9,
            opacity: 0.5,
            ease: 'elastic.out(1.2,0.3)',
          });
          if (dynamic_pictures) {
            //update comic char background
            let charDynamicBgImgURL = "url('" + dynamic_pictures + "')";
            $('#char-dynpic').css('background-image', charDynamicBgImgURL);
            $('#char-dynpic-wrapper').css('display', 'flex');
            if ($('#comicMode').is(':checked')) {
              gsap.from($('#char-dynpic-wrapper'), {
                duration: 0.5,
                scale: 0.4,
                opacity: 0.5,
                ease: 'elastic.out(1.3,0.3)',
              });
            }
            divTimer.TimerTrigger('#char-dynpic-wrapper', 200, 30000);
          }
          //update voice data
          let voiceChecked = $('#voiceswitcher').is(':checked');
          if (voiceChecked && voice_text != '') {
            let langcode = extractLanguageCode(speaker);
            let playText = 'Play Voice';
            let pauseText = 'Pause Voice';
            if (langcode) {
              let uid = genUID('voicePlayer');
              let voicePlayer = new Audio();
              voicePlayer.id = uid;
              voicePlayer.controls = true;
              voicePlayer.className = 'voicePlayer';
              let $controls = $('<div></div>');
              $controls.attr('id', 'controller' + uid);
              $controls.addClass('voiceController').text(playText);
              $controls.on('click', function () {
                let $closestMsgContainer = $(this).closest(
                  '.msg-container-clone',
                );
                let isLastMsg = $closestMsgContainer.is(
                  '#message_box > .msg-container-clone:last-child',
                );
                let audioElement = $('#' + uid)[0];
                if (audioElement.paused) {
                  audioElement.play();
                  $(this).text(pauseText);
                  if ($('#voiceController_comic').length > 0 && isLastMsg) {
                    $('#voiceController_comic').text(pauseText);
                  }
                  $('#' + uid).off('ended');
                  $('#' + uid).on('ended', function () {
                    $('#controller' + uid).text(playText);
                    if (isLastMsg) {
                      $('#voiceController_comic').text(playText);
                    }
                  });
                } else {
                  audioElement.pause();
                  $(this).text(playText);
                  if ($('#voiceController_comic').length > 0 && isLastMsg) {
                    $('#voiceController_comic').text(playText);
                  }
                }
              });
              if ($('#voiceController_comic').length == 0) {
                let $controls_comic = $('<div></div>');
                $controls_comic.attr('id', 'voiceController_comic');
                $controls_comic.addClass('voiceController').text(playText);
                $controls_comic.on('click', function () {
                  let audioElement = $('#' + uid)[0];
                  if (audioElement.paused) {
                    audioElement.play();
                    $(this).text(pauseText);
                    $('#controller' + uid).text(pauseText);
                    $('#' + uid).off('ended');
                    $('#' + uid).on('ended', function () {
                      $('#voiceController_comic').text(playText);
                      $('#controller' + uid).text(playText);
                    });
                  } else {
                    audioElement.pause();
                    $(this).text(playText);
                    $('#controller' + uid).text(playText);
                  }
                });
                $('#comic-msg-holder-char').append($controls_comic);
              } else {
                $('#voiceController_comic').off('click');
                $('#voiceController_comic').on('click', function () {
                  let audioElement = $('#' + uid)[0];
                  if (audioElement.paused) {
                    audioElement.play();
                    $(this).text(pauseText);
                    $('#controller' + uid).text(pauseText);
                    $('#' + uid).off('ended');
                    $('#' + uid).on('ended', function () {
                      $('#voiceController_comic').text(playText);
                      $('#controller' + uid).text(playText);
                    });
                  } else {
                    audioElement.pause();
                    $(this).text(playText);
                    $('#controller' + uid).text(playText);
                  }
                });
              }
              voicePlayer.preload = 'metadata';
              $lastMsg.find('.message').append(voicePlayer).append($controls);
              voice_text = '.....\n....' + voice_text;
              let querydata = {
                text: voice_text,
                speaker_wav: speaker,
                language: langcode,
                voice_uid: uid,
              };
              ws.send(wsData('xtts_audio_gen', querydata));
            } else {
              msttser.tts(voice_text, speaker, speak_tone, ttskey);
            }
          } else {
            if ($('#voiceController_comic').length > 0) {
              $('#voiceController_comic').remove();
            }
          }
        }
      }

      function resetChat() {
        toggleInputs(false);
        let statechk = checkSendState();
        var windowSize = getWindowSize();
        userLastMsg = '';
        ai_avatar = '';
        $('#holder_box').fadeOut(200);
        $('#message_box').html('');
        $('#msg_box_comic_char').html('');
        $('#msg_box_comic_user').html('');
        $('.comic_msg_holder_char').fadeOut(90);
        $('.comic_msg_holder_user').fadeOut(100);
        $('#char-dynpic-wrapper').css('display', 'none');
        $('#char-dynpic').css('background-image', '');
        initialstate = true;
        //translateSwitcher.checked = true;
        let querydata = {
          username: username,
          usergender: usergender,
          ai_role_name: ai_role_name,
          conid: conid,
          windowRatio: windowSize.ratio,
          isembbed: statechk.embswitcher,
          istranslated: statechk.transswitcher,
        };
        ws.send(wsData('restart', querydata));
      }

      function checkSendState() {
        let embswitcher;
        let transswitcher;
        let imageswitcher;
        if (typeof embeddingswitcher != 'undefined') {
          if (embeddingswitcher.checked) {
            embswitcher = 'yes';
          } else {
            embswitcher = 'no';
          }
        }
        if (translateSwitcher.checked) {
          transswitcher = true;
        } else {
          transswitcher = false;
        }
        if (dynimageSwitcher.checked) {
          imageswitcher = true;
        } else {
          imageswitcher = false;
        }
        console.log(embswitcher);
        console.log(transswitcher);
        console.log(imageswitcher);
        return { embswitcher, transswitcher, imageswitcher };
      }

      function regenReply() {
        if (userLastMsg != '') {
          toggleInputs(false);
          let statechk = checkSendState();
          console.log(userLastMsg);
          let windowSize = getWindowSize();
          $('#message_box').find('.msg-container-clone').last().remove();
          var querydata = {
            message: userLastMsg,
            conid: conid,
            isembbed: statechk.embswitcher,
            istranslated: statechk.transswitcher,
            windowRatio: windowSize.ratio,
            iscreatedynimage: statechk.imageswitcher,
          };
          ws.send(wsData('regen_msg', querydata));
        }
      }

      function loadChatHistory() {
        var querydata = {
          conid: conid,
        };
        ws.send(wsData('load_chat_history', querydata));
        toggleInputs(false);
      }

      function saveChatHistory() {
        var querydata = {
          conid: conid,
        };
        ws.send(wsData('save_chat_history', querydata));
        toggleInputs(false);
      }

      function changeModel(model_list) {
        if (model_list !== undefined) {
          if (model_list.length > 0) {
            console.log(model_list);
            $('#model_selector').empty();
            $('#model_selector').append(
              $('<option>').text('Models').val('None'),
            );
            $('#model_selector').append(
              $('<option>').text('----------').val('None'),
            );
            $.each(model_list, function (index, value) {
              var option = $('<option>').text(value).val(value);
              $('#model_selector').append(option);
            });
            $('#model_selector').change(function () {
              var modelSelected = $(this).val();
              if (modelSelected !== 'None') {
                var querydata = {
                  model: modelSelected,
                  conid: conid,
                };
                ws.send(wsData('change_model', querydata));
                toggleInputs(false);
              }
            });
          }
        }
      }

      function changeInstr(instruct_list) {
        if (instruct_list !== undefined) {
          if (instruct_list.length > 0) {
            console.log(instruct_list);
            $('#instr_selector').empty();
            $('#instr_selector').append(
              $('<option>').text('Instructions').val('None'),
            );
            $('#instr_selector').append(
              $('<option>').text('----------').val('None'),
            );
            $.each(instruct_list, function (index, value) {
              var option = $('<option>').text(value).val(value);
              $('#instr_selector').append(option);
            });
            $('#instr_selector').change(function () {
              var instrSelected = $(this).val();
              if (instrSelected !== 'None') {
                var querydata = {
                  instruction: instrSelected,
                  conid: conid,
                };
                ws.send(wsData('change_instruction', querydata));
                toggleInputs(false);
              }
            });
          }
        }
      }

      function changeSDModel(SD_model_list) {
        if (SD_model_list !== undefined) {
          if (SD_model_list.length > 0) {
            console.log(SD_model_list);
            $('#sd_selector').empty();
            $('#sd_selector').append(
              $('<option>').text('SD Models').val('None'),
            );
            $('#sd_selector').append(
              $('<option>').text('----------').val('None'),
            );
            $.each(SD_model_list, function (index, value) {
              var option = $('<option>').text(value).val(value);
              $('#sd_selector').append(option);
            });
            $('#sd_selector').change(function () {
              var sdSelected = $(this).val();
              if (sdSelected !== 'None') {
                var querydata = {
                  SD_Model: sdSelected,
                  conid: conid,
                };
                ws.send(wsData('change_SD_Model', querydata));
                toggleInputs(false);
              }
            });
          }
        }
      }

      function model_loaded(msg) {
        var msg = msg.data['message'];
        if (msg == 'Success') {
          toggleInputs(true);
        } else {
          alert('Model Load Failed');
        }
      }
      function instruct_changed(msg) {
        var msg = msg.data['message'];
        if (msg == 'Success') {
          toggleInputs(true);
        } else {
          alert('instruct change Failed');
        }
      }

      function SD_model_changed(msg) {
        var msg = msg.data['message'];
        if (msg == 'Success') {
          toggleInputs(true);
        } else {
          alert('SD Model change Failed');
        }
      }
      function delay(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
      }
      async function processLoadedHistory(loaded_history) {
        for (let msgitem of loaded_history) {
          if (msgitem.role == 'user') {
            var user_inputmsg = marked.parse(msgitem.msg);
            add_msg({
              message_input: user_inputmsg,
              avatar_url: user_looks,
              from: 'client',
            });
          } else if (msgitem.role == 'char') {
            var char_inputmsg = marked.parse(msgitem.msg);
            add_msg({
              message_input: char_inputmsg,
              avatar_url: ai_avatar,
              from: 'server',
            });
          }
          await delay(350);
        }
      }

      function ProcessServerStatus(msgData) {
        let msg = msgData.data['message'];
        if (msg['name'] == 'initialization') {
          if (msg['msg'] !== 'DONE') {
            // console.log(msg["msg"]);
            // $("#overLayer").css("display", "flex");
            $('#overLayer').fadeIn(300);
            $('#overLayer').css('display', 'flex');
            $('#overLayer').find('.overlay-content').css('display', 'flex');
            $('#overLayer')
              .find('.overlay-content')
              .find('.loadingText')
              .html(msg['msg']);
            gsap.from($('#overLayer').find('.overlay-content'), {
              duration: 1,
              scale: 0.7,
              opacity: 0.3,
              ease: 'elastic.out(1.3,0.4)',
            });
          } else {
            $('#overLayer').fadeOut(300);
            $('#overLayer').find('.overlay-content').css('display', 'none');
            $('#overLayer')
              .find('.overlay-content')
              .find('.loadingText')
              .html('');
            $('#holder_box').fadeIn(500);
            $('#holder_box').css('display', 'flex');
            if ($('#comicMode').is(':checked')) {
              $('.comic_msg_holder_char').css('display', 'flex');
            }
          }
        }
        if (msg['name'] == 'chatreply') {
          let Svg =
            "<svg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' fill='#FFFFFF'><circle cx='4' cy='12' r='3'><animate id='spinner_qFRN' begin='0;spinner_OcgL.end+0.25s' attributeName='cy' calcMode='spline' dur='0.6s' values='12;6;12' keySplines='.33,.66,.66,1;.33,0,.66,.33'/></circle><circle cx='12' cy='12' r='3'><animate begin='spinner_qFRN.begin+0.1s' attributeName='cy' calcMode='spline' dur='0.6s' values='12;6;12' keySplines='.33,.66,.66,1;.33,0,.66,.33'/></circle><circle cx='20' cy='12' r='3'><animate id='spinner_OcgL' begin='spinner_qFRN.begin+0.2s' attributeName='cy' calcMode='spline' dur='0.6s' values='12;6;12' keySplines='.33,.66,.66,1;.33,0,.66,.33'/></circle></svg>";
          let imgSvg =
            "<svg width='24' height='24' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg' fill='#FFFFFF'><rect x='1' y='1' width='7.33' height='7.33'><animate id='spinner_oJFS' begin='0;spinner_5T1J.end+0.2s' attributeName='x' dur='0.6s' values='1;4;1'/><animate begin='0;spinner_5T1J.end+0.2s' attributeName='y' dur='0.6s' values='1;4;1'/><animate begin='0;spinner_5T1J.end+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='0;spinner_5T1J.end+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='8.33' y='1' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.1s' attributeName='x' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='y' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='1' y='8.33' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.1s' attributeName='x' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='y' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.1s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='15.66' y='1' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.2s' attributeName='x' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='y' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='8.33' y='8.33' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.2s' attributeName='x' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='y' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='1' y='15.66' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.2s' attributeName='x' dur='0.6s' values='1;4;1'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='y' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.2s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='15.66' y='8.33' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.3s' attributeName='x' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='y' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='8.33' y='15.66' width='7.33' height='7.33'><animate begin='spinner_oJFS.begin+0.3s' attributeName='x' dur='0.6s' values='8.33;11.33;8.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='y' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.3s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect><rect x='15.66' y='15.66' width='7.33' height='7.33'><animate id='spinner_5T1J' begin='spinner_oJFS.begin+0.4s' attributeName='x' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.4s' attributeName='y' dur='0.6s' values='15.66;18.66;15.66'/><animate begin='spinner_oJFS.begin+0.4s' attributeName='width' dur='0.6s' values='7.33;1.33;7.33'/><animate begin='spinner_oJFS.begin+0.4s' attributeName='height' dur='0.6s' values='7.33;1.33;7.33'/></rect></svg>";
          if (msg['msg'] == 'Generate Response') {
            add_msg({
              message_input: Svg,
              avatar_url: ai_avatar,
              from: 'server',
            });
          }
          if (msg['msg'] == 'Generating Scene Image') {
            let $lastmsg = $('#message_box')
              .find('.msg-container-clone')
              .last()
              .find('.message');
            $lastmsg.append(
              "<div class='genImgDiv'>" +
                imgSvg +
                '<span>' +
                msg['msg'] +
                '</span></div>',
            );
            let $lastmsg_comic = $('#msg_box_comic_char')
              .find('.msg-container-clone')
              .last()
              .find('.message-comic');
            $lastmsg_comic.append(
              "<div class='genImgDiv'>" +
                imgSvg +
                '<span>' +
                msg['msg'] +
                '</span></div>',
            );
            updateScroll();
          }
          if (msg['msg']['event'] == 'streaming') {
            let msgText = msg['msg']['text'];
            let $lastmsg = $('#message_box')
              .find('.msg-container-clone')
              .last()
              .find('.message');
            let $lastmsg_comic = $('#msg_box_comic_char')
              .find('.msg-container-clone')
              .last()
              .find('.message-comic');
            if (msgText != '[DONE]') {
              streamingBuffer.push(msgText);
              let streamText = streamingBuffer.join('');
              $lastmsg.html("<p class='stream_text'>" + streamText + '</p>');
              $lastmsg.find('p').append("<span class='stream_hint'></span>");
              $lastmsg_comic.html(
                "<p class='stream_text'>" + streamText + '</p>',
              );
              $lastmsg_comic
                .find('p')
                .append("<span class='stream_hint'></span>");
            } else {
              $lastmsg.find('p').find('.stream_hint').fadeOut(1500);
              $lastmsg_comic.find('p').find('.stream_hint').fadeOut(1500);
              streamingBuffer = [];
            }
            updateScroll();
            // console.log(msgText);
          }
        }
        if (msg['name'] == 'chat_history_op') {
          if (msg['msg']['operation'] == 'save') {
            if (msg['msg']['result'] == 'Success') {
              toggleInputs(true);
              alert('Saved history successfully');
            } else {
              toggleInputs(true);
              alert('Saving history failed, have you start chat?');
            }
          }
          if (msg['msg']['operation'] == 'load') {
            if (msg['msg']['result'] == 'Fail') {
              toggleInputs(true);
              alert('loading history failed, Empty?');
            } else {
              $('#message_box')
                .find('.msg-container-clone:not(:first)')
                .remove();
              let loaded_history = msg['msg']['result'];
              processLoadedHistory(loaded_history).then(() => {
                toggleInputs(true);
              });
            }
          }
        }
      }

      function msg_proc(msg) {
        let message = msg.data['message'];
        ai_avatar = msg.data['avatar'];
        if (msg.data['user_looks'] != undefined) {
          user_looks = msg.data['user_looks'];
        }
        if (msg.data['bgImg'] != undefined) {
          let bgImg = msg.data['bgImg'];
          let charBgImgURL = "url('" + bgImg + "')";
          $('#char-bgpic').css('background-image', charBgImgURL);
        }
        if (msg.data['user_bkImg'] != undefined) {
          let user_bkImg = msg.data['user_bkImg'];
          let userBgImgURL = "url('" + user_bkImg + "')";
          $('#user-bgpic').css('background-image', userBgImgURL);
        }
        if (msg.data['iscreatedynimage'] != undefined) {
          if (msg.data['iscreatedynimage'] == true) {
            $('#dynimageSwitcher').prop('checked', true);
          } else {
            $('#dynimageSwitcher').css('display', 'none');
            $('#dynimageSwitcher').prop('checked', false);
            $('#dynimageSwitcher').next('span').css('display', 'none');
          }
        }
        let voice_text = msg.data['voice_text'];
        let speaker = msg.data['speaker'];
        let speak_tone = msg.data['speak_tone'];
        let ttskey = msg.data['ttskey'];
        let dynamic_picture = msg.data['dynamic_picture'];
        let model_list = msg.data['model_list'];
        changeModel(model_list);
        let instruct_list = msg.data['instruct_list'];
        changeInstr(instruct_list);
        let SD_model_list = msg.data['SD_model_list'];
        changeSDModel(SD_model_list);
        toggleInputs(true);
        add_msg({
          message_input: message,
          avatar_url: ai_avatar,
          voice_text: voice_text,
          speaker: speaker,
          speak_tone: speak_tone,
          ttskey: ttskey,
          dynamic_picture: dynamic_picture,
          server_reply_done: true,
          from: 'server',
        });
      }
      /*send msg to server*/
      function sendmsgtoserver(msg_to_send, command_flag, prompt_flag) {
        toggleInputs(false);
        let statechk = checkSendState();
        let windowSize = getWindowSize();
        let usermsg;
        let user_appearMsg;
        if (command_flag !== 'cmd_normal') {
          usermsg = prompt_flag.replace(prompt_variable_str, msg_to_send);
          user_appearMsg = `<div class="icon_with_msg"><div class="icon_svg">${icons[command_flag]}</div><div class="word_p">${marked.parse(msg_to_send)}</div></div>`;
        } else {
          usermsg = msg_to_send;
          user_appearMsg = marked.parse(msg_to_send)
        }
        userLastMsg = usermsg;
        add_msg({
          message_input: user_appearMsg,
          avatar_url: user_looks,
          from: 'client',
        });
        let querydata = {
          message: usermsg,
          command_flag: command_flag,
          conid: conid,
          isembbed: statechk.embswitcher,
          istranslated: statechk.transswitcher,
          windowRatio: windowSize.ratio,
          iscreatedynimage: statechk.imageswitcher,
        };
        ws.send(wsData('send_user_msg', querydata));
        $('#messageToSend').val('');
        autoExpand($('#messageToSend')[0]);
      }

      function autoExpand(textarea) {
        setTimeout(function () {
          textarea.style.height = 'auto';
          textarea.style.height = textarea.scrollHeight + 'px';
        }, 0);
      }
      //Server Connected
      function Server_Connected() {
        if (initialstate) {
          let statechk = checkSendState();
          $('#message_box').empty();
          $('.comic_msgbox').empty();
          $('#comicMode').prop('checked', false).trigger('change');
          $('#holder_box').css('display', 'none');
          let windowSize = getWindowSize();
          let querydata = {
            username: username,
            user_sys_name: user_sys_name,
            usergender: usergender,
            user_facelooks: user_facelooks,
            ai_role_name: ai_role_name,
            conid: clientID,
            ai_is_uncensored: ai_is_uncensored,
            istranslated: statechk.transswitcher,
            windowRatio: windowSize.ratio,
          };
          ws.send(wsData('initialize_room', querydata));
        } else {
          /* reconnect to server */
          let querydata = {
            conid: clientID,
          };
          ws.send(wsData('reconnect_room', querydata));
        }
      }

      function debounce(func, wait) {
        let timeout;
        return function executedFunction() {
          const context = this;
          const args = arguments;
          const later = function () {
            timeout = null;
            func.apply(context, args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      function switchVoiceController() {
        let vs_check = $('#voiceswitcher').is(':checked');
        if (vs_check && $('.voicePlayer').length > 0) {
          $('.voiceController').css('display', 'flex');
        } else {
          $('.voiceController').css('display', 'none');
        }
      }
      /*Document Ready Actions*/
      $(document).ready(function () {
        //new command function
        icons = {
          default: `<svg width="30px" height="30px" viewBox="0 0 24 24" data-name="025_SCIENCE"
                id="_025_SCIENCE" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <style>
                        .cls-1 {
                            fill: #ffffff;
                        }
                    </style>
                </defs>
                <path class="cls-1"
                    d="M16,13H8a3,3,0,0,1-3-3V6A3,3,0,0,1,8,3h8a3,3,0,0,1,3,3v4A3,3,0,0,1,16,13ZM8,5A1,1,0,0,0,7,6v4a1,1,0,0,0,1,1h8a1,1,0,0,0,1-1V6a1,1,0,0,0-1-1Z" />
                <path class="cls-1"
                    d="M10,9a1.05,1.05,0,0,1-.71-.29A1,1,0,0,1,10.19,7a.6.6,0,0,1,.19.06.56.56,0,0,1,.17.09l.16.12A1,1,0,0,1,10,9Z" />
                <path class="cls-1"
                    d="M14,9a1,1,0,0,1-.71-1.71,1,1,0,0,1,1.42,1.42,1,1,0,0,1-.16.12.56.56,0,0,1-.17.09.6.6,0,0,1-.19.06Z" />
                <path class="cls-1" d="M12,4a1,1,0,0,1-1-1V2a1,1,0,0,1,2,0V3A1,1,0,0,1,12,4Z" />
                <path class="cls-1" d="M9,22a1,1,0,0,1-1-1V18a1,1,0,0,1,2,0v3A1,1,0,0,1,9,22Z" />
                <path class="cls-1" d="M15,22a1,1,0,0,1-1-1V18a1,1,0,0,1,2,0v3A1,1,0,0,1,15,22Z" />
                <path class="cls-1"
                    d="M15,19H9a1,1,0,0,1-1-1V12a1,1,0,0,1,1-1h6a1,1,0,0,1,1,1v6A1,1,0,0,1,15,19Zm-5-2h4V13H10Z" />
                <path class="cls-1"
                    d="M5,17a1,1,0,0,1-.89-.55,1,1,0,0,1,.44-1.34l4-2a1,1,0,1,1,.9,1.78l-4,2A.93.93,0,0,1,5,17Z" />
                <path class="cls-1"
                    d="M19,17a.93.93,0,0,1-.45-.11l-4-2a1,1,0,1,1,.9-1.78l4,2a1,1,0,0,1,.44,1.34A1,1,0,0,1,19,17Z" />
            </svg>`,
          cmd_request: `<svg fill="#ffffff" width="30px" height="30px" viewBox="0 0 16 16" id="request-16px" xmlns="http://www.w3.org/2000/svg">
          <path id="Path_49" data-name="Path 49" d="M30.5,16a.489.489,0,0,1-.191-.038A.5.5,0,0,1,30,15.5V13h-.5A2.5,2.5,0,0,1,27,10.5v-8A2.5,2.5,0,0,1,29.5,0h11A2.5,2.5,0,0,1,43,2.5v8A2.5,2.5,0,0,1,40.5,13H33.707l-2.853,2.854A.5.5,0,0,1,30.5,16Zm-1-15A1.5,1.5,0,0,0,28,2.5v8A1.5,1.5,0,0,0,29.5,12h1a.5.5,0,0,1,.5.5v1.793l2.146-2.147A.5.5,0,0,1,33.5,12h7A1.5,1.5,0,0,0,42,10.5v-8A1.5,1.5,0,0,0,40.5,1ZM36,9a1,1,0,1,0-1,1A1,1,0,0,0,36,9Zm1-4a2,2,0,0,0-4,0,.5.5,0,0,0,1,0,1,1,0,1,1,1,1,.5.5,0,0,0,0,1A2,2,0,0,0,37,5Z" transform="translate(-27)"/>
            </svg>`,
          cmd_pushplot: `<svg fill="#ffffff" width="30px" height="30px" viewBox="0 0 16 16" id="request-sent-16px" xmlns="http://www.w3.org/2000/svg">
          <path id="Path_50" data-name="Path 50" d="M-11.5,0h-11A2.5,2.5,0,0,0-25,2.5v8A2.5,2.5,0,0,0-22.5,13h.5v2.5a.5.5,0,0,0,.309.462A.489.489,0,0,0-21.5,16a.5.5,0,0,0,.354-.146L-18.293,13H-11.5A2.5,2.5,0,0,0-9,10.5v-8A2.5,2.5,0,0,0-11.5,0ZM-10,10.5A1.5,1.5,0,0,1-11.5,12h-7a.5.5,0,0,0-.354.146L-21,14.293V12.5a.5.5,0,0,0-.5-.5h-1A1.5,1.5,0,0,1-24,10.5v-8A1.5,1.5,0,0,1-22.5,1h11A1.5,1.5,0,0,1-10,2.5Zm-2.038-3.809a.518.518,0,0,1-.109.163l-2,2A.5.5,0,0,1-14.5,9a.5.5,0,0,1-.354-.146.5.5,0,0,1,0-.708L-13.707,7H-18.5A1.5,1.5,0,0,0-20,8.5a.5.5,0,0,1-.5.5.5.5,0,0,1-.5-.5A2.5,2.5,0,0,1-18.5,6h4.793l-1.147-1.146a.5.5,0,0,1,0-.708.5.5,0,0,1,.708,0l2,2a.518.518,0,0,1,.109.163A.505.505,0,0,1-12.038,6.691Z" transform="translate(25)"/>
            </svg>`,
          cmd_occasion: `<svg fill="#ffffff" width="30px" height="30px" viewBox="0 0 16 16" id="request-added-16px" xmlns="http://www.w3.org/2000/svg">
          <path id="Path_48" data-name="Path 48" d="M-6.5,0h-11A2.5,2.5,0,0,0-20,2.5v8A2.5,2.5,0,0,0-17.5,13h.5v2.5a.5.5,0,0,0,.309.462A.489.489,0,0,0-16.5,16a.5.5,0,0,0,.354-.146L-13.293,13H-6.5A2.5,2.5,0,0,0-4,10.5v-8A2.5,2.5,0,0,0-6.5,0ZM-5,10.5A1.5,1.5,0,0,1-6.5,12h-7a.5.5,0,0,0-.354.146L-16,14.293V12.5a.5.5,0,0,0-.5-.5h-1A1.5,1.5,0,0,1-19,10.5v-8A1.5,1.5,0,0,1-17.5,1h11A1.5,1.5,0,0,1-5,2.5Zm-3.5-4A.5.5,0,0,1-9,7h-2.5V9.5a.5.5,0,0,1-.5.5.5.5,0,0,1-.5-.5V7H-15a.5.5,0,0,1-.5-.5A.5.5,0,0,1-15,6h2.5V3.5A.5.5,0,0,1-12,3a.5.5,0,0,1,.5.5V6H-9A.5.5,0,0,1-8.5,6.5Z" transform="translate(20)"/>
            </svg>`,
        };
        const suggestions = [
          {
            name: 'Request to A.I',
            descript: 'Make a request to A.I assistant:[contents]',
            cmd: 'cmd_request',
            prompt:
              '*Command to A.I assistant: [contents], exectue the command immedately*',
            svg: icons.cmd_request,
          },
          {
            name: 'Push the plot forward',
            descript:
              'Push the plot forward to create a new chapter - [contents]',
            cmd: 'cmd_pushplot',
            prompt:
              '*Command to A.I assistant: Push the plot forward to create a new chapter: [contents], exectue the command immedately*',
            svg: icons.cmd_pushplot,
          },
          {
            name: 'Create a special occasion',
            descript:
              'Push the plot forward to create a special occasion of [contents]',
            cmd: 'cmd_occasion',
            prompt:
              '*Command to A.I assistant: Push the plot forward and create a special occasion, the description of the occasion is: [contents], exectue the command immedately*',
            svg: icons.cmd_occasion,
          },
        ];
        const defaultText =
          "Enter your words, or use '/' to give special command";
        const $msg_inputer = $('#messageToSend');
        const $cmd_dropdownMenu = $('#cmd_dropdownMenu');
        const $ai_icon = $('.ai_icon');
        prompt_variable_str = '[contents]';
        const cssClasses = {
          cmdItems: 'cmd_items',
          inputText: 'input_text',
          highlight: 'highlight',
          itemName: 'item_name',
          sugDesc: 'sug_desc',
        };
        const commandInputHandler = new CommandInputHandler(
          icons,
          suggestions,
          defaultText,
          $msg_inputer,
          $cmd_dropdownMenu,
          $ai_icon,
          prompt_variable_str,
          cssClasses,
        );
        $msg_inputer.on('SendMsg', function (event) {
          console.log(
            `command type:${event.command_flag}\nthe message is:${event.msg}\nthe prompt is:${event.prompt_flag}`,
          );
          sendmsgtoserver(event.msg, event.command_flag, event.prompt_flag);
        });
        //
        $('#submit').on('click', function () {
          commandInputHandler.triggerEnterEvent();
        });
        $('#load-chat-history').click(loadChatHistory);
        $('#save-chat-history').click(saveChatHistory);
        $('#restart').click(resetChat);
        $('#regenerate').click(regenReply);
        $('#exitchat').click(exitChat);
        $('#comicMode').change(dispModeSwitch);
        $('#ai_intro .prologue_button').on('click', function () {
          $('#intro_prologue_area .intro_prologue').fadeToggle(500);
        });
        $('#intro_prologue_area .intro_prologue').on('click', function () {
          $(this).fadeOut(100);
        });
        $('#intro_prologue_area .intro_prologue').html(Prologue);
        $('#voiceswitcher').change(switchVoiceController);
        toggleInputs(false);
        // Auto resize comic layout
        $('.comic_msg_holder_char').draggable({
          handle: '.msg-drag-handle',
        });
        $('.comic_msg_holder_user').draggable({
          handle: '.msg-drag-handle',
        });
        var handleResize = debounce(function () {
          if ($('#comicMode').is(':checked')) {
            var width = $(window).width();
            var height = $(window).height();
            if (width > height) {
              $('#char-wrapper')
                .removeClass('wrapper-char')
                .addClass('wrapper-char-horizon');
              $('#char-bgpic')
                .removeClass('char_bg')
                .addClass('char_bg_horizon');
              $('#user-wrapper')
                .removeClass('wrapper-user')
                .addClass('wrapper-user-horizon');
              $('#user-bgpic')
                .removeClass('user_bg')
                .addClass('user_bg_horizon');
              $('#char-dynpic-wrapper')
                .removeClass('wrapper-char-dynpic')
                .addClass('wrapper-char-dynpic-horizon');
              $('#char-dynpic')
                .removeClass('char_dynmicpic_bg')
                .addClass('char_dynmicpic_bg_horizon');
              $('#comic-msg-holder-char')
                .addClass('comic_msg_holder_char_horizon')
                .css({
                  top: '50%',
                  left: '80px',
                });
              $('#comic-msg-holder-user')
                .addClass('comic_msg_holder_user_horizon')
                .css({
                  top: '50%',
                  left: 'calc(40% + 140px)',
                });
            } else {
              $('#char-wrapper')
                .removeClass('wrapper-char-horizon')
                .addClass('wrapper-char');
              $('#char-bgpic')
                .removeClass('char_bg_horizon')
                .addClass('char_bg');
              $('#user-wrapper')
                .removeClass('wrapper-user-horizon')
                .addClass('wrapper-user');
              $('#user-bgpic')
                .removeClass('user_bg_horizon')
                .addClass('user_bg');
              $('#char-dynpic-wrapper')
                .removeClass('wrapper-char-dynpic-horizon')
                .addClass('wrapper-char-dynpic');
              $('#char-dynpic')
                .removeClass('char_dynmicpic_bg_horizon')
                .addClass('char_dynmicpic_bg');
              $('#comic-msg-holder-char')
                .removeClass('comic_msg_holder_char_horizon')
                .css({
                  top: '40%',
                  left: '80px',
                });
              $('#comic-msg-holder-user')
                .removeClass('comic_msg_holder_user_horizon')
                .css({
                  top: 'calc(40% + 300px)',
                  left: '30%',
                });
            }
          }
        }, 250);
        $(window).on('resize', handleResize);
        //
        $('#char-dynpic-wrapper')
          .css('cursor', 'pointer')
          .on('click', function () {
            $(this).fadeOut(200);
            let backdynpic = $(this)
              .find('#char-dynpic')
              .css('background-image');
            previewPic(backdynpic);
          });
        $('.chatSetUpBtn').on('click', function () {
          if ($('.settingOpt').css('display') == 'none') {
            $('#overLayer').css('display', 'flex');
            $('#setTings').css('z-index', 1000);
            $('.settingOpt').css('opacity', 0).css('display', 'flex');
            gsap.to($('.settingOpt'), {
              duration: 0.4,
              opacity: 1,
              onComplete: function () {
                $('#overLayer').on('click', function () {
                  $('.settingOpt').css('display', 'none');
                  $(this).css('display', 'none');
                  $(this).off('click');
                  $('#setTings').css('z-index', 15);
                });
              },
            });
          } else {
            gsap.to($('.settingOpt'), {
              duration: 0.2,
              opacity: 0,
              onComplete: function () {
                $('.settingOpt').css('display', 'none');
                $('#overLayer').css('display', 'none');
                $('#overLayer').off('click');
                $('#setTings').css('z-index', 15);
              },
            });
          }
        });
        //Resize holder_box function
        var startY, startHeight, containerHeight;
        $('#drag-handle').on('mousedown', function (e) {
          startY = e.pageY;
          startHeight = $('#holder_box').height();
          containerHeight = $('.flexPage').height(); // 获取容器的高度
          $(document).on('mousemove', mouseMove).on('mouseup', mouseUp);
          e.preventDefault();
        });

        function mouseMove(e) {
          var newHeight = startHeight + (startY - e.pageY);
          var minHeight = containerHeight * 0.3;
          var maxHeight = containerHeight * 0.9;
          newHeight = Math.max(newHeight, minHeight);
          newHeight = Math.min(newHeight, maxHeight);
          $('#holder_box').css('height', newHeight + 'px');
        }

        function mouseUp() {
          $(document).off('mousemove', mouseMove).off('mouseup', mouseUp);
        }
        let backgroundImage = "url('" + bkimg_path + "')";
        $('#char-bgpic').css('background-image', backgroundImage);
        //WebSocket Process
        let websocket;
        let retryCount = 0;
        const maxRetryLimit = 10;
        let retryDelay = 1000;
        const maxRetryDelay = 60000;

        function connectWebSocket() {
          ws = new WebSocket(`ws://${window.location.host}/ws/${clientID}`);
          ws.onopen = (e) => {
            retryCount = 0;
            retryDelay = 1000;
            console.log('Connected to Websocket...');
            let querydata = {
              from: clientID,
              msg: {
                message: 'CyberChat Index Page Connected',
                status: 200,
              },
            };
            ws.send(wsData('connect to server', querydata));
          };
          //process server feedback
          ws.onmessage = (e) => {
            let serverData = JSON.parse(e.data);
            if (serverData.wsevent_server == 'after_connect') {
              console.log('after_connect');
              Server_Connected();
            }
            if (serverData.wsevent_server == 'status_from_server') {
              console.log(serverData.data.message);
              ProcessServerStatus(serverData);
            }
            if (serverData.wsevent_server == 'Message_data_from_server') {
              msg_proc(serverData);
            }
            if (serverData.wsevent_server == 'exit_room_success') {
              exitRoomSuccess(serverData);
            }
            if (serverData.wsevent_server == 'model_change_result') {
              model_loaded(serverData);
            }
            if (serverData.wsevent_server == 'instruction_change_result') {
              instruct_changed(serverData);
            }
            if (serverData.wsevent_server == 'SD_Model_change_result') {
              SD_model_changed(serverData);
            }
            if (serverData.wsevent_server == 'xtts_result') {
              xtts_audio_data(serverData);
            }
          };
          ws.onerror = (e) => {
            console.log('Websocket error observed: ' + e);
          };
          ws.onclose = (e) => {
            console.log('Connect closed');
            let closeReason =
              e.code === 1006 ? ', Server Shutdown ?' : ', Reason: ' + e.reason;
            console.log('Code: ' + e.code + closeReason);
            if (retryCount < maxRetryLimit) {
              setTimeout(reconnect, retryDelay);
              retryDelay = Math.min(maxRetryDelay, retryDelay * 2); // 延迟翻倍，但不超过最大延迟
            }
          };
        }

        function reconnect() {
          retryCount++;
          console.log(`Attempting to reconnect... (Attempt: ${retryCount})`);
          connectWebSocket();
        }
        connectWebSocket();
      });

    </script>
  </head>
  <body>
    <div class="flexPage">
      <div class="comic-area">
        <div id="char-wrapper" class="border-wrapper wrapper-char-fullscreen">
          <div id="char-bgpic" class="char_bg_fullscreen"></div>
        </div>
        <div id="user-wrapper" class="border-wrapper wrapper-user-fullscreen">
          <div id="user-bgpic" class="user_bg"></div>
        </div>
        <div
          id="char-dynpic-wrapper"
          class="border-wrapper wrapper-char-dynpic-fullscreen"
        >
          <div id="char-dynpic" class="char_dynmicpic_bg"></div>
        </div>
        <div class="comic_msg_holder_char" id="comic-msg-holder-char">
          <div class="comic_msgbox_arrow_char"></div>
          <div id="msg_box_comic_char" class="comic_msgbox"></div>
          <div id="voiceController_comic" class="voiceController">
            Play Voice
          </div>
          <div class="msg-drag-handle">
            <svg
              width="18px"
              height="18px"
              viewBox="0 0 64 64"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="#ffffff"
              stroke-width="3.5"
            >
              <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
              <g
                id="SVGRepo_tracerCarrier"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></g>
              <g id="SVGRepo_iconCarrier">
                <line x1="32" y1="8" x2="32" y2="56"></line>
                <line x1="56" y1="32" x2="8" y2="32"></line>
                <polyline points="40 16 32 8 24 16"></polyline>
                <polyline points="24 48 32 56 40 48"></polyline>
                <polyline points="48 40 56 32 48 24"></polyline>
                <polyline points="16 24 8 32 16 40"></polyline>
              </g>
            </svg>
          </div>
        </div>
        <div class="comic_msg_holder_user" id="comic-msg-holder-user">
          <div class="comic_msgbox_arrow_user"></div>
          <div id="msg_box_comic_user" class="comic_msgbox"></div>
          <div class="msg-drag-handle">
            <svg
              width="18px"
              height="18px"
              viewBox="0 0 64 64"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              stroke="#ffffff"
              stroke-width="3.5"
            >
              <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
              <g
                id="SVGRepo_tracerCarrier"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></g>
              <g id="SVGRepo_iconCarrier">
                <line x1="32" y1="8" x2="32" y2="56"></line>
                <line x1="56" y1="32" x2="8" y2="32"></line>
                <polyline points="40 16 32 8 24 16"></polyline>
                <polyline points="24 48 32 56 40 48"></polyline>
                <polyline points="48 40 56 32 48 24"></polyline>
                <polyline points="16 24 8 32 16 40"></polyline>
              </g>
            </svg>
          </div>
        </div>
      </div>
      <div id="setTings" class="chatSetting">
        <div class="chatSetUpBtn">
          <svg
            width="24px"
            height="24px"
            stroke-width="1.5"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
            color="#ffffff"
          >
            <path
              d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"
              stroke="#ffffff"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            ></path>
            <path
              d="M19.6224 10.3954L18.5247 7.7448L20 6L18 4L16.2647 5.48295L13.5578 4.36974L12.9353 2H10.981L10.3491 4.40113L7.70441 5.51596L6 4L4 6L5.45337 7.78885L4.3725 10.4463L2 11V13L4.40111 13.6555L5.51575 16.2997L4 18L6 20L7.79116 18.5403L10.397 19.6123L11 22H13L13.6045 19.6132L16.2551 18.5155C16.6969 18.8313 18 20 18 20L20 18L18.5159 16.2494L19.6139 13.598L21.9999 12.9772L22 11L19.6224 10.3954Z"
              stroke="#ffffff"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            ></path>
          </svg>
        </div>
        <div id="settingOption" class="settingOpt">
          <div>
            <input type="checkbox" id="comicMode" />
            <span class="smallFonts">Comic Mode</span>
          </div>
          <div>
            <input type="checkbox" id="translateSwitcher" />
            <span class="smallFonts">EN/CN</span>
          </div>
          <select id="model_selector" class="topSelect" name="chatParam">
            <option value="No Select">Models Selector</option>
          </select>
          <select id="instr_selector" class="topSelect" name="instrParam">
            <option value="No Select">instru Selector</option>
          </select>
          <select id="sd_selector" class="topSelect" name="instrParam">
            <option value="No Select">SD Selector</option>
          </select>
        </div>
      </div>
      <div id="ai_intro">
        <div class="ai_name">{{ainame}}</div>
        <div class="prologue_button">
          <svg
            width="30px"
            height="30px"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M4 19V6.2C4 5.0799 4 4.51984 4.21799 4.09202C4.40973 3.71569 4.71569 3.40973 5.09202 3.21799C5.51984 3 6.0799 3 7.2 3H16.8C17.9201 3 18.4802 3 18.908 3.21799C19.2843 3.40973 19.5903 3.71569 19.782 4.09202C20 4.51984 20 5.0799 20 6.2V17H6C4.89543 17 4 17.8954 4 19ZM4 19C4 20.1046 4.89543 21 6 21H20M9 7H15M9 11H15M19 17V21"
              stroke="#ffffff"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </div>
      </div>
      <div id="intro_prologue_area">
        <div class="intro_prologue">Prologue Texts</div>
      </div>
      <div class="free-space"></div>
      <div id="holder_box">
        <div id="drag-handle"></div>
        <div id="message_box"></div>
        <div id="inputArea">
          <div id="chat-history-buttons">
            <button id="load-chat-history">Load chat history</button>
            <button id="save-chat-history">Save chat history</button>
          </div>
          <div class="messageInputBox">  
            <div class="input_area">
              <div class="ai_icon"></div>
              <textarea type="text" id="messageToSend" rows="1"></textarea>
              <ul id="cmd_dropdownMenu"></ul>
            </div>
            <div id="submit" class="msgInput">Send</div>
          </div>
          <div class="messageOptions">
            <div class="subButtonsGroup">
              <button id="regenerate">Regen</button>
              <button id="restart">Restart</button>
              <button id="exitchat">Exit</button>
            </div>
            <div class="sub_options">
              <div>
                <input id="voiceswitcher" type="checkbox" />
                <span class="smallFonts">Voice Output</span>
              </div>
              <div>
                <input id="dynimageSwitcher" type="checkbox" />
                <span class="smallFonts">Dynamic Image</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="templates_box" style="display: none">
        <div id="msg_container">
          <div class="avatar"></div>
          <div class="message"></div>
        </div>
      </div>
      <div class="overlay" id="overLayer">
        <div class="overlay-content">
          <div class="loadingSvg">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
              fill="#FFFFFF"
            >
              <path
                d="M10.14,1.16a11,11,0,0,0-9,8.92A1.59,1.59,0,0,0,2.46,12,1.52,1.52,0,0,0,4.11,10.7a8,8,0,0,1,6.66-6.61A1.42,1.42,0,0,0,12,2.69h0A1.57,1.57,0,0,0,10.14,1.16Z"
              >
                <animateTransform
                  attributeName="transform"
                  type="rotate"
                  dur="0.75s"
                  values="0 12 12;360 12 12"
                  repeatCount="indefinite"
                />
              </path>
            </svg>
          </div>
          <div class="loadingText"></div>
        </div>
        <div class="overlay-dynpic">
          <div id="closePreview">Close Preview</div>
        </div>
      </div>
    </div>
  </body>
</html>
